<!DOCTYPE html>

<html lang="en" dir=rtl>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="description" content="KSMoving">
    <meta name="author" content="Coderthemes">

    <link rel="shortcut icon" href="assets/images/favicon_1.ico">

    <title>הסעת חולה</title>

    <!--<link href="../plugins/switchery/swiFtchery.min.css" rel="stylesheet" />-->
    <link href="assets/css/bootstrap-rtl.min.css" rel="stylesheet" type="text/css">
    <link href="assets/css/core.css" rel="stylesheet" type="text/css">
    <link href="assets/css/icons.css" rel="stylesheet" type="text/css">
    <link href="assets/css/components.css" rel="stylesheet" type="text/css">
    <link href="assets/css/pages.css" rel="stylesheet" type="text/css">
    <link href="assets/css/menu.css" rel="stylesheet" type="text/css">
    <link href="assets/css/responsive.css" rel="stylesheet" type="text/css">

    <script src="assets/js/CookiesFunctions.js"></script>

    <script src="assets/js/modernizr.min.js"></script>

    <script src="assets/js/jquery.min.js"></script>

    <!-- The jQuery library is a prerequisite for all jqSuite products -->
    <script type="text/ecmascript" src="assets/js/jquery.min.js"></script>
    <!-- This is the Javascript file of jqGrid -->
    <script type="text/ecmascript" src="Guriddo_jqGrid_JS_5.2.0/js/jquery.jqGrid.min.js"></script>
    <!-- We support more than 40 localizations -->
    <script type="text/ecmascript" src="Guriddo_jqGrid_JS_5.2.0/js/i18n/grid.locale-he.js"></script>
    <!-- A link to a Boostrap  and jqGrid Bootstrap CSS siles-->
    <link href="Guriddo_jqGrid_JS_5.2.0/css/ui.jqgrid-bootstrap.css" rel="stylesheet" />

    <!-- Sweet Alert css -->
    <link href="../plugins/bootstrap-sweetalert/sweet-alert.css" rel="stylesheet" type="text/css" />

    <!--GENERAL object and additional functions-->
    <script src="lib/lz-string.js"></script>
    <script src="lib/master.js"></script>

    <!-- Select2 css+js -->
    <link href="assets/css/select2.css" rel="stylesheet" />
    <script src="assets/js/select2.min.js"></script>

    <!--DatePicker css+js-->
    <!--<link href="../plugins/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">
    <link href="../plugins/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <script src="../plugins/moment/moment.js"></script>
    <script src="../plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="../plugins/bootstrap-daterangepicker/daterangepicker.js"></script>-->
    <!--timePicker css+js-->
    <!--<link href="../plugins/timepicker/bootstrap-timepicker.min.css" rel="stylesheet" />
    <script src="../plugins/timepicker/bootstrap-timepicker.min.js"></script>-->
    <!--Patient Autocomplete-->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <!-- <link rel="stylesheet" href="/resources/demos/style.css">-->
    <style>
        .sameWidthBtn {
            width: 170px;
            margin: 0;
        }

        /*override bootstrap*/
        .page-title-box {
            background: #ffffff00; /*tranparent*/
            box-shadow: none;
        }

        .ui-autocomplete {
            max-height: 100px;
            overflow-y: auto;
            /* prevent horizontal scrollbar */
            overflow-x: hidden;
        }
        /* IE 6 doesn't support max-height
        * we use height instead, but this forces the menu to always be this tall
        */
        * html .ui-autocomplete {
            height: 100px;
        }

        input[type=text]:focus {
            background-color: #FFE684;
        }

        .duplicateDisplay {
            display: none;
        }

        .duplicateDisplayOnShow {
            background-color: #F8F8B5
        }

        input[type=text], input[type=checkbox], input[type=date], #statusRidePat, #Origin, #Destination, #hour, #minute {
            border-color: #000
        }

        .saveHighlight {
            border: 10px solid yellow !important;
            color: yellow !important;
            transform: scaleY(1.25) scaleX(1.25);
        }

        .centerHeader {
            text-align: center;
        }
    </style>
    <!--<script src="https://code.jquery.com/jquery-1.12.4.js"></script>-->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>
        var resizefunc = [];
    </script>

    <!--Validators-->
    <script src="../plugins/jquery-validation/dist/jquery.validate.min.js"></script>


    <!-- jQuery  -->
    <script src="assets/js/bootstrap-rtl.min.js"></script>
    <script src="assets/js/detect.js"></script>
    <script src="assets/js/fastclick.js"></script>
    <script src="assets/js/jquery.slimscroll.js"></script>
    <script src="assets/js/jquery.blockUI.js"></script>
    <script src="assets/js/waves.js"></script>
    <script src="assets/js/wow.min.js"></script>
    <script src="assets/js/jquery.nicescroll.js"></script>
    <script src="assets/js/jquery.scrollTo.min.js"></script>
    <script src="../plugins/switchery/switchery.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>

    <!-- Sweet Alert js -->
    <script src="../plugins/bootstrap-sweetalert/sweet-alert.min.js"></script>
    <script src="assets/pages/jquery.sweet-alert.init.js"></script>

    <script src="assets/js/jquery.core.js"></script>
    <script src="assets/js/jquery.app.js"></script>
    <!--<script src="lib/datepicker-he.js"></script>-->
    <script src="lib/includeHTML.js"></script>
    <script>
        checkCookie();
        arr_addressRows = [];
        $.jgrid.defaults.responsive = true;
        $.jgrid.defaults.styleUI = 'Bootstrap';
        var currentOrigin = '';
        var currentDestination = '';
        var spaceInCar;
        var isWaiting = "";
        var checkEscorts = [];
        var checkEquipment = [];
        var checkEquipmentAnonymous = [];
        var anonymousName = "";
        var isAnonymous = false;
        var isAssistant = false;
        var driverId;
        var dateForPush = "";
        var hourForPush = "";
        var pushMsg = "";
        var arr_for_assistant = [];
        var patientsAssistent = [];
        var arr_arabNamesAssistent = [];
        var arr_englishNamesAssistent = [];
        var patientsAssistentDisplay = [];
        var patientsIdentityAssistent = [];
        var isCenterPoint = false;
        var isCenterPatient = false;
        var isRegularPatientNoCenter = false;
        var flagFirstOne = true;
        //0 means no driver is asigned to the ride
        var rideStatusForFields = 0;
        var ridePatId;
        var ridePat;
        var currentDriverId;
        var RideId;
        var driverMode = "";
        var firstDriverBeforeSwap = true;
        var drivers = [];
        var driversID = [];
        var addedEquipment = false;
        var deleteDriverFlag = false;
        var firstLoad = true;
        var hospitals = [];
        var isThisAReturnDrive = false;
        var rideNumberForNo;
        // var secondModal = false;
        var CoordinatorForReturn;

        let escorts_inthisRidePat = [];
        let patients_JSONArray = [];
        let { buildStringforEquipment,
            convertDBDate2FrontEndDate,
            buildStringforDriverResponsibilityEquipment,
            compareFunc
        } = GENERAL.USEFULL_FUNCTIONS;
        const { APP_ID } = GENERAL;

        let patients_Names = []
        let rideNumber = 0;
        let x_wasClicked = false;
        let existingPatient;
        let existingOrigion;
        let existingDestination;
        let allowChangeOf_originAndDestination = true;
        let alert2user = '';
        let arr_locations = [];
        let generateLocationPromise;
        let getPatientByIdPromise;

        const showMyModal = (id) => {

            //modal_x
            if (numberofrides_GLOBAL > 1) {

                document.getElementById("modal_x").style.visibility = 'hidden';
            } else {

                document.getElementById("modal_x").style.visibility = 'visible';
            }

            $(`#${id}`).modal({
                backdrop: 'static', //prevent popup to close when clicking outside
                keyboard: false     //prevent popup to close when press esc on the keyboard
            });
            $(`#${id}`).modal('show');
        }

        Date.prototype.addDays = function (days) {
            var date = new Date(this.valueOf());
            date.setDate(date.getDate() + days);
            return date;
        }

        const DIFFER_RIDE_AXIS_MSG = 'ציר ההסעה של הסעה זו שונה ממה שהוגדר כברירת מחדל לחולה. ניתן לעדכן שדות אלו בהסעה.';
        const DIFFER_AREAS_MSG = 'מכיוון שקו ההסעה של החולה לא נמצא באזור של ההסעה האנונימית הזו, לא ניתן להשתמש בהסעה. יש לפתוח הסעה חדשה עבור החולה הספציפי.';
        const NOT_EXIST = 'ערך זה אינו קיים בבסיס הנתונים';

        const allowedLocations = ['patientform.html', 'viewpatient.html'];

        $(document).ready(function () {
            let { COPYWRITE } = GENERAL;
            $('#rights').html(COPYWRITE());
            $('#wait').show();

            $('#saveCustomer').removeClass("saveHighlight");
            $('#deleteDriver').hide();
            generateDrivers()

            var pat = $("#pat").val();
            if (pat === "") {
                $("#patientInfo").hide();
            }
            isAssistant = JSON.parse(GENERAL.USER.getIsAssistant());
            var assistantName = "";
            if (isAssistant) {
                $("#menuType").attr("w3-include-html", "HelperMenu.html");
                $("#duplicate").hide();
                $("#selectstatusRidePat").hide();
                $("#statuslabelRidePat").hide();
                var coorAssistant = GENERAL.USER.getCoorAssistant();
                assistantName = GENERAL.USER.getAsistantDisplayName();
            }
            else $("#menuType").attr("w3-include-html", "menu.html");
            includeHTML();
            $('[data-toggle="tooltip"]').tooltip();
            if (window.location.hostname.toString() == 'localhost' || window.location.pathname.toLowerCase().indexOf('test') != -1) {
                $("#na").css("background-color", "#ffde89");
            }
            if (window.location.href.indexOf('http://40.117.122.242/Road%20to%20Recovery/') != -1) {
                window.location.href = "notAvailable.html";
            }
            if (isAssistant) {
                var userName = GENERAL.USER.getAsistantAndCoorDisplayName();
                $("#userName").html(userName);
            }
            else {
                var userName = GENERAL.USER.getUserDisplayName();
                $("#userName").html(userName);
            }
            loadPage();

            $("#pat").blur(async function () {
                $('#wait').show();
                let patientObj = patients_JSONArray.find(p => p.DisplayName.trim() === $('#pat').val().trim());
                if (patientObj) {
                    let targetPatient = await getPatientById(patientObj.Id);
                    request2updateData(targetPatient);
                    request2TurnOffLoader([getPatientByIdPromise]);
                } else {
                    $('#wait').hide();
                    swal(NOT_EXIST, '', 'error');
                }

            });

            $("#pat").keyup(function () {
                $("#patEnglishName").val("");
                $("#patArabic").val("");
                $("#PatientIdentity").val("");
            });

            $("#patArabic").keyup(function () {
                $("#pat").val("");
                $("#patEnglishName").val("");
                $("#PatientIdentity").val("");
            });

            $("#patEnglishName").blur(async function () {
                $('#wait').show();
                let patientObj = patients_JSONArray.find(p => p.EnglishName.trim() === $('#patEnglishName').val().trim());
                if (patientObj) {
                    let targetPatient = await getPatientById(patientObj.Id);
                    request2updateData(targetPatient);
                    request2TurnOffLoader([getPatientByIdPromise]);
                } else {
                    $('#wait').hide();
                    swal(NOT_EXIST, '', 'error');
                }
            });

            $("#patEnglishName").keyup(function () {
                $("#pat").val("");
                $("#patArabic").val("");
                $("#PatientIdentity").val("");
            });

            $("#PatientIdentity").blur(async function () {
                if ($('#pat').val() === '') {
                    //due to the fact some patient still have 0 as their identity when
                    //we blur from there it brings the first one who has 0 as its identity
                    $('#wait').show();

                    let patientObj = patients_JSONArray.find(p => p.PatientIdentity === parseInt($('#PatientIdentity').val()));
                    if (patientObj) {
                        let targetPatient = await getPatientById(patientObj.Id);
                        request2updateData(targetPatient);
                        request2TurnOffLoader([getPatientByIdPromise]);
                    } else {
                        $('#wait').hide();
                        swal(NOT_EXIST, '', 'error');
                    }
                }

            });

            $("#PatientIdentity").keyup(function () {
                $("#pat").val("");
                $("#patEnglishName").val("");
                $("#patArabic").val("");
            });


            $('#Origin').on('change', function () {

                if (arr_customer.func === 'new') {
                    return;
                }

                let targetLocationObj = arr_locations.find(l => l.Name === $('#Origin').val());

                if (!existingOrigion) {
                    return $('#Origin').val(targetLocationObj.Name);
                }
                if (existingOrigion.Type === 'כללית' && targetLocationObj.Type !== 'כללית') {
                    if (existingOrigion.Area !== targetLocationObj.Area) {
                        $('#Origin').val(existingOrigion.Name);
                        swal(DIFFER_AREAS_MSG, '', 'error');
                    } else {
                        $('#Origin').val(targetLocationObj.Name);
                    }
                }
            });

            $('#Destination').on('change', function () {

                if (arr_customer.func === 'new') {
                    return;
                }

                let targetLocationObj = arr_locations.find(l => l.Name === $('#Destination').val());

                if (!existingDestination) {
                    return $('#Destination').val(targetLocationObj.Name);
                }
                if (existingDestination.Type === 'כללית' && targetLocationObj.Type !== 'כללית') {
                    if (existingDestination.Area !== targetLocationObj.Area) {
                        $('#Destination').val(existingDestination.Name);
                        swal(DIFFER_AREAS_MSG, '', 'error');
                    } else {
                        $('#Destination').val(targetLocationObj.Name);
                    }
                }
            });


            if (arr_customer.func === 'new' && isAllowedLocation(document.referrer.toLocaleLowerCase())) {

                let patientFrom_patientForm = JSON.parse(localStorage.getItem('PatientNameForRide'));

                let patientObj = patients_JSONArray.find(p => p.DisplayName.trim() === patientFrom_patientForm.trim());

                if (patientObj) {


                    (async () => {
                        let targetPatient = await getPatientById(patientObj.Id);
                        request2updateData(targetPatient);
                        request2TurnOffLoader([generateLocationPromise, getPatientByIdPromise]);
                    })();

                }


            }

            // DO NOT REMOVE : GLOBAL FUNCTIONS!
            var errorClass = 'invalid';
            var errorElement = 'em';
            var $serviceForm = $('#customerForm').validate({

                highlight: function (element) {
                    jQuery(element).closest('.form-group').addClass('has-error');
                },
                unhighlight: function (element) {
                    jQuery(element).closest('.form-group').removeClass('has-error');
                },

                // Rules for form validation
                rules: {
                    dateRide: {
                        required: true
                    },
                    pat: {
                        required: true
                    },
                    //patArabic: {
                    //    required: true
                    //},
                    Origin: {
                        required: true
                    },
                    Destination: {
                        required: true
                    },
                    coordinator: {
                        required: true
                    },
                },
                submitHandler: function (form, event) {
                    $('#wait').show();
                    event.preventDefault();
                    var valid = validateInputs();
                    if (!valid) {
                        $('#wait').hide();
                        return false;
                    }
                    var numberOfRides = 1;
                    var repeatRide = "";


                    if ($("#duplicateRidePat").is(':checked')) {
                        numberOfRides = parseInt($("#numberOfRides").val());
                        repeatRide = $("#repeatRide").val();

                    }
                    if (numberOfRides > 1 && arr_customer.func === "new") {
                        var validRides = PrintRides(repeatRide, numberOfRides);

                        if (!validRides) {
                            $('#wait').hide();
                            return false;
                        }
                    }
                    numberofrides_GLOBAL = numberOfRides;

                    localStorage.setItem("numberOfRides", numberOfRides);
                    localStorage.setItem("repeatRide", repeatRide);
                    localStorage.setItem("dateForReturnRepeat", $("#dateRide").val());



                    var RidePatNum = $("#ridePatNum").val();
                    var Pat = new Object();
                    Pat.DisplayName = $("#pat").val();
                    Pat.DisplayName = Pat.DisplayName.replace(/\s\s+/g, ' ');
                    Pat.Id = localStorage.PatID;
                    var Origin = new Object();
                    Origin.Name = $("#Origin").val();
                    var Destination = new Object();
                    Destination.Name = $("#Destination").val();
                    var Remark = $("#remark").val();
                    var dateRide = $("#dateRide").val();
                    var hours = $("#hour").val();
                    var minutes = $("#minute").val();
                    //dateRide + " " + hours + ":" + minutes;
                    var Day = parseInt(dateRide.substring(8));
                    var Month = parseInt(dateRide.substring(5, 7)) - 1;
                    var Year = parseInt(dateRide.substring(0, 4));
                    dateForPush = Day + "/" + Month + "/" + Year;
                    var Hour = parseInt(hours);
                    var Minute = parseInt(minutes);
                    hourForPush = hours + ":" + minutes;
                    if ($("#afterNoon").is(':checked')) { //22:14 is the default time that means afternoon אחה''צ
                        Hour = 22;
                        Minute = 14;
                        hourForPush = "אחה\"צ"
                    }
                    var date = new Date(Year, Month, Day, Hour, Minute).toUTCString();
                    let nowInUTC = new Date().toUTCString();
                    var func = arr_customer.func;

                    




                    var Coordinator = new Object();
                    Coordinator.DisplayName = $("#coordinator").val();
                    var OnlyEscort = false;
                    if ($("#onlyEscort").is(':checked')) {
                        OnlyEscort = true;
                    }

                    //set Escorts
                    let Escorts = [];
                    let Escort = {};
                    $('#selectEscort input:checked').each(function () {
                        Escort = {};
                        let tempStr = $(this).attr('id'); //// for example: escortCB17
                        Escort.Id = parseInt(tempStr.substring(tempStr.indexOf('B') + 1, tempStr.length));
                        Escorts.push(Escort);
                    });

                    //in case of different equipment than declared for anonymous ridepat.
                    var str = "";

                    if (func == "edit" && checkEquipment.length != checkEquipmentAnonymous.length) {
                        if (checkEquipment.length > checkEquipmentAnonymous.length) {
                            alert("ירד ציוד מההסעה");
                        }
                        if (checkEquipment.length <= checkEquipmentAnonymous.length) {

                            for (var i = 0; i < checkEquipmentAnonymous.length; i++) {
                                str += checkEquipmentAnonymous[i] + ", ";
                            }
                            var answer = confirm("נוסף ציוד לנסיעה. \nהציוד בנסיעה יהיה: " + str + " \n האם להמשיך בעריכה? ");
                            if (!answer) {
                                location.href = "manageRidePats.html";
                                return false;
                            } else {
                                getEquipmentForPatient();
                            }

                        }
                        getEquipmentForPatient();
                    }

                    //in case of more escorts than declared for anonymous ridepat.
                    if (func == "edit" && (anonymousName == "True" || isAssistant) && isWaiting != "ממתינה לשיבוץ") {
                        if (checkEscorts.length < Escorts.length) {
                            genarteAvailbaleSeats();
                            checkSpaceInCar = spaceInCar + checkEscorts.length - Escorts.length;
                            if (checkSpaceInCar > Escorts.length) {
                                var numberOfAddedEscorts = Escorts.length - checkEscorts.length;

                                var answer = confirm("נוספו מלווים להסעה, מספר המלווים שנוספו הוא: " + numberOfAddedEscorts + ", למרות זאת, יש עדיין מקום ברכב המתנדב. האם תרצה להמשיך בעריכה? ");
                                if (!answer) {
                                    location.href = "manageRidePats.html";
                                    return false;
                                }
                            }
                            else {
                                var numberOfAddedEscorts = Escorts.length - checkEscorts.length;
                                var numberOfSeatsAv = spaceInCar + checkEscorts.length;
                                if (isAssistant) {
                                    swal({
                                        title: "Can't add escorts to the ride, not enough space in the driver car.",
                                        type: "warning",
                                        showConfirmButton: true
                                    });
                                    return false;
                                }
                                else {
                                    var answer = confirm(" נוספו " + numberOfAddedEscorts + " מלווים. מספר המקומות הפנויים ברכב הוא: " + numberOfSeatsAv + " האם תרצה להמשיך בעריכה?");
                                    if (!answer) {
                                        location.href = "manageRidePats.html";
                                        return false;
                                    }
                                }
                            }
                        }
                    }

                    if (func == "new") {
                        RidePat = {
                            Pat: Pat, Origin: Origin, Destination: Destination, Coordinator: Coordinator, Remark: Remark, Escorts: Escorts, Date: date, OnlyEscort: OnlyEscort, LastModified: nowInUTC
                        }
                        var userName = GENERAL.USER.getAsistantDisplayName();
                        pushMsg = "העוזר " + userName + " הקים נסיעה חדשה עם החולה " + $("#pat").val() + " בתאריך " + dateForPush + " בשעה " + hourForPush + " מ" + $("#Origin").val() + " ל" + $("#Destination").val();


                    }
                    else {
                        if (x_wasClicked) {
                            x_wasClicked = false;
                            RidePat = {
                                RidePatNum: rideNumber, Pat: Pat, Origin: Origin, Destination: Destination, Coordinator: Coordinator, Date: date, Remark: Remark,
                                Escorts: Escorts, OnlyEscort: OnlyEscort, LastModified: nowInUTC
                            }

                        } else {
                            RidePat = {
                                RidePatNum: RidePatNum, Pat: Pat, Origin: Origin, Destination: Destination, Coordinator: Coordinator, Date: date, Remark: Remark,
                                Escorts: Escorts, OnlyEscort: OnlyEscort, LastModified: nowInUTC
                            }
                            if (RidePat.RidePatNum === "") {
                                RidePat.RidePatNum = 0;
                            }
                        }
                    }
                    if (isThisAReturnDrive) {
                        var request = { RidePat: RidePat, func: "new", isAnonymous: isAnonymous, numberOfRides: numberOfRides, repeatRideEvery: repeatRide }
                    } else {
                        var request = { RidePat: RidePat, func: func, isAnonymous: isAnonymous, numberOfRides: numberOfRides, repeatRideEvery: repeatRide }
                    }

                    var dataString = JSON.stringify(request);
                    localStorage.setItem("PatientNameForRide", null);

                    //console.log('Gilad check || before submit the form data:', JSON.parse(dataString));
                    setUnityRideNew(dataString);

                    //Before united-(old API and tables in DB)
                    //********************************************************** */
                    //$.ajax({
                    //    dataType: "json",
                    //    url: "WebService.asmx/setRidePat",
                    //    contentType: "application/json; charset=utf-8",
                    //    type: "POST",
                    //    data: dataString,
                    //    success: function (data) {
                    //        if (data.d === 1) {
                    //            //there is such a drive and status is not נמחקה

                    //            $('#wait').hide();
                    //            let date2present = new Date(request.RidePat.Date).toLocaleDateString('he-IL');
                    //            swal(
                    //                "خطأ\nשגיאה",
                    //                "קיימת כבר הסעה בתאריך " + date2present + " עם אותו החולה ואותן נקודות האיסוף\nيوجد سفرية بالتاريخ (التاريخ) مع نفس المريض ونفس نقطة الالتقاء",
                    //                "warning"
                    //            );

                    //        } else if (data.d < 0) { //there is such a drive and status = נמחקה

                    //            let rideNumber = data.d * -1; //retriving the rideNumber back to positive number
                    //            rideNumberForNo = rideNumber;
                    //            let returnDriveExist = false;
                    //            tmpOrigin = Origin;
                    //            Origin = Destination;
                    //            Destination = tmpOrigin;
                    //            RidePatBack = {
                    //                Pat: Pat, Origin: Origin, Destination: Destination, Coordinator: Coordinator, Remark: Remark, Escorts: Escorts, Date: date, OnlyEscort: OnlyEscort
                    //            }
                    //            $.ajax({
                    //                dataType: "json",
                    //                url: "WebService.asmx/CheckRidePat",
                    //                contentType: "application/json; charset=utf-8",
                    //                type: "POST",
                    //                //  async: false,
                    //                data: JSON.stringify({ RidePatBack }),
                    //                success: function (data) {
                    //                    $('#wait').hide();
                    //                    let driverInput_hasValue = ($('#driver').val() !== "");

                    //                    returnDriveExist = JSON.parse(data.d);
                    //                    console.log(returnDriveExist)
                    //                    var DestIsHospital = hospitals.includes(request.RidePat.Destination.Name);

                    //                    if (driverInput_hasValue) {
                    //                        currentDriverId = -1;
                    //                        addDriver(rideNumber);
                    //                    }

                    //                    if (DestIsHospital && !returnDriveExist || DestIsHospital && isAnonymous) {//offer a return ride
                    //                        document.getElementById('ModalTitle').innerHTML = 'הנסיעה שוחזרה בהצלחה';

                    //                        document.getElementById('modalButtons').innerHTML = '<button onclick="createNewRide()" class="btn btn-success waves-effect w-md m-b-5 sameWidthBtn"><i class="ti-plus m-r-5"></i>יצירת הסעה חדשה</button>&nbsp;';
                    //                        document.getElementById('modalButtons').innerHTML += '<button onclick="return2manageRidePats()" class="btn btn-default waves-effect w-md m-b-5 sameWidthBtn">חזרה לניהול ההסעות <i class="ti-back-right m-r-5"></i></button>';
                    //                        document.getElementById('modalButtons').innerHTML += '<button onclick="createReturnRide()" class="btn btn-success waves-effect w-md m-b-5 sameWidthBtn">יצירת החזרה &nbsp;<i class="ti-car m-r-5"></i></button>';

                    //                        showMyModal('Modal');
                    //                    } else { // dont offer return drive
                    //                        document.getElementById('ModalTitle').innerHTML = 'הנסיעה שוחזרה בהצלחה';
                    //                        document.getElementById('modalButtons').innerHTML = '<button onclick="createNewRide()" class="btn btn-success waves-effect w-md m-b-5 sameWidthBtn"><i class="ti-plus m-r-5"></i>יצירת הסעה חדשה</button>&nbsp;';
                    //                        document.getElementById('modalButtons').innerHTML += '<button onclick="return2manageRidePats()" class="btn btn-default waves-effect w-md m-b-5 sameWidthBtn">חזרה לניהול ההסעות <i class="ti-back-right m-r-5"></i></button>';

                    //                        showMyModal('Modal');
                    //                    }

                    //                },
                    //                error: function (err) {
                    //                    $('#wait').hide();
                    //                    alert("Error in CheckRidePat: " + err.responseText);
                    //                }
                    //            });
                    //        }
                    //        else {
                    //            rideNumber = data.d;
                    //            rideNumberForNo = rideNumber;
                    //            var returnDriveExist = false;

                    //            tmpOrigin = Origin;
                    //            Origin = Destination;
                    //            Destination = tmpOrigin;
                    //            RidePatBack = {
                    //                Pat: Pat, Origin: Origin, Destination: Destination, Coordinator: Coordinator, Remark: Remark, Escorts: Escorts, Date: date, OnlyEscort: OnlyEscort
                    //            }

                    //            $.ajax({
                    //                dataType: "json",
                    //                url: "WebService.asmx/CheckRidePat",
                    //                contentType: "application/json; charset=utf-8",
                    //                type: "POST",
                    //                // async: false,
                    //                data: JSON.stringify({ RidePatBack }),
                    //                success: function (data) {
                    //                    $('#wait').hide();
                    //                    let driverInput_hasValue = ($('#driver').val() !== "");
                    //                    returnDriveExist = JSON.parse(data.d);
                    //                    //console.log(returnDriveExist)
                    //                    var DestIsHospital = hospitals.includes(request.RidePat.Destination.Name);
                    //                    if (driverInput_hasValue) {
                    //                        currentDriverId = -1;
                    //                        addDriver(rideNumber);
                    //                    }

                    //                    if (DestIsHospital && !returnDriveExist || DestIsHospital && isAnonymous) {//offer a return ride
                    //                        document.getElementById('ModalTitle').innerHTML = 'הנסיעה נשמרה';

                    //                        document.getElementById('modalButtons').innerHTML = '<button onclick="createNewRide()" class="btn btn-success waves-effect w-md m-b-5 sameWidthBtn"><i class="ti-plus m-r-5"></i>יצירת הסעה חדשה</button>&nbsp;';
                    //                        document.getElementById('modalButtons').innerHTML += '<button onclick="return2manageRidePats()" class="btn btn-default waves-effect w-md m-b-5 sameWidthBtn">חזרה לניהול ההסעות <i class="ti-back-right m-r-5"></i></button>';
                    //                        document.getElementById('modalButtons').innerHTML += '<button onclick="createReturnRide()" class="btn btn-success waves-effect w-md m-b-5 sameWidthBtn">יצירת החזרה &nbsp;<i class="ti-car m-r-5"></i></button>';

                    //                        showMyModal('Modal');
                    //                    } else { // dont offer return drive
                    //                        document.getElementById('ModalTitle').innerHTML = 'הנסיעה נשמרה';
                    //                        document.getElementById('modalButtons').innerHTML = '<button onclick="createNewRide()" class="btn btn-success waves-effect w-md m-b-5 sameWidthBtn"><i class="ti-plus m-r-5"></i>יצירת הסעה חדשה</button>&nbsp;';
                    //                        document.getElementById('modalButtons').innerHTML += '<button onclick="return2manageRidePats()" class="btn btn-default waves-effect w-md m-b-5 sameWidthBtn">חזרה לניהול ההסעות <i class="ti-back-right m-r-5"></i></button>';

                    //                        showMyModal('Modal');
                    //                    }
                    //                },
                    //                error: function (err) {
                    //                    $('#wait').hide();
                    //                    alert("Error in CheckRidePat: " + err.responseText);
                    //                }
                    //            });


                    //        }

                    //    },
                    //    error: function (err) {
                    //        $('#wait').hide();
                    //        console.log(err);
                    //        swal(
                    //            "خطأ\nשגיאה",
                    //            "משהו השתבש, צא ונסה שנית\nحدث خطأ ما، الرجاء الخروج والدخول مرة اخرى",
                    //            "warning"
                    //        );
                    //    }
                    //});
                    return false;
                },

                // Messages for form validation
                messages: {
                    dateRide: {
                        required: "יש להכניס תאריך"
                    },
                    pat: {
                        required: "יש לבחור חולה\nيجب اختيار مريض من القائمة"
                    },
                    Origin: {
                        required: "יש לבחור מוצא"
                    },
                    Destination: {
                        required: "יש לבחור יעד"
                    },
                    coordinator: {
                        required: "יש לבחור רכז אחראי"
                    },
                },


            });

            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getHospitalView",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                //  async: false,
                data: JSON.stringify({ active: true }),
                success: function (data) {
                    arr_hospitals = JSON.parse(data.d);
                    for (i in arr_hospitals) {
                        hospitals.push(arr_hospitals[i].Name)
                    }
                },
                error: function (err) { alert("Error in getHospitalView: " + err.responseText); }
            });


        });


        // new func for new way to save rides in the DB -Gilad
        const setUnityRideNew = (data) => {
            //console.log('from test CheckAPI_Gilad ', JSON.parse(data));
            let dataobj = JSON.parse(data);
            const unityRide = {};
            unityRide.PatientName = dataobj.RidePat.Pat.DisplayName;
            unityRide.PatientId = dataobj.RidePat.Pat.Id;
            unityRide.Origin = dataobj.RidePat.Origin.Name;
            unityRide.Destination = dataobj.RidePat.Destination.Name;
            unityRide.PickupTime = dataobj.RidePat.Date;
            unityRide.Remark = dataobj.RidePat.Remark;
            unityRide.OnlyEscort = dataobj.RidePat.OnlyEscort;
            unityRide.IsAnonymous = dataobj.isAnonymous;
            unityRide.CoorName = dataobj.RidePat.Coordinator.DisplayName;
            unityRide.DriverName = $('#driver').val() == '' ? null : $('#driver').val()
            unityRide.RidePatNum = dataobj.func == 'edit' ? dataobj.RidePat.RidePatNum : 0;
            unityRide.AmountOfEscorts = dataobj.RidePat.Escorts.length;
            let request = { unityRide: unityRide, func: dataobj.func, numOfRide: dataobj.numberOfRides, repeatEvery: dataobj.repeatRideEvery, firstTry:true };
            //console.log('After Custom',request);
            isThisAReturnDriveFunc(dataobj.RidePat);
            let dataString = JSON.stringify(request);

             $.ajax({
                        dataType: "json",
                        url: "WebService.asmx/setUnityRide",
                        contentType: "application/json; charset=utf-8",
                        type: "POST",
                        data: dataString,
                        success: function (data) {
                            //console.log('Sucsses res -->', data.d);
                            const result = JSON.parse(data.d);
                            if (result == -5) {
                                swal({
                                    title: "נהג זה שובץ לנסיעה בשעה שבחרת במקומות שונים",
                                    type: "warning",
                                    text: '? האם בכל זאת תרצה לשבץ נהג זה לנסיעה זאת ',
                                    showCancelButton: true,
                                    cancelButtonText: "בטל",
                                    confirmButtonClass: 'btn-warning',
                                    confirmButtonText: "שבץ",
                                    closeOnConfirm: true
                                }, function (userResponse) {
                                    if (userResponse) {
                                        let request2 = { unityRide: unityRide, func: dataobj.func, numOfRide: dataobj.numberOfRides, repeatEvery: dataobj.repeatRideEvery, firstTry: false };
                                        let dataString2 = JSON.stringify(request2);
                                        $.ajax({
                                            dataType: "json",
                                            url: "WebService.asmx/setUnityRide",
                                            contentType: "application/json; charset=utf-8",
                                            type: "POST",
                                            data: dataString2,
                                            success: function (data) {
                                                //console.log('Sucsses res -->', data.d);
                                                const result = JSON.parse(data.d);

                                                if (result == -1 || result == 0) {
                                                    showErrorSwal(request.unityRide.PickupTime);
                                                }
                                                else {
                                                    showButtonsModal(isThisAReturnDrive);
                                                }
                                            },
                                            error: function (err) {
                                                $('#wait').hide();
                                                console.log('Error from new API', err);

                                            }
                                        });
                                    }
                                    else {
                                        $('#wait').hide();
                                    }

                                });
                            }
                            else {
                                if (result == -1 || result == 0) {
                                    showErrorSwal(request.unityRide.PickupTime);
                                }
                                else if (result == -9)
                                {
                                    console.log('Error in setUnityRide ', request)
                                    Swal.fire({
                                        title: "שגיאה",
                                        text: "העדכון לא בוצע קיימת שגיאה בשליחת הנתונים",
                                        icon: "error"
                                    });
                                }

                                else
                                {
                                    showButtonsModal(isThisAReturnDrive);

                                }
                            }




                        },
                        error: function (err) {
                            $('#wait').hide();
                            console.log('Error from new API',err);
                                
                        }
             });

            const showButtonsModal = (isReturnDrive) => {
                if (isReturnDrive) {
                    $('#wait').hide();
                    document.getElementById('modalButtons').innerHTML = '<button onclick="createNewRide()" class="btn btn-success waves-effect w-md m-b-5 sameWidthBtn"><i class="ti-plus m-r-5"></i>יצירת הסעה חדשה</button>&nbsp;';
                    document.getElementById('modalButtons').innerHTML += '<button onclick="return2manageRidePats()" class="btn btn-default waves-effect w-md m-b-5 sameWidthBtn">חזרה לניהול ההסעות <i class="ti-back-right m-r-5"></i></button>';
                    showMyModal('Modal');
                }
                else {
                    $('#wait').hide();
                    document.getElementById('modalButtons').innerHTML = '<button onclick="createNewRide()" class="btn btn-success waves-effect w-md m-b-5 sameWidthBtn"><i class="ti-plus m-r-5"></i>יצירת הסעה חדשה</button>&nbsp;';
                    document.getElementById('modalButtons').innerHTML += '<button onclick="return2manageRidePats()" class="btn btn-default waves-effect w-md m-b-5 sameWidthBtn">חזרה לניהול ההסעות <i class="ti-back-right m-r-5"></i></button>';
                    document.getElementById('modalButtons').innerHTML += '<button onclick="createReturnRide()" class="btn btn-success waves-effect w-md m-b-5 sameWidthBtn">יצירת החזרה &nbsp;<i class="ti-car m-r-5"></i></button>';
                    showMyModal('Modal');
                }

            }

            

            ///////////////////////////////////////////////////////////////////////////

            //paramDic.Add("@patientName", unityRide.PatientName);
            //paramDic.Add("@patientId", unityRide.PatientId);
            //paramDic.Add("@origin", unityRide.Origin);
            //paramDic.Add("@destination", unityRide.Destination);
            //paramDic.Add("@pickupTime", unityRide.PickupTime);
            //paramDic.Add("@remark", unityRide.Remark);
            //paramDic.Add("@onlyEscort", unityRide.OnlyEscort);
            //paramDic.Add("@area", unityRide.Area);
            //paramDic.Add("@isAnonymous", unityRide.IsAnonymous);
            //paramDic.Add("@coorName", unityRide.CoorName);
            //paramDic.Add("@driverName", unityRide.DriverName);
            //paramDic.Add("@amountOfEscorts", unityRide.AmountOfEscorts);
        }
        //this is for the swal error modal if somethinggo wrong or already exist.
        const showErrorSwal = (date) => {
             $('#wait').hide();
             let date2present = new Date(date).toLocaleDateString('he-IL');
             swal(
             "خطأ\nשגיאה",
             "קיימת כבר הסעה בתאריך " + date2present + " עם אותו החולה ואותן נקודות האיסוף\nيوجد سفرية بالتاريخ (التاريخ) مع نفس المريض ونفس نقطة الالتقاء",
             "warning"
             );
        }

        const isAllowedLocation = (referrer) => {

            const result = allowedLocations.some(alllowedLocation => referrer.includes(alllowedLocation));
                
            return result;
        }

        const isSameArea = (existingPatient, targetPatient) => {
            return !(
                existingPatient.Barrier.Area !== targetPatient.Barrier.Area
                ||
                existingPatient.Hospital.Area !== targetPatient.Hospital.Area
            );
        }

        const request2updateData = (targetPatient) => {

            if (arr_customer.func == "new") {
                return fillPage_withPatientData(targetPatient, true);
            }

            if (!existingPatient) {
                return fillPage_withPatientData(targetPatient, true);
            }

            if (existingPatient.IsAnonymous) {

                if (targetPatient.IsAnonymous) {
                    swal('לא ניתן לשנות הסעה אנונימית להסעה אנונימית אחרת', '', 'error');
                    return fillPage_withPatientData(existingPatient);
                } else {

                    if (existingPatient.Barrier.Type !== 'כללית'
                        && existingPatient.Hospital.Type !== 'כללית') {//a well defined patient

                        let bothBarrier_and_HospitalDiffer =
                            existingPatient.Barrier.Name !== targetPatient.Barrier.Name
                            &&
                            existingPatient.Hospital.Name !== targetPatient.Hospital.Name;

                        if (bothBarrier_and_HospitalDiffer
                            ||
                            existingPatient.Barrier.Name !== targetPatient.Barrier.Name
                            ||
                            existingPatient.Hospital.Name !== targetPatient.Hospital.Name
                        ) {
                            alert2user = DIFFER_RIDE_AXIS_MSG;
                            allowChangeOf_originAndDestination = false;
                            return fillPage_withPatientData(targetPatient, true);

                        } else { //target patient and exist one has the same route
                            return fillPage_withPatientData(targetPatient, true);

                        }

                    } else {//a NOT well defined patient

                        if (isSameArea(existingPatient, targetPatient)) {
                            return fillPage_withPatientData(targetPatient, true);
                        } else {
                            swal(DIFFER_AREAS_MSG, '', 'error');
                            return fillPage_withPatientData(existingPatient);
                        }
                    }
                }

            } else {
                if (targetPatient.IsAnonymous) {
                    swal('לא ניתן לשנות מהסעה לחולה מסויים להסעה אנונימית', '', 'error');
                    return fillPage_withPatientData(existingPatient);
                } else {
                    if (isSameArea(existingPatient, targetPatient)) {
                        return fillPage_withPatientData(targetPatient);
                    } else {
                        swal(DIFFER_AREAS_MSG, '', 'error');
                        return fillPage_withPatientData(existingPatient);
                    }
                }
            }

        }

        const fillPage_withPatientData = (patient, markThe1stEscort = false) => {

            //console.log('inside fillPage_withPatientData --> patient-', patient, hospitals);
            isAnonymous = patient.IsAnonymous === "True";
            localStorage.PatID = patient.Id;
            $('#pat').val(patient.DisplayName);
            $('#patEnglishName').val(patient.EnglishName);
            let arabicDisplayName = patient.FirstNameA & patient.FirstNameA !== null + " " + patient.LastNameA & patient.LastNameA !== null;

            $('#patArabic').val(arabicDisplayName === 0 ? '' : arabicDisplayName);

            if (patient.EscortedList.length > 0) {
                EscortedList = patient.EscortedList;
                let str = '';
                for (var i = 0; i < EscortedList.length; i++) {
                    str += `<input id='escortCB${EscortedList[i].Id}' type=checkbox name='${EscortedList[i].DisplayName}' ${i === 0 && markThe1stEscort ? 'checked' : ''} >&nbsp`;
                    str += `<label data-toggle='tooltip' title='${EscortedList[i].DisplayName}' for='escortCB${EscortedList[i].Id}'>${EscortedList[i].DisplayName}</label>&nbsp&nbsp</br>`;
                }
                $("#selectEscort").html(str);


            } else {
                $("#selectEscort").html('');
            }

            $('#remark').val(patient.Remarks);
            $('#remark').prop('disabled', false);
            $('#PatientIdentity').val(patient.PatientIdentity);

            if (allowChangeOf_originAndDestination) {
                //console.log('come on : ', allowChangeOf_originAndDestination, patient.Barrier.Name, patient.Hospital.Name)
                $('#Origin').val(patient.Barrier.Name);
                $('#Destination').val(patient.Hospital.Name);
            } else {
                swal('', alert2user, 'warning');
            }

            if (patient.IsAnonymous &&
                (patient.Barrier.Type === 'כללית' || patient.Hospital.Type === 'כללית')
            ) {

                $('#Origin').prop('disabled', true);
                $("#Origin").wrap(`<span style='background: yellow;' data-toggle="tooltip" title="השדה לא ניתן לשינוי כשהנסיעה היא של חולה אנונימי בציר כללי" class="d-inline-block" tabindex="0"></span>`);
                $('#Destination').prop('disabled', true);
                $("#Destination").wrap(`<span data-toggle="tooltip" title="השדה לא ניתן לשינוי כשהנסיעה היא של חולה אנונימי בציר כללי" class="d-inline-block" tabindex="0"></span>`);
            } else {
                $('#Origin').prop('disabled', false);
                $('#Destination').prop('disabled', false);
            }


            $("#dirBTN").prop('disabled', false);
            $('#Equipment').text(buildStringforEquipment(patient.Equipment));
            $('#driverResponsibilityEquipment').text(buildStringforDriverResponsibilityEquipment(patient.Equipment));
            $('#dateRide').prop('disabled', false);

            if ($("#afterNoon").is(':checked')) {
                $("#hour").val("");
                $("#minute").val("");
                $("#hour").attr('disabled', true);
                $("#minute").attr('disabled', true);
            } else {
                $('#minute').prop('disabled', false);
                $('#hour').prop('disabled', false);
                $('#afterNoon').prop('disabled', false);
            }

            $('#wait').hide();

        }

        const getPatientById = (id) => {


            getPatientByIdPromise = new Promise((resolve, reject) => {

                const getPatientById_SCB = (data) => {
                    return resolve(JSON.parse(data.d));
                }

                const getPatientById_ECB = (err) => {
                    alert(err);
                    return reject(err);
                }

                const { ajaxCall } = GENERAL.FETCH_DATA;

                ajaxCall('GetPatientById', JSON.stringify({ id }), getPatientById_SCB, getPatientById_ECB);

            });

            return getPatientByIdPromise;
        }

        function returnRide() {
            ridePatNum = " ";
            arr_details = { ridePatNum: ridePatNum, func: "new" };
            GENERAL.RIDEPAT.setRidePatList(JSON.stringify(arr_details));

            switchDir();

            if (isThisAReturnDrive) {
                $("#driver").val("");
                $('#deleteDriver').hide();

            }

        }

        function addDriver(data) {

            var tmpDriverName = $('#driver').val();
            var driverIndex = drivers.indexOf($('#driver').val());
            userSelected = driversID[driverIndex];

            ridePatId = data;

            localStorage.setItem("ridePatId", ridePatId);

            if (!(ridePat == undefined)) {
                if (ridePat.Drivers.length > 0) {
                    //$('#Driver').val(ridePat.Drivers[0].Id)
                    flagFirstOne = false;
                    var driverIDindex = driversID.indexOf(ridePat.Drivers[0].Id);

                    if (!deleteDriverFlag) {
                        $('#driver').val(drivers[driverIDindex])
                        currentDriverId = ridePat.Drivers[0].Id;
                        $('#deleteDriver').show();
                        //flagFirstOne = false;
                        deleteDriverFlag = false;
                    }


                }
            } else if (!deleteDriverFlag) {
                var driverIndex = drivers.indexOf($('#driver').val());
                userSelected = driversID[driverIndex];
                deleteDriverFlag = false;
            }

            if (flagFirstOne || isThisAReturnDrive) {
                currentDriverId = -1; // There is no driver assigned to the ride
                flagFirstOne = false;

            }


            signDriverToRide()
            $('#driver').val(tmpDriverName)


            if (isAssistant && pushMsg !== "") {
                //send messege to coordinator from assistant on new ridepat creation.
                sendMessegeFromAssistant(data, pushMsg);
            }
        }

        function sendMessegeFromAssistant(ridepat, msg) {
            var user = GENERAL.USER.getUserName();
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/pushAssistant",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                //async: false,
                data: JSON.stringify({ ridepat: ridepat, cellphone: user, msg: msg }),
                error: pushAssistantErrorCB,

            });
        }

        function pushAssistantErrorCB(error) {
            console.log(error);
        }

        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [day, month, year].join('/');
        }

        function PrintRides(repeatRide, num) {
            var duplicateDetails = {
                repeatRide: $('#repeatRide').val(),
                numberOfRides: $('#numberOfRides').val()
            }
            localStorage.setItem("duplicateRidePat", JSON.stringify(duplicateDetails));

            var datesToPrint = num + " הסעות חדשות יווצרו בתאריכים:\n";
            var dateRide = $("#dateRide").val();
            var hours = $("#hour").val();
            var minutes = $("#minute").val();

            var Day = parseInt(dateRide.substring(8));
            var Month = parseInt(dateRide.substring(5, 7)) - 1;
            var Year = parseInt(dateRide.substring(0, 4));
            var Hour = parseInt(hours);
            var Minute = parseInt(minutes);
            if ($("#afterNoon").is(':checked')) { //22:14 is the default time that means afternoon אחה''צ
                Hour = 22;
                Minute = 14;
            }
            var date = new Date(Year, Month, Day, Hour, Minute);

            if (repeatRide === "כל שבוע") {
                for (let i = 0; i < num; i++) {
                    datesToPrint += formatDate(date) + "\n";
                    date = new Date(date.setDate(date.getDate() + 7));
                }
            }
            else {
                for (let i = 0; i < num; i++) {
                    datesToPrint += formatDate(date) + "\n";
                    date = new Date(date.setDate(date.getDate() + 1));
                }
            }



            if (confirm(datesToPrint)) {
                return true;
            }
            return false;
        }

        const getPatients_slim = () => {

            const getPatients_slim_ECB = (err) => {
                alert(err);
            }

            const getPatients_slim_SCB = (data) => {
                patients_JSONArray = JSON.parse(data.d);

                patients_Names = [];//DisplayName
                let patients_EnglishNames = [];//EnglishName
                let patients_identityNum = [];//PatientIdentity

                for (var i = 0; i < patients_JSONArray.length; i++) {

                    if (isAssistant && patients_JSONArray[i].IsAnonymous === true) {
                        continue;
                    }
                    patients_Names.push(patients_JSONArray[i].DisplayName.trim());
                    patients_EnglishNames.push(patients_JSONArray[i].EnglishName.trim());
                    patients_identityNum.push(patients_JSONArray[i].PatientIdentity.toString());
                }

                patients_Names.sort();
                patients_EnglishNames.sort();

                $("#pat").autocomplete({
                    source: patients_Names
                });
                $("#patEnglishName").autocomplete({
                    source: patients_EnglishNames
                });
                $("#PatientIdentity").autocomplete({
                    source: patients_identityNum
                });


            }

            const { ajaxCall_WithGzipMe } = GENERAL.FETCH_DATA;
            ajaxCall_WithGzipMe('GetPatients_slim', JSON.stringify({ isActive: true }), getPatients_slim_SCB, getPatients_slim_ECB, false);
        }

        function genarteAvailbaleSeats() {
            var ridePatNumber = parseInt($("#ridePatNum").val());
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getSpaceInCar",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                // async: false,
                data: JSON.stringify({ ridePatNum: ridePatNumber, driverId: driverId }),
                success: function (data) {
                    spaceInCar = JSON.parse(data.d);
                },
                error: function (err) { alert("Error in getSpaceInCar"); }
            });
        }

        function getCoor() {
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getCoor",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                //async: false,
                data: JSON.stringify({ userName: GENERAL.USER.getUserName() }),
                success: getCoorSuccessCB,
                error: getCoorErrorCB
            });
        }

        function getCoorSuccessCB(data) {

            var $select = $("#coordinator");
            var coor = JSON.parse(data.d);


            $select.val(coor.DisplayName);
            if (isAnonymous === true) {
                $select.is("checked:", "checked");
            }
        }

        function getCoorErrorCB(e) {
            alert("Error in getCoor: " + e.responseText);
        }

        function generateStatus() {

            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getAllStatus",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                //async: false,
                //data: JSON.stringify({ patient: dataString }),
                success: generateStatusSuccessCB,
                error: generateStatusErrorCB
            });

            function generateStatusSuccessCB(data) {
                var $select = $("#statusRidePat");
                var arr_status = JSON.parse(data.d);
                for (i in arr_status) {
                    var status = arr_status[i].Name;
                    $('<option>', { value: status, text: status }).appendTo($select);
                }
                if (arr_customer.func == "new") {
                    $("#statusRidePat option[value='ממתינה לשיבוץ']").prop('selected', true);
                }

            }

            function generateStatusErrorCB() {
                alert("Error in generateStatus");
            }
        }

        async function generateLocation() {

            generateLocationPromise = new Promise((resolve, reject) => {
                // $('#wait').show();

                var $select = $("#Origin");
                var $select1 = $("#Destination");
                $.ajax({
                    dataType: "json",
                    url: "WebService.asmx/getDestinationView",
                    contentType: "application/json; charset=utf-8",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Content-Encoding", "gzip");
                    },
                    type: "POST",
                    //   async: false,
                    data: JSON.stringify({ active: true }),
                    success: function (data) {

                        arr_locations = JSON.parse(data.d);
                        arr_locations.sort(compareFunc);
                        for (i in arr_locations) {

                            $('<option>', { value: arr_locations[i].Name, text: arr_locations[i].Name }).appendTo($select);
                            $('<option>', { value: arr_locations[i].Name, text: arr_locations[i].Name }).appendTo($select1);
                        }

                        return resolve(1);
                    },
                    error: function (err) {
                        alert("Error in generateLocation" + err.responseText);
                        console.log(err);
                        return reject(0);
                    }
                });
            });
            return generateLocationPromise;
        }

        function generateHour() {
            var $select = $("#hour");
            for (var i = 0; i < 24; i++) {
                if (i < 10) i = "0" + i;
                $('<option>', { value: i, text: i }).appendTo($select);
            }
            $select.val("06");
        }

        function generateMinute() {
            var $select = $("#minute");
            for (var i = 0; i < 60; i += 15) {
                if (i < 10) var j = "0" + i; else j = i;
                $('<option>', { value: j, text: j }).appendTo($select);
            }
            $select.val("00");
        }

        function validateInputs() {

            let patientExists = false;
            let origin = $("#Origin").val();
            let destination = $("#Destination").val();
            let driverExist = true;

            let patientName = $("#pat").val().trim();

            if (isAssistant && patientName.includes('אנונימי')) {
                return swal(
                    "PAY ATTENTION",
                    "Sorry, an assistant account cannot modify an anonymous patient's ride information",
                    "warning"
                );
            }

            for (var i = 0; i < patients_Names.length; i++) {
                patientExists = patientName === patients_Names[i].trim();
                if (patientExists) {
                    break;
                }
            }

            if (!patientExists) {
                return swal(
                    "خطأ\nשגיאה",
                    "يجب اختيار مريض من القائمة\nיש לבחור חולה מתוך הרשימה",
                    "warning"
                );
            }

            if (origin === "בחר מוצא" || origin === '') {
                return swal(
                    "خطأ\nשגיאה",
                    "يجب اختيار نقطة انطلاق من القائمة\nיש לבחור מוצא מתוך הרשימה",
                    "warning"
                );
            }

            if (destination === "בחר יעד" || destination === '') {
                return swal(
                    "خطأ\nשגיאה",
                    "يجب اختيار نقطة انطلاق من القائمة\nיש לבחור יעד מתוך הרשימה",
                    "warning"
                );
            }

            var date = document.getElementById("dateRide").value;
            var Day = parseInt(date.substring(8));
            var Month = parseInt(date.substring(5, 7)) - 1;
            var Year = parseInt(date.substring(0, 4));
            date = new Date(Year, Month, Day, $("#hour").val(), $("#minute").val());
            futureDate = checkFutureDate(date);
            if (!futureDate) {
                return confirm(" זמן ההסעה עבר, האם להמשיך?"); //yes will return true and vice verse
            }

            var timeMatch = true;
            var aN = $("#afterNoon").is(':checked');
            if (!aN) {
                if ($("#hour").val() == "שעות" || $("#minute").val() == "דקות") {
                    return swal(
                        "خطأ\nשגיאה",
                        "השעה שנבחרה אינה חוקית\nالساعة التي تم اختيارها غير ملائمة",
                        "warning"
                    );
                }
            }

            if (drivers.indexOf($('#driver').val()) == -1 && ($('#driver').val() != "")) {
                return swal(
                    "خطأ\nשגיאה",
                    "יש לבחור נהג מתוך הרשימה",
                    "warning"
                );
            }
            return true;
        }

        function checkFutureDate(date) {

            checkDate = Date.parse(date); //parameter datetime to compare with today
            if ($("#afterNoon").is(':checked')) { //22:14 is the default time that means afternoon אחה''צ
                checkDate = Date.parse(new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59));
            }
            var d2 = new Date(); //now
            currentDate = Date.parse(d2);

            if (checkDate < currentDate) return false //past datetime
            else return true; //future datetime
        }

        function getEquipmentForPatient() {
            //.trim().replace(/\s\s+/g, ' ')
            var dataString = $("#pat").val().trim().replace(/\s\s+/g, ' ');

            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getEquipmentForPatient",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                //async: false,
                data: JSON.stringify({ patient: dataString }),
                success: getEquipmentForPatientSuccessCB,
                error: getEquipmentForPatientErrorCB
            });
        }

        function getEquipmentForPatientSuccessCB(data) {
            checkEquipment = [];
            var arr_equipment = JSON.parse(data.d)
            var str = "";
            for (i in arr_equipment) {
                var english = '';
                if (arr_equipment[i] == 'כסא גלגלים') {
                    english = 'Wheelchair';
                }
                else if (arr_equipment[i] == 'כסא תינוק') {
                    english = 'Baby seat';
                }
                else if (arr_equipment[i] == 'קביים') {
                    english = 'Crutches';
                }
                else {
                    english = 'Buster';
                }
                str += arr_equipment[i] + "(" + english + "), ";
                //for check in case of changing anonymous patient
                checkEquipment.push(arr_equipment[i]);
            }
            str = str.substring(0, str.lastIndexOf(", "));
            if (str == "") str = "(None) אין";
            $("#Equipment").text(str);
        }

        function getEquipmentForPatientErrorCB(err) {
            alert("Error in getEquipmentForPatient: " + err.responseText);
        }

        //getEquipment for anonymous patient
        function getEquipmentForAnonymousPatient() {
            //var dataString = document.forms["customerForm"]["pat"].value;
            var dataString = $("#pat").val().trim().replace(/\s\s+/g, ' ');

            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getEquipmentForPatient",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                //async: false,
                data: JSON.stringify({ patient: dataString }),
                success: getEquipmentForAnonymousPatientSuccessCB,
                error: getEquipmentForAnonymousPatientErrorCB
            });
        }

        function getEquipmentForAnonymousPatientSuccessCB(data) {
            checkEquipmentAnonymous = [];
            var arr_equipment = JSON.parse(data.d)
            var str = "";
            for (i in arr_equipment) {
                var english = '';
                if (arr_equipment[i] == 'כסא גלגלים') {
                    english = 'Wheelchair';
                }
                else if (arr_equipment[i] == 'כסא תינוק') {
                    english = 'Baby seat';
                }
                else if (arr_equipment[i] == 'קביים') {
                    english = 'Crutches';
                }
                else {
                    english = 'Buster';
                }
                str += arr_equipment[i] + "(" + english + "), ";
                //for anonymous patient
                checkEquipmentAnonymous.push(arr_equipment[i]);
            }
            str = str.substring(0, str.lastIndexOf(", "));
            if (str == "") str = "(None) אין";
            $("#Equipment").text(str);
        }

        function getEquipmentForAnonymousPatientErrorCB(err) {
            alert("Error in getEquipmentForAnonymousPatient: " + err.responseText);
        }

        function switchDir() {
            var a = $("#Origin").val();
            var b = $("#Destination").val()
            a = a.replace("'", "\\'");
            b = b.replace("'", "\\'");

            $("#Origin option[value ='" + b + "']").prop('selected', true);
            $("#Destination option[value ='" + a + "']").prop('selected', true);
        }

        function loadPage() {
            var userType = GENERAL.USER.getUserType();
            if (userType != "מנהל") {
                $("#coorDiv").hide();
                $("#ph").show();
            } else {
                $("#coorDiv").show();
                $("#ph").hide();
            }
            if (JSON.parse(GENERAL.RIDEPAT.getRidePatList()).length != 0) {
                arr_customer = JSON.parse(GENERAL.RIDEPAT.getRidePatList());
                if (
                    performance.navigation.type == performance.navigation.TYPE_RELOAD
                    &&
                    typeof arr_customer.func === 'undefined'
                ) {
                    alert('נא לשים לב, הדף נטען מחדש ולכן הפעולה הבאה תהיה יצירת הסעה חדשה');
                    arr_customer.func = 'new';
                }
                $("#ridePatNum").attr('disabled', 'disabled');
                $("#coordinator").attr('disabled', 'disabled');
                $("#statusRidePat").attr('disabled', 'disabled');
                $("#Equipment").attr('disabled', 'disabled');
                //console.log('new console -->', arr_customer, hospitals);
                if (arr_customer.func == "edit" || arr_customer.func == "show") {

                    if (localStorage.getItem("duplicateRidePat") != null) {
                        duplicateRidePat = localStorage.getItem("duplicateRidePat");
                        duplicateRidePat = JSON.parse(duplicateRidePat);
                        $('#repeatRide').val(duplicateRidePat.repeatRide);
                        $('#numberOfRides').val(duplicateRidePat.numberOfRides);
                        $("#duplicateRidePat").prop("checked", true);
                        // $('#hideDuplicate').show();
                        

                        localStorage.removeItem("duplicateRidePat");
                    }
                    
                    uploadData_new(arr_customer.RidePatNum);
                    $('#hideDuplicate').hide();
                    $("#hideOnEdit").addClass('duplicateDisplay');

                    if (arr_customer.func == "show") {

                        $("#afterNoon").attr('disabled', 'disabled');
                        $("#pat").attr('disabled', 'disabled');
                        $("#Origin").attr('disabled', 'disabled');
                        $("#remark").attr('disabled', 'disabled');
                        $("#Destination").attr('disabled', 'disabled');
                        $("#dateRide").attr('disabled', 'disabled');
                        $("#hour").attr('disabled', 'disabled');
                        $("#minute").attr('disabled', 'disabled');
                        $("#dirBTN").attr('disabled', 'disabled');
                        $("#patArabic").attr('disabled', 'disabled');
                        $("#saveCustomer").attr('disabled', 'disabled');
                        $("#onlyEscort").prop('disabled', true);

                    }
                }
                else {
                    //console.log( arr_customer, arr_customer.RidePatNum)
                    if (arr_customer.func == 'new' && arr_customer.RidePatNum != undefined) {
                       // uploadData_new(arr_customer.RidePatNum);
                        allowChangeOf_originAndDestination = true;
                        
                        getPatients_slim();
                        generateLocation()
                            .then((result) => {

                                generateHour();
                                generateMinute();
                                generateStatus();
                                getCoor();
                                request2TurnOffLoader([generateLocationPromise, getPatientByIdPromise]);
                                fillPage_withPatientData(arr_customer.Pat);
                            })
                            .catch((err) => {
                                request2TurnOffLoader(generateLocationPromise, getPatientByIdPromise);
                                alert(`בעיה במילוי רשימות יעד ומוצא ${err}`);
                            });
                    }
                    else {
                        //check on בדיקה.
                        $("#afterNoon").attr('disabled', 'disabled');
                        $("#Origin").attr('disabled', 'disabled');
                        $("#remark").attr('disabled', 'disabled');
                        $("#Destination").attr('disabled', 'disabled');
                        $("#dateRide").attr('disabled', 'disabled');
                        $("#hour").attr('disabled', 'disabled');
                        $("#minute").attr('disabled', 'disabled');
                        $("#dirBTN").attr('disabled', 'disabled');
                        $("#patArabic").attr('disabled', 'disabled');
                        //$("#saveCustomer").attr('disabled', 'disabled');
                        getPatients_slim();
                        generateLocation()
                            .then((result) => {

                                generateHour();
                                generateMinute();
                                generateStatus();
                                getCoor();
                                request2TurnOffLoader([generateLocationPromise, getPatientByIdPromise]);
                            })
                            .catch((err) => {
                                request2TurnOffLoader(generateLocationPromise, getPatientByIdPromise);
                                alert(`בעיה במילוי רשימות יעד ומוצא ${err}`);
                            });
                    }



                }
            }

        }

        function showDuplicate() {
            if ($("#duplicateRidePat").is(':checked')) {
                $("#hideDuplicate").removeClass('duplicateDisplay');
            }
            else {
                $("#hideDuplicate").addClass('duplicateDisplay');
            }
        }

        // will needed for later to custom between the object UnityRide to RidePat // Gilad
        const CustomObject = (thisRide) => {

            let CustomObj = {};
            CustomObj.RidePatNum = thisRide[0].Value;
            CustomObj.Status = thisRide[9].Value;
            CustomObj.Remark = thisRide[8].Value;
            CustomObj.OnlyEscort = thisRide[10].Value;
            CustomObj.LastModified = thisRide[11].Value;
            CustomObj.Date = thisRide[7].Value;

            CustomObj.Pat = {};
            CustomObj.Pat.DisplayName = thisRide[1].Value;
            CustomObj.Pat.Id = thisRide[2].Value;
            CustomObj.Pat.DisplayNameA = thisRide[16].Value;
            CustomObj.Pat.EnglishName = thisRide[14].Value;
            CustomObj.Pat.PatientIdentity = thisRide[15].Value;
            CustomObj.Pat.Equipment = thisRide[17].Value;
            CustomObj.Pat.IsAnonymous = thisRide[19].Value;
            isAnonymous = CustomObj.Pat.IsAnonymous

            CustomObj.AmountOfEscorts = thisRide[3].Value;

            CustomObj.Pat.EscortedList = [];
            CustomObj.Escorts = [];
            for (var i = 0; i < thisRide[18].Value.length; i++) {
                let oneEscort = {}
                oneEscort.Id = thisRide[18].Value[i][0].Value;
                oneEscort.DisplayName = thisRide[18].Value[i][1].Value;
                CustomObj.Escorts.push(oneEscort);
            }
            for (var i = 0; i < thisRide[20].Value.length; i++) {
                let oneEscort = {}
                oneEscort.Id = thisRide[20].Value[i][0].Value;
                oneEscort.DisplayName = thisRide[20].Value[i][1].Value;
                CustomObj.Pat.EscortedList.push(oneEscort);
            }

            CustomObj.Drivers = [];
            let Maindriver = {};
            Maindriver.DisplayName = thisRide[13].Value;
            Maindriver.Id = thisRide[12].Value;
            CustomObj.Drivers.push(Maindriver);
            if (Maindriver.Id == null) {
                CustomObj.Drivers = [];
            }

            CustomObj.Destination = {};
            CustomObj.Destination.Name = thisRide[6].Value;
            CustomObj.Origin = {};
            CustomObj.Origin.Name = thisRide[5].Value;

            CustomObj.Pat.Barrier = {}
            CustomObj.Pat.Hospital = {}
            CustomObj.Pat.Barrier.Name = CustomObj.Destination.Name;
            CustomObj.Pat.Hospital.Name = CustomObj.Origin.Name;

            CustomObj.Coordinator = {};
            CustomObj.Coordinator.DisplayName = thisRide[21].Value;
            CustomObj.Coordinator.Id = thisRide[22].Value;

            return CustomObj;
        }


        //Test the New Api for load data in this page
        const Check_test_API = (ridePatNum) => {
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/GetUnityRideToEdit",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                data: JSON.stringify({ UnityRideId: ridePatNum }),
                success: function (data) {
                    let thisRide = JSON.parse(data.d)[0];
                    //console.log('Before Custom', thisRide);
                    thisRide = CustomObject(thisRide);
                    //console.log('After Custom', thisRide);


                },
                error: function (err) {
                    $('#wait').hide();
                    alert("Error in uploadData: " + err.responseText);
                }
            });
        }

        //function to fill form for edit
        async function uploadData_new(ridePatNum) {
            //console.log('Gilad check i just clicked', ridePatNum)
            //  generatePat();
            getPatients_slim();
            generateLocation()
                .then((result) => {

                    generateHour();
                    generateMinute();
                    generateStatus();

                    $('#wait').show();
                    $.ajax({
                        dataType: "json",
                        url: "WebService.asmx/GetUnityRideToEdit",
                        contentType: "application/json; charset=utf-8",
                        type: "POST",
                        data: JSON.stringify({ UnityRideId: ridePatNum }),
                        success: function (data) {


                            
                            let thisRide = JSON.parse(data.d)[0];
                            //console.log('before -->', thisRide)
                            thisRide = CustomObject(thisRide);
                            ridePat = thisRide
                            //console.log('how its need to look like :', ridePat);
                            escorts_inthisRidePat = ridePat.Escorts;



                            GENERAL.RIDEPAT.setRidePatList(JSON.stringify(ridePat));

                            var temp = ridePat.Date.substring(ridePat.Date.indexOf("(") + 1, ridePat.Date.indexOf(")"))
                            var date = new Date(parseInt(temp));
                            day = date.getDay();
                            var dayArr = ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "שבת"];
                            var dayName = dayArr[day];
                            var day = date.getDate();
                            var month = date.getMonth() + 1;
                            var year = date.getFullYear();
                            var hours = date.getHours();
                            var minutes = date.getMinutes();
                            if (hours < 10) hours = "0" + hours;
                            if (minutes < 10) minutes = minutes + "0";
                            if (day < 10) day = "0" + day;
                            if (month < 10) month = "0" + month;
                            date = year + "-" + month + "-" + day;

                            //rdate = ryear + "-" + rmonth + "-" + rday;
                            document.getElementById("dateRide").value = date;

                            if (minutes == "14") {
                                $("#afterNoon").attr('checked', true);

                                checkAfternoon();

                            } else {
                                $("#hour option[value='" + hours + "']").prop('selected', true);
                                $("#minute option[value='" + minutes + "']").prop('selected', true);
                            }
                            if (ridePat.Status != 'ממתינה לשיבוץ') {
                                rideStatusForFields = 1;
                            }

                            //editing anonymous ridepat only if a driver assigned to the ride.
                            if ((ridePat.Pat.IsAnonymous == true) && (ridePat.Status != 'ממתינה לשיבוץ')) {

                                //$("#afterNoon").attr('disabled', 'disabled');
                                $("#Origin").attr('disabled', 'disabled');
                                $("#Destination").attr('disabled', 'disabled');
                                //$("#hour").attr('disabled', 'disabled');
                                //$("#minute").attr('disabled', 'disabled');
                                $("#dateRide").attr('disabled', 'disabled');
                                $("#dirBTN").attr('disabled', 'disabled');
                            }
                            if (ridePat.Pat.IsAnonymous == true) {
                                var area = "";
                                //if(ridePat.Pat.DisplayName.indexOf('מרכז') !== -1){
                                //    area="מרכז";
                                //}
                                //if(ridePat.Pat.DisplayName.indexOf('דרום') !== -1){
                                //    area="דרום";
                                //}
                                //if(ridePat.Pat.DisplayName.indexOf('ירושלים') !== -1){
                                //    area="ירושלים";
                                //}
                                //if(ridePat.Pat.DisplayName.indexOf('צפון') !== -1){
                                //    area="צפון";
                                //}
                                //if (ridePat.Pat.DisplayName.indexOf('ארז') !== -1) {
                                //    area = "ארז";
                                //}
                                //if (ridePat.Pat.DisplayName.indexOf('תרקומיא') !== -1) {
                                //    area = "תרקומיא";
                                //}
                                var origin = ridePat.Origin.Name;
                                var destination = ridePat.Destination.Name;
                                isCenterPoint = true;
                                //getAnonymousPatientsListForArea(origin, destination, area);
                            }
                            //else if (ridePat.Pat.IsAnonymous == "True") {

                            //    var origin = ridePat.Origin.Name;
                            //    var destination = ridePat.Destination.Name;
                            //    generatePatAnonymous(origin, destination);
                            //}

                            if (ridePat.OnlyEscort) $("#onlyEscort").prop('checked', true);
                            $("#ridePatNum").val(ridePat.RidePatNum);


                            RideId = ridePat.RideNum;
                            ridePatId = ridePat.RidePatNum;
                            if (ridePat.Drivers.length > 0) {
                                //$('#Driver').val(ridePat.Drivers[0].Id)

                                var driverIDindex = driversID.indexOf(ridePat.Drivers[0].Id);


                                $('#driver').val(drivers[driverIDindex])
                                currentDriverId = ridePat.Drivers[0].Id;
                                $('#deleteDriver').show();
                            } else {
                                currentDriverId = -1; // There is no driver assigned to the ride

                            }

                            $("#pat").val(ridePat.Pat.DisplayName);
                            existingPatient = ridePat.Pat;
                            existingOrigion = ridePat.Origin;
                            existingDestination = ridePat.Destination;


                            //this ↓ function also among other things draw the patient's escorts checkboxes
                            //console.log('???--> ', ridePat.Pat)
                            fillPage_withPatientData(ridePat.Pat);

                            //this code incharge to mark which escorts to checked in.
                            if (ridePat.Pat.EscortedList.length>0) {
                                for (var i = 0; i < ridePat.Pat.EscortedList.length; i++) {
                                    if (i < ridePat.AmountOfEscorts) {
                                        $(`#escortCB${ridePat.Pat.EscortedList[i].Id}`).prop('checked', true);

                                    }
                                }
                            }



                            //if (typeof arr_escort_inthisRidePat !== "undefined") {

                            //    for (i in arr_escort_inthisRidePat) {
                            //        $(`#escortCB${arr_escort_inthisRidePat[i].Id}`).prop('checked', true);


                            //        //if (ridePat.Pat.IsAnonymous == "True" && (ridePat.Status != 'ממתינה לשיבוץ')) {
                            //        //    var Escorted = new Object();
                            //        //    Escorted = arr_escort[i];
                            //        //    checkEscorts.push(Escorted);
                            //        //}
                            //        //for (j in ridePat.Escorts) {
                            //        //    //if (arr_escort[i].DisplayName == ridePat.Escorts[j].DisplayName) {
                            //        //    //CHECK THIS XXXXXXX
                            //        //    if (arr_escort[i].Id == ridePat.Escorts[j].Id) {
                            //        //        $("#escortCB" + arr_escort[i].Id).prop('checked', true);
                            //        //    }
                            //        //}
                            //    }
                            //} else ($("#selectEscort").html("<label data-toggle='tooltip' title='No escorts'>אין מלווים</label>"));

                            //ridePat.Origin.EnglishName = ridePat.Origin.EnglishName.replace("'", "\\'");
                            //$("#selectOrigin option[value='" + ridePat.Origin.EnglishName + "']").prop('selected', true);
                            //ridePat.Destination.EnglishName = ridePat.Destination.EnglishName.replace("'", "\\'");
                            //$("#selectDestination option[value='" + ridePat.Destination.EnglishName + "']").prop('selected', true);
                            ridePat.Origin.Name = ridePat.Origin.Name.replace("'", "\\'");
                            $("#selectOrigin option[value='" + ridePat.Origin.Name + "']").prop('selected', true);
                            ridePat.Destination.Name = ridePat.Destination.Name.replace("'", "\\'");
                            $("#selectDestination option[value='" + ridePat.Destination.Name + "']").prop('selected', true);

                            if (ridePat.Pat.IsAnonymous == true) {
                                currentOrigin = ridePat.Origin.Name;
                                currentDestination = ridePat.Destination.Name;
                            }


                            //$("#dateRide").val(date);


                            $("#coordinator").val(ridePat.Coordinator.DisplayName);

                            $("#remark").val(ridePat.Remark);

                            $("#statusRidePat option[value='" + ridePat.Status + "']").prop('selected', true);
                            //anonymousName = ridePat.Pat.DisplayName;
                            isWaiting = ridePat.Status;
                            if (ridePat.Drivers.length > 0) {
                                driverId = ridePat.Drivers[0].Id;
                            }
                            $('#wait').hide();
                            $('#driversDiv').show();
                            $("#lastModified").val(convertDBDate2FrontEndDate(ridePat.LastModified).toLocaleString('he-IL', { dateStyle: "short", timeStyle: "short" }));

                            rideData = arr_customer.RidePatNum;
                            if (rideData !== 1) {
                                var rideNumber = rideData;

                                var returnDriveExist = false;
                                if ($('#driver').val() != "") {
                                    localStorage.setItem("ReturnRidePatFlag", true);
                                }
                                //tmpOrigin = $('#Origin').val();
                                Pat = { DisplayName: ridePat.Pat.DisplayName, Id: localStorage.PatID };
                                Origin = { Name: ridePat.Destination.Name };
                                Destination = { Name: ridePat.Origin.Name };
                                Coordinator = { DisplayName: ridePat.Coordinator.DisplayName }
                                Remark = ridePat.Remark;
                                Escorts = ridePat.Pat.EscortedList;
                                //↑ even though it is not the most logical thing to do its the best way nowadays
                                var temp = ridePat.Date.substring(ridePat.Date.indexOf("(") + 1, ridePat.Date.indexOf(")"))
                                var date = new Date(parseInt(temp));
                                let now = new Date();
                                if (date.getTime() < now.getTime()) { // getTime converts the timestemp back to int for more accurate evaluate
                                    return;
                                }
                                OnlyEscort = ridePat.OnlyEscort;
                                RidePatBack = {
                                    Pat: Pat, Origin: Origin, Destination: Destination, Coordinator: Coordinator, Remark: Remark, Escorts: Escorts, Date: date, OnlyEscort: OnlyEscort
                                }
                            }
                            /*
                            else {
                                data.d = data.d.toString();
                                var temp = data.d.replace(/(?!^)(\d{2})(?=(?:\d{2})*$)/g, '/$1');
                                //var dateToShow = data.d.replace(;

                                swal(
                                    "خطأ\nשגיאה",
                                    "קיימת כבר הסעה בתאריך " + date + " עם אותו החולה ואותן נקודות האיסוף\nيوجد سفرية بالتاريخ (التاريخ) مع نفس المريض ونفس نقطة الالتقاء",
                                    "warning"
                                );

                            }
                            */
                            request2TurnOffLoader([generateLocationPromise, getPatientByIdPromise]);
                        },
                        error: function (err) {
                            $('#wait').hide();
                            alert("Error in uploadData: " + err.responseText);
                        }
                    });
                })
                .catch((err) => {
                    alert('בעיה במילוי רשימות יעד ומוצא: ' + err);
                });


        }

        //function to fill form for edit
        async function uploadData(ridePatNum) {
            //console.log('Gilad check i just clicked', ridePatNum)
            //  generatePat();
            getPatients_slim();
            generateLocation()
                .then((result) => {

                    generateHour();
                    generateMinute();
                    generateStatus();

                    $('#wait').show();
                    $.ajax({
                        dataType: "json",
                        url: "WebService.asmx/getRidePat",
                        contentType: "application/json; charset=utf-8",
                        type: "POST",
                        data: JSON.stringify({ ridePatNum: ridePatNum }),
                        success: function (data) {




                            ridePat = JSON.parse(data.d);
                            //console.log('how its need to look like :', ridePat);
                            escorts_inthisRidePat = ridePat.Escorts;



                            GENERAL.RIDEPAT.setRidePatList(JSON.stringify(ridePat));

                            var temp = ridePat.Date.substring(ridePat.Date.indexOf("(") + 1, ridePat.Date.indexOf(")"))
                            var date = new Date(parseInt(temp));
                            day = date.getDay();
                            var dayArr = ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "שבת"];
                            var dayName = dayArr[day];
                            var day = date.getDate();
                            var month = date.getMonth() + 1;
                            var year = date.getFullYear();
                            var hours = date.getHours();
                            var minutes = date.getMinutes();
                            if (hours < 10) hours = "0" + hours;
                            if (minutes < 10) minutes = minutes + "0";
                            if (day < 10) day = "0" + day;
                            if (month < 10) month = "0" + month;
                            date = year + "-" + month + "-" + day;

                            //rdate = ryear + "-" + rmonth + "-" + rday;
                            document.getElementById("dateRide").value = date;

                            if (minutes == "14") {
                                $("#afterNoon").attr('checked', true);
                                checkAfternoon();

                            } else {
                                $("#hour option[value='" + hours + "']").prop('selected', true);
                                $("#minute option[value='" + minutes + "']").prop('selected', true);
                            }
                            if (ridePat.Status != 'ממתינה לשיבוץ') {
                                rideStatusForFields = 1;
                            }

                            //editing anonymous ridepat only if a driver assigned to the ride.
                            if ((ridePat.Pat.IsAnonymous == true) && (ridePat.Status != 'ממתינה לשיבוץ')) {

                                //$("#afterNoon").attr('disabled', 'disabled');
                                $("#Origin").attr('disabled', 'disabled');
                                $("#Destination").attr('disabled', 'disabled');
                                //$("#hour").attr('disabled', 'disabled');
                                //$("#minute").attr('disabled', 'disabled');
                                $("#dateRide").attr('disabled', 'disabled');
                                $("#dirBTN").attr('disabled', 'disabled');
                            }
                            if (ridePat.Pat.IsAnonymous == true) {
                                var area = "";
                                //if(ridePat.Pat.DisplayName.indexOf('מרכז') !== -1){
                                //    area="מרכז";
                                //}
                                //if(ridePat.Pat.DisplayName.indexOf('דרום') !== -1){
                                //    area="דרום";
                                //}
                                //if(ridePat.Pat.DisplayName.indexOf('ירושלים') !== -1){
                                //    area="ירושלים";
                                //}
                                //if(ridePat.Pat.DisplayName.indexOf('צפון') !== -1){
                                //    area="צפון";
                                //}
                                //if (ridePat.Pat.DisplayName.indexOf('ארז') !== -1) {
                                //    area = "ארז";
                                //}
                                //if (ridePat.Pat.DisplayName.indexOf('תרקומיא') !== -1) {
                                //    area = "תרקומיא";
                                //}
                                var origin = ridePat.Origin.Name;
                                var destination = ridePat.Destination.Name;
                                isCenterPoint = true;
                                //getAnonymousPatientsListForArea(origin, destination, area);
                            }
                            //else if (ridePat.Pat.IsAnonymous == "True") {

                            //    var origin = ridePat.Origin.Name;
                            //    var destination = ridePat.Destination.Name;
                            //    generatePatAnonymous(origin, destination);
                            //}

                            if (ridePat.OnlyEscort) $("#onlyEscort").prop('checked', true);
                            $("#ridePatNum").val(ridePat.RidePatNum);


                            RideId = ridePat.RideNum;
                            ridePatId = ridePat.RidePatNum;
                            if (ridePat.Drivers.length > 0) {
                                //$('#Driver').val(ridePat.Drivers[0].Id)

                                var driverIDindex = driversID.indexOf(ridePat.Drivers[0].Id);


                                $('#driver').val(drivers[driverIDindex])
                                currentDriverId = ridePat.Drivers[0].Id;
                                $('#deleteDriver').show();
                            } else {
                                currentDriverId = -1; // There is no driver assigned to the ride

                            }

                            $("#pat").val(ridePat.Pat.DisplayName);
                            existingPatient = ridePat.Pat;
                            existingOrigion = ridePat.Origin;
                            existingDestination = ridePat.Destination;


                            //this ↓ function also among other things draw the patient's escorts checkboxes
                            fillPage_withPatientData(ridePat.Pat);

                            //this code incharge to mark which escorts to checked in.
                            if (typeof escorts_inthisRidePat !== "undefined") {

                                for (var i = 0; i < escorts_inthisRidePat.length; i++) {

                                    $(`#escortCB${escorts_inthisRidePat[i].Id}`).prop('checked', true);
                                }
                            }

                            //if (typeof arr_escort_inthisRidePat !== "undefined") {

                            //    for (i in arr_escort_inthisRidePat) {
                            //        $(`#escortCB${arr_escort_inthisRidePat[i].Id}`).prop('checked', true);


                            //        //if (ridePat.Pat.IsAnonymous == "True" && (ridePat.Status != 'ממתינה לשיבוץ')) {
                            //        //    var Escorted = new Object();
                            //        //    Escorted = arr_escort[i];
                            //        //    checkEscorts.push(Escorted);
                            //        //}
                            //        //for (j in ridePat.Escorts) {
                            //        //    //if (arr_escort[i].DisplayName == ridePat.Escorts[j].DisplayName) {
                            //        //    //CHECK THIS XXXXXXX
                            //        //    if (arr_escort[i].Id == ridePat.Escorts[j].Id) {
                            //        //        $("#escortCB" + arr_escort[i].Id).prop('checked', true);
                            //        //    }
                            //        //}
                            //    }
                            //} else ($("#selectEscort").html("<label data-toggle='tooltip' title='No escorts'>אין מלווים</label>"));

                            //ridePat.Origin.EnglishName = ridePat.Origin.EnglishName.replace("'", "\\'");
                            //$("#selectOrigin option[value='" + ridePat.Origin.EnglishName + "']").prop('selected', true);
                            //ridePat.Destination.EnglishName = ridePat.Destination.EnglishName.replace("'", "\\'");
                            //$("#selectDestination option[value='" + ridePat.Destination.EnglishName + "']").prop('selected', true);
                            ridePat.Origin.Name = ridePat.Origin.Name.replace("'", "\\'");
                            $("#selectOrigin option[value='" + ridePat.Origin.Name + "']").prop('selected', true);
                            ridePat.Destination.Name = ridePat.Destination.Name.replace("'", "\\'");
                            $("#selectDestination option[value='" + ridePat.Destination.Name + "']").prop('selected', true);

                            if (ridePat.Pat.IsAnonymous == true) {
                                currentOrigin = ridePat.Origin.Name;
                                currentDestination = ridePat.Destination.Name;
                            }


                            //$("#dateRide").val(date);


                            $("#coordinator").val(ridePat.Coordinator.DisplayName);

                            $("#remark").val(ridePat.Remark);

                            $("#statusRidePat option[value='" + ridePat.Status + "']").prop('selected', true);
                            //anonymousName = ridePat.Pat.DisplayName;
                            isWaiting = ridePat.Status;
                            if (ridePat.Drivers.length > 0) {
                                driverId = ridePat.Drivers[0].Id;
                            }
                            $('#wait').hide();
                            $('#driversDiv').show();
                            $("#lastModified").val(convertDBDate2FrontEndDate(ridePat.LastModified).toLocaleString('he-IL', { dateStyle: "short", timeStyle: "short" }));

                            rideData = arr_customer.RidePatNum;
                            if (rideData !== 1) {
                                var rideNumber = rideData;

                                var returnDriveExist = false;
                                if ($('#driver').val() != "") {
                                    localStorage.setItem("ReturnRidePatFlag", true);
                                }
                                //tmpOrigin = $('#Origin').val();
                                Pat = { DisplayName: ridePat.Pat.DisplayName, Id: localStorage.PatID };
                                Origin = { Name: ridePat.Destination.Name };
                                Destination = { Name: ridePat.Origin.Name };
                                Coordinator = { DisplayName: ridePat.Coordinator.DisplayName }
                                Remark = ridePat.Remark;
                                Escorts = ridePat.Pat.EscortedList;
                                //↑ even though it is not the most logical thing to do its the best way nowadays
                                var temp = ridePat.Date.substring(ridePat.Date.indexOf("(") + 1, ridePat.Date.indexOf(")"))
                                var date = new Date(parseInt(temp));
                                let now = new Date();
                                if (date.getTime() < now.getTime()) { // getTime converts the timestemp back to int for more accurate evaluate
                                    return;
                                }
                                OnlyEscort = ridePat.OnlyEscort;
                                RidePatBack = {
                                    Pat: Pat, Origin: Origin, Destination: Destination, Coordinator: Coordinator, Remark: Remark, Escorts: Escorts, Date: date, OnlyEscort: OnlyEscort
                                }
                            }
                            /*
                            else {
                                data.d = data.d.toString();
                                var temp = data.d.replace(/(?!^)(\d{2})(?=(?:\d{2})*$)/g, '/$1');
                                //var dateToShow = data.d.replace(;

                                swal(
                                    "خطأ\nשגיאה",
                                    "קיימת כבר הסעה בתאריך " + date + " עם אותו החולה ואותן נקודות האיסוף\nيوجد سفرية بالتاريخ (التاريخ) مع نفس المريض ونفس نقطة الالتقاء",
                                    "warning"
                                );

                            }
                            */
                            request2TurnOffLoader([generateLocationPromise, getPatientByIdPromise]);
                        },
                        error: function (err) {
                            $('#wait').hide();
                            alert("Error in uploadData: " + err.responseText);
                        }
                    });
                })
                .catch((err) => {
                    alert('בעיה במילוי רשימות יעד ומוצא: ' + err);
                });


        }

        function return2manageRidePats() {//returnRidePat()
            localStorage.setItem("PatientNameForRide", null);
            location.href = "manageRidePats.html"
        }

        function checkAfternoon() {
            if ($("#afterNoon").is(':checked')) {
                $("#hour").val("");
                $("#minute").val("");
                $("#hour").attr('disabled', true);
                $("#minute").attr('disabled', true);
            } else {
                $("#hour").val("06");
                $("#minute").val("00");
                $("#hour").attr('disabled', false);
                $("#minute").attr('disabled', false);
            }
        }

        function getPatientInformation() {
            var pat = $("#pat").val();
            arr_details = { displayName: pat, func: "edit" };
            GENERAL.PATIENTS.setPatientsList(JSON.stringify(arr_details));
            if (pat.indexOf("אנונימי") != -1) {
                location.href = "anonymousPatientForm.html";
            }
            else location.href = "patientForm.html";
        }

        function generateDrivers() {

            $.ajax({
                dataType: "json",
                url: "WebService.asmx/GetDrivers",
                contentType: "application/json; charset=utf-8",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Content-Encoding", "gzip");
                },
                type: "POST",
                data: JSON.stringify({ isActive: true, isDriving: true }),
                success: function (data) {
                    var arr_drivers = JSON.parse(data.d);
                    arr_drivers.sort();
                    for (i in arr_drivers) {

                        drivers.push(arr_drivers[i].DisplayName)
                        driversID.push(arr_drivers[i].Id)
                    }
                    $('#driver').autocomplete({
                        source: drivers
                    });
                },
                error: function (err) { alert("Error in generateDrivers"); }
            });
        }

        function signDriverToRide() {

            if (userSelected == undefined) {
                return;
            }

            checkNumberOfRides = JSON.parse(localStorage.getItem("numberOfRides", numberOfRides));

            //localStorage.getItem("repeatRide", repeatRide);
            localStorage.removeItem("numberOfRides");
            localStorage.removeItem("repeatRide");

            if (checkNumberOfRides == 1) {
                var request = {
                    ridePatId: ridePatId,
                    userId: userSelected,
                    driverType: "primary"
                };
            }
            else {
                var request = {
                    ridePatId: JSON.parse(localStorage.getItem("ridePatId", ridePatId)),
                    userId: userSelected,
                    driverType: "primary",
                    numberOfRides: checkNumberOfRides,
                    repeatRide: ""
                };
                localStorage.removeItem("ridePatId");
            }
            request.assignedFromAppId = APP_ID;
            var dataString = JSON.stringify(request);
            if (currentDriverId == -1) {
                currentDriverId = userSelected;
                $('#wait').show();

                if (checkNumberOfRides == 1) {
                    $.ajax({ 
                        url: 'WebService.asmx/AssignRideToRidePat',   
                        data: dataString,                          
                        type: 'POST',                             
                        contentType: 'application/json; charset = utf-8', 
                        success: signDriverSuccessCB,                
                        error: signDriverErrorCB
                    }) 
                }
                else {
                    $.ajax({ 
                        url: 'WebService.asmx/AssignMultiRideToRidePat',  
                        data: dataString,                         
                        type: 'POST',                             
                        dataType: 'json',                         
                        contentType: 'application/json; charset = utf-8', 
                        success: signDriverSuccessCB,               
                        error: signDriverErrorCB
                    }) 
                }




            } else {
                if (currentDriverId != userSelected) {
                    if (confirm("האם אתה בטוח שאתה רוצה לשנות את הנהג?")) {
                        $('#wait').show();
                        driverMode = "edit";
                        request = {
                            ridePatId: ridePatId,
                            rideId: RideId,
                            driverId: userSelected
                        }
                        var dataString = JSON.stringify(request);
                        $.ajax({ // ajax call starts
                            url: 'WebService.asmx/LeaveRidePat',   // server side web service method
                            data: dataString,                          // the parameters sent to the server
                            type: 'POST',                              // can be also GET
                            dataType: 'json',                          // expecting JSON datatype from the server
                            contentType: 'application/json; charset = utf-8', // sent to the server
                            success: deleteRideSuccessCB,                // data.d id the Variable data contains the data we get from serverside
                            error: deleteRideErrorCB
                        }) // end of ajax call



                    } else {
                        alert("הנהג לא שונה");
                        //$('#Driver').val(currentDriverId);

                        $('#driver').val(currentDriverId);

                    }
                }
            }


        }

        function signDriverSuccessCB(data) {

            RideId = data.d;
            //console.log(RideId);
            $('#wait').hide();
            swal({
                title: "הנהג התווסף להסעה",
                type: "success",
                timer: 1000,
                showConfirmButton: false
            });

            $('#deleteDriver').show();

        }

        function signDriverErrorCB(err) {
            $('#wait').hide();
            alert("Error signing driver ");
            console.log(err.responseJSON.Message);

        }

        function deleteRideSuccessCB() {
            //if (driverMode == "edit") {
            //    currentDriverId = userSelected;
            //    var request = {
            //        ridePatId: ridePatId,
            //        userId: userSelected,
            //        driverType: "primary",
            //        assignedFromAppId: APP_ID
            //    };

            //    var dataString = JSON.stringify(request);
            //    $.ajax({ // ajax call starts
            //        url: 'WebService.asmx/AssignRideToRidePat',   // server side web service method
            //        data: dataString,                          // the parameters sent to the server
            //        type: 'POST',                              // can be also GET
            //        dataType: 'json',                          // expecting JSON datatype from the server
            //        contentType: 'application/json; charset = utf-8', // sent to the server
            //        success: signDriverSuccessCB,                // data.d id the Variable data contains the data we get from serverside
            //        error: signDriverErrorCB
            //    }) // end of ajax call

            //}
                //$('#Driver').val(0)

                $('#driver').val("")

                $('#wait').hide();
                swal({
                    title: "הנהג נמחק מההסעה בהצלחה",
                    type: "success",
                    timer: 1000,
                    showConfirmButton: false
                });
                $('#deleteDriver').hide();
                currentDriverId = -1;
            

            driverMode = "";

        }

        function deleteRideErrorCB() {
            $('#wait').hide();
            alert("Error deleting driver");

        }

        function deleteDriverFromRide() {
            //userSelected = $('#Driver').val();

            var driverIndex = drivers.indexOf($('#driver').val());
            userSelected = driversID[driverIndex];

            if (confirm("האם אתה בטוח שאתה רוצה למחוק את הנהג מההסעה?")) {
                $('#wait').show();
                driverMode = "delete";
                deleteDriverFlag = true;
                request = {
                    UnityRideId: ridePatId,
                    isDelete: true,
                    DriverId: userSelected
                }
                var dataString = JSON.stringify(request);
                $.ajax({ // ajax call starts
                    url: 'WebService.asmx/AssignUpdateDriverToUnityRide',   // server side web service method
                    data: dataString,                          // the parameters sent to the server
                    type: 'POST',                              // can be also GET
                    dataType: 'json',                          // expecting JSON datatype from the server
                    contentType: 'application/json; charset = utf-8', // sent to the server
                    success: deleteRideSuccessCB,                // data.d id the Variable data contains the data we get from serverside
                    error: deleteRideErrorCB
                }) // end of ajax call
            } else {

            }
        }

        function createNewRide() {

            let ridepat = JSON.parse(GENERAL.RIDEPAT.getRidePatList());
            ridePat = { ...ridePat, func: 'new' }
            GENERAL.RIDEPAT.setRidePatList(JSON.stringify(ridePat));
           
            location.reload();
            $('#wait').show();

        }

        const isThisAReturnDriveFunc = (ride) => {
            if (hospitals.includes(ride.Origin.Name)) {
                isThisAReturnDrive = true;
               
            }
            return isThisAReturnDrive;

        }


        function createReturnRide() {

            isThisAReturnDrive = true;
            localStorage.setItem("ReturnRidePatFlag", true);

            returnRide();
            $("#afterNoon").attr('checked', 'checked');
            $("#afterNoon").prop('disabled', false);
            checkAfternoon();

            dateForReturnRepeat = localStorage.getItem("dateForReturnRepeat");
            localStorage.removeItem("dateForReturnRepeat");
            $("#dateRide").val(dateForReturnRepeat)

            $('#driver').val(""); // clearing the value of this input for avoiding mistakes
            $('#saveCustomer').addClass("saveHighlight");

            CoordinatorForReturn = $("#coordinator").val();

            $('#Modal').modal('hide');
        }

        const editThisRide = () => {
            x_wasClicked = true;
            arr_customer.func = 'edit';

            //hide the multiples rides elements
            $("#hideOnEdit").addClass('duplicateDisplay');
            $("#hideDuplicate").addClass('duplicateDisplay');

            //init multiple rides back to 1
            $("#numberOfRides").val(1);

        }

        const request2TurnOffLoader = (promises2wait4) => {
            promises2wait4.map((p) => {
                if (typeof p === 'undefined') {
                    return;
                }
            })
            Promise.all(promises2wait4).then(function () {
                $('#wait').hide();
            }, function (err) {
                $('#wait').hide();
            });
        }

    </script>
</head>
<body class="fixed-left">

    <!-- Begin page -->
    <div id="wrapper">

        <!-- Top Bar Start -->
        <div class="topbar">



            <!-- Navbar -->
            <div id="na" class="navbar navbar-default" role="navigation">
                <div class="container">
                    <div class="">
                        <!--Expend/Collaps Side Menue-->
                        <div class="pull-left">
                            <button class="button-menu-mobile open-left waves-effect">
                                <i class="md md-menu"></i>
                            </button>
                            <span class="clearfix"></span>
                        </div>

                        <!-- LOGO -->
                        <div class="pull-left">
                            <div class="text-center">
                                <a href="manageRidePats.html" class="logo"><span>בדרך להחלמה</span>&nbsp&nbsp&nbsp</a>
                            </div>
                        </div>
                        <div class="pull-right">
                            <span class="logo" id="userName"></span>
                        </div>
                    </div>
                    <!--/.nav-collapse -->
                </div>
            </div>
        </div>
        <!-- Top Bar End -->
        <!-- ========== Right Sidebar Start ========== -->
        <div id="menuType"></div>
        <!-- Right Sidebar End -->
        <!-- ============================================================== -->
        <!-- Start page Content here -->
        <!-- ============================================================== -->
        <div class="content-page">
            <!-- Start content -->
            <div class="content">
                <div class="container">
                    <!-- Page-Title -->
                    <form class="form-horizontal" role="form" id="customerForm">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="page-title-box">
                                    <ol class="breadcrumb pull-right">
                                        <li><a href="viewRidePats.html">כל ההסעות</a></li>
                                        <li data-toggle="tooltip" title="Ride   توصيل المريض" class="active">הסעת חולה</li>
                                    </ol>
                                    <h4 class="page-title">הסעת חולה&nbsp&nbsp<i data-toggle="tooltip" title="Ride   توصيل المريض" class="md md-recent-actors"></i></h4>
                                </div>
                            </div>
                        </div>
                        <div class="row">

                            <div class="col-sm-12">
                                <div class="card-box">
                                    <div class="row">
                                        <h4 class="m-t-0 header-title"><b data-toggle="tooltip" title="Ride   توصيل المريض">הסעת חולה</b></h4>

                                        <div class="text-right m-b-30 m-r-15">
                                            <button type="button" onclick="return2manageRidePats()" class="btn btn-default waves-effect w-md m-b-5"><i data-toggle="tooltip" data-placement="bottom" title="عودة  Back" class="ti-back-right m-r-5"></i>&nbsp חזרה</button>
                                            <div id="patientInfo"> <button type="button" onclick="getPatientInformation()" dir="ltr" class="btn btn-info waves-effect w-md m-b-5"><i data-toggle="tooltip" data-placement="bottom" title="Patient info" class="ti-info m-r-5"></i>&nbsp Patient information</button></div>
                                        </div>
                                        <p class="required"><span data-toggle="tooltip" title="Must field   حقل اجباري">* שדה חובה</span></p>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Patient's Name   اسم المريض" class="col-sm-2 control-label">שם החולה&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6 ui-widget" id="selectPat">
                                                        <input type="text" id="pat" name="pat" class="form-control">
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <input type="checkbox" id="onlyEscort" />
                                                        <label data-toggle="tooltip" title="Company only   سفر للمرافقين فقط" for="onlyEscort">נסיעה למלווים בלבד</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label id="statuslabelRidePat" data-toggle="tooltip" title="Status   حالة السفرية" class="col-sm-2 control-label">סטטוס</label>
                                                    <div class="col-sm-6" id="selectstatusRidePat">
                                                        <select id="statusRidePat" name="statusRidePat" class="form-control"><option>בחר סטטוס נסיעה</option></select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Patient's English Name   اسم المريض" class="col-sm-2 control-label">שם החולה באנגלית&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6 ui-widget" id="selectEnglishPat">
                                                        <input type="text" id="patEnglishName" name="pat" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Patient ID" class="col-sm-2 control-label">תעודת זהות&nbsp;</label>
                                                    <div class="col-sm-6 ui-widget" id="selectPatId">
                                                        <input type="text" id="PatientIdentity" name="PatientIdentity" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">اسم المريض</label>
                                                    <div class="col-sm-6 ui-widget" id="selectPat">
                                                        <input type="text" id="patArabic" name="patArabic" class="form-control"></input>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Select Origin   اختر نقطة الانطلاق" class="col-sm-2 control-label">מוצא&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6" id="selectOrigin">
                                                        <select id="Origin" name="Origin" class="form-control"><option>בחר מוצא</option></select>
                                                        <input data-toggle="tooltip" title="Change Direction   تغيير اتجاه/ وجهة" id="dirBTN" type="button" value="שינוי כיוון" onclick="switchDir()" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <div class="form-group" id="escortDiv">
                                                    <label data-toggle="tooltip" title="Patient escorts" class="col-sm-2 control-label">מלווים</label>
                                                    <div class="col-sm-6" id="selectEscort">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Destination   نقطة الوصول" class="col-sm-2 control-label">יעד&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6" id="selectDestination">
                                                        <select id="Destination" name="Destination" class="form-control"><option>בחר יעד</option></select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Equipment   غرض مرافق" class="col-sm-2 control-label">
                                                        ציוד נלווה
                                                    </label>
                                                    <div class="col-sm-6" id="selectaddition">
                                                        <label id="Equipment" name="Equipment" class="control-label" />
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-sm-6">
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="driverResponsibilityEquipment   غرض مرافق" class="col-sm-2 control-label">
                                                        ציוד נלווה באחריות הנהג
                                                    </label>
                                                    <div class="col-sm-6">
                                                        <label id="driverResponsibilityEquipment" class="control-label" />
                                                    </div>
                                                </div>
                                            </div>


                                        </div>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="ملاحظات   Notes" class="col-sm-2 control-label">הערות</label>
                                                    <div class="col-sm-6">
                                                        <input id="remark" name="remark" type="text" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Time  ساعة السفر" class="col-sm-2 control-label">שעת הסעה&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6" id="selecthour">
                                                        <select id="minute" name="minute" class="form-control" style="width:33%;display:inline"><option>דקות</option></select>
                                                        <p style="display:inline;">:</p>
                                                        <select id="hour" name="hour" class="form-control" style="width:33%; display:inline;"><option>שעות</option></select>
                                                        <br />
                                                        <br />
                                                        <input type="checkbox" id="afterNoon" onchange="checkAfternoon()" />
                                                        <label data-toggle="tooltip" title="or afternoon  او بالمساء" for="afterNoon">או אחה"צ</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">

                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Ride #number  رقم السفرية" class="col-sm-2 control-label">מספר הסעה</label>
                                                    <div class="col-sm-6">
                                                        <input id="ridePatNum" name="ridePatNum" type="text" class="form-control">
                                                        <br />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <!--HERE!-->
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Last modified" class="col-sm-2 control-label">עודכן לאחרונה</label>
                                                    <div class="col-sm-6">
                                                        <input id="lastModified" name="lastModified" type="text" class="form-control" disabled>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6" id="coorDiv">
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">רכז</label>
                                                    <div class="col-sm-6" id="selectCoordinator">
                                                        <input type="text" id="coordinator" name="coordinator" class="form-control">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Date  تاريخ السفر" class="col-sm-2 control-label">תאריך הסעה&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6">
                                                        <!--<input type="text" class="form-control" placeholder="dd/mm/yyyy" id="dateRide" name="dateRide">-->
                                                        <input type="date" class="form-control" placeholder="dd/mm/yyyy" id="dateRide" name="dateRide" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--<div class="row m-l-10 m-r-10">

                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">מספר הסעה</label>
                                                    <div class="col-sm-6">
                                                        <input id="ridePatNum" name="ridePatNum" type="text" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                            </div>
                                        </div>-->
                                        <!--duplicate ride section-->
                                        <div class="row m-l-10 m-r-10" id="hideOnEdit">
                                            <div class="col-sm-6">
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <div id="duplicate" class="col-sm-6">
                                                        <input type="checkbox" id="duplicateRidePat" onchange="showDuplicate()" />
                                                        <label data-toggle="tooltip" title="Recurring ride?  سفريات عائدة" for="duplicateRidePat"> הסעה חוזרת?</label>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>

                                        <div class="row m-l-10 m-r-10 duplicateDisplay" id="hideDuplicate">
                                            <div class="col-md-6"></div>
                                            <div class="col-sm-3">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Scheduling جدولة" class="col-sm-2 control-label">תזמון</label>
                                                    <select id="repeatRide" name="repeatRide" class="form-control" style="width:80%;display:inline">
                                                        <option data-toggle="tooltip" title="Every week on this day كل اسبوع">כל שבוע</option>
                                                        <option data-toggle="tooltip" title="Successive days عدة ايام متتالية">מספר ימים ברצף</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-sm-2" id="coorDiv">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Number of times عدة مرات" class="col-sm-4 control-label">מספר פעמים</label>
                                                    <div class="col-sm-6" id="selectCoordinator">
                                                        <input type="number" max="30" min="0" id="numberOfRides" name="numberOfRides" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="wait" style="display:none;width:69px;height:89px;position:absolute;top:50%;left:50%;padding:2px;">
                                <img src="../../Media/Wedges-3s-200px.gif" width="64" height="64" />
                            </div>

                            <!--</form>-->

                        </div>

                        <!--XXXXX-->

                        <div class="row" id="driversDiv">
                            <!--<form class="form-horizontal" role="form" id="driverForm">-->
                            <div class="col-sm-12">
                                <!--<hr />-->
                                <div class="card-box">
                                    <div class="row" id="flashDiv">
                                        <!--<h4 class="m-t-0 header-title"><b>נהג בנסיעה</b></h4>-->

                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">נהג בנסיעה&nbsp;</label>
                                                    <div class="col-sm-6" id="selectDriver">
                                                        <!--<select id="Driver" class="form-control"><option value="0">בחר נהג</option></select>-->
                                                        <input placeholder="הזן שם" type="text" id="driver" name="driver" class="form-control ui-autocomplete-input" autocomplete="off" aria-required="true" aria-invalid="false">
                                                    </div>
                                                </div>

                                            </div>
                                            <div class="col-sm-6">

                                                <!--<input type="button" onclick="signDriverToRide()" id="saveDriver" class="btn btn-success w-md waves-light m-b-5 m-r-15" value="Save Driver" />-->
                                                <input type="button" onclick="deleteDriverFromRide()" id="deleteDriver" class="btn btn-danger w-md waves-light m-b-5 m-r-15" value="הסרת נהג" />

                                                <!--<div class="form-group" id="escortDiv">
                                                    <label data-toggle="tooltip" title="Patient escorts" class="col-sm-2 control-label">מלווים</label>
                                                    <div class="col-sm-6" id="selectEscort">
                                                    </div>
                                                </div>-->
                                            </div>

                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <!--<hr />-->
                            <div class="text-right m-r-15 row">
                                <div class="col-sm-12">
                                    <button data-toggle="tooltip" title="" type="submit" id="saveCustomer" class="btn btn-success waves-effect w-md waves-light m-b-5" data-original-title="Save  حفظ"><i class="ti-save m-r-5"></i>&nbsp; שמירה</button>
                                </div>
                                <div class="col-sm-12">

                                    <button type="button" onclick="return2manageRidePats()" class="btn btn-default waves-effect w-md m-b-5"><i data-toggle="tooltip" data-placement="bottom" title="" class="ti-back-right m-r-5" data-original-title="عودة  Back"></i>&nbsp; חזרה</button>
                                </div>

                            </div>
                        </div>
                        <!--<div class="row m-l-10 m-r-10">
                            <div class="col-sm-12 text-center">
                                <button type="button" onclick="return2manageRidePats()" class="btn btn-default waves-effect w-md m-b-5"> חזרה&nbsp<i class="ti-back-right m-r-5"></i></button>
                            </div>
                            <div class="col-sm-12 text-center">
                                <button type="button" onclick="return2manageRidePats()" class="btn btn-default waves-effect w-md m-b-5"><i data-toggle="tooltip" data-placement="bottom" title="" class="ti-back-right m-r-5" data-original-title="عودة  Back"></i>&nbsp; חזרה</button>
                            </div>
                        </div>-->

                    </form>




                </div>

            </div>
            <!-- Modal -->
            <!--<div class="modal fade text-center" id="IgulModal" tabindex="-1" role="dialog" aria-labelledby="IgulModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title" id="exampleModalLabel">תודה רבה</h2>
                            <h3>הפרטים נשמרו</h3>

                        </div>
                        <div class="modal-body">
                            <div class="row m-l-10 m-r-10">
                                <div class="col-sm-12 text-center">

                                    <h4>
                                        האם תהיה מעוניין ליצור נסיעת חזרה?
                                    </h4>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <div class="col-sm-12 text-center">
                                <button type="button" class="btn btn-primary" onclick="goToIgul()">כן</button>
                                <button type="button" class="btn btn-secondary" onclick="reload()">לא</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>-->
            <!-- end container -->
        </div>
        <!-- end content -->
        <!-- FOOTER -->
        <footer id="rights" data-toggle="tooltip" data-placement="top" title="© All rights reserved The Road to Recovery.  جميع الحقوق محفوظة لجمعية الطريق الى الشفاء" class="footer text-right">
        </footer>
        <!-- End FOOTER -->
    </div>
    <!-- END wrapper -->
    <div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="ModalTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" id="modal_x" class="close" data-dismiss="modal" aria-label="Close" onclick="editThisRide()">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h1 class="modal-title centerHeader" id="ModalTitle">הנסיעה נשמרה</h1>

                </div>
                <div class="modal-body">
                    <h3 class="centerHeader">להמשך, בחר.י:</h3>
                    <!-- <h4 class="centerHeader">(אפשר לשנות פרטים בהחזרה, ובסוף יש להקיש על מקש שמירה)</h4>-->
                </div>
                <div id="modalButtons" class="modal-footer centerHeader">
                    <button onclick="createNewRide()" class="btn btn-success waves-effect w-md m-b-5 sameWidthBtn">יצירת הסעה חדשה</button>
                    <button onclick="return2manageRidePats()" class="btn btn-default waves-effect w-md m-b-5 sameWidthBtn">חזרה לניהול ההסעות <i class="ti-back-right m-r-5"></i></button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

