<!DOCTYPE html>

<html lang="en" dir=rtl>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="description" content="KSMoving">
    <meta name="author" content="Coderthemes">

    <link rel="shortcut icon" href="assets/images/favicon_1.ico">

    <title>הסעת חולה</title>

    <link href="../plugins/switchery/swiFtchery.min.css" rel="stylesheet" />
    <link href="assets/css/bootstrap-rtl.min.css" rel="stylesheet" type="text/css">
    <link href="assets/css/core.css" rel="stylesheet" type="text/css">
    <link href="assets/css/icons.css" rel="stylesheet" type="text/css">
    <link href="assets/css/components.css" rel="stylesheet" type="text/css">
    <link href="assets/css/pages.css" rel="stylesheet" type="text/css">
    <link href="assets/css/menu.css" rel="stylesheet" type="text/css">
    <link href="assets/css/responsive.css" rel="stylesheet" type="text/css">

    <script src="assets/js/CookiesFunctions.js"></script>

    <script src="assets/js/modernizr.min.js"></script>

    <script src="assets/js/jquery.min.js"></script>

    <!-- The jQuery library is a prerequisite for all jqSuite products -->
    <script type="text/ecmascript" src="assets/js/jquery.min.js"></script>
    <!-- This is the Javascript file of jqGrid -->
    <script type="text/ecmascript" src="Guriddo_jqGrid_JS_5.2.0/js/jquery.jqGrid.min.js"></script>
    <!-- We support more than 40 localizations -->
    <script type="text/ecmascript" src="Guriddo_jqGrid_JS_5.2.0/js/i18n/grid.locale-he.js"></script>
    <!-- A link to a Boostrap  and jqGrid Bootstrap CSS siles-->
    <link href="Guriddo_jqGrid_JS_5.2.0/css/ui.jqgrid-bootstrap.css" rel="stylesheet" />

    <!-- Sweet Alert css -->
    <link href="../plugins/bootstrap-sweetalert/sweet-alert.css" rel="stylesheet" type="text/css" />

    <!--GENERAL object and additional functions-->
    <script src="lib/lz-string.js"></script>
    <script src="lib/master.js"></script>

    <!-- Select2 css+js -->
    <link href="assets/css/select2.css" rel="stylesheet" />
    <script src="assets/js/select2.min.js"></script>

    <!--DatePicker css+js-->
    <!--<link href="../plugins/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">
    <link href="../plugins/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <script src="../plugins/moment/moment.js"></script>
    <script src="../plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="../plugins/bootstrap-daterangepicker/daterangepicker.js"></script>-->
    <!--timePicker css+js-->
    <!--<link href="../plugins/timepicker/bootstrap-timepicker.min.css" rel="stylesheet" />
    <script src="../plugins/timepicker/bootstrap-timepicker.min.js"></script>-->
    <!--Patient Autocomplete-->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <style>
        .ui-autocomplete {
            max-height: 100px;
            overflow-y: auto;
            /* prevent horizontal scrollbar */
            overflow-x: hidden;
        }
        /* IE 6 doesn't support max-height
        * we use height instead, but this forces the menu to always be this tall
        */
        * html .ui-autocomplete {
            height: 100px;
        }

        input[type=text]:focus {
            background-color: #FFE684;
        }

        .duplicateDisplay {
            display: none;
        }

        .duplicateDisplayOnShow {
            background-color: #F8F8B5
        }

        input[type=text], input[type=checkbox], input[type=date], #statusRidePat, #Origin, #Destination, #hour, #minute {
            border-color: #000
        }
    </style>
    <!--<script src="https://code.jquery.com/jquery-1.12.4.js"></script>-->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>
        var resizefunc = [];
    </script>

    <!--Validators-->
    <script src="../plugins/jquery-validation/dist/jquery.validate.min.js"></script>


    <!-- jQuery  -->
    <script src="assets/js/bootstrap-rtl.min.js"></script>
    <script src="assets/js/detect.js"></script>
    <script src="assets/js/fastclick.js"></script>
    <script src="assets/js/jquery.slimscroll.js"></script>
    <script src="assets/js/jquery.blockUI.js"></script>
    <script src="assets/js/waves.js"></script>
    <script src="assets/js/wow.min.js"></script>
    <script src="assets/js/jquery.nicescroll.js"></script>
    <script src="assets/js/jquery.scrollTo.min.js"></script>
    <script src="../plugins/switchery/switchery.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>

    <!-- Sweet Alert js -->
    <script src="../plugins/bootstrap-sweetalert/sweet-alert.min.js"></script>
    <script src="assets/pages/jquery.sweet-alert.init.js"></script>

    <script src="assets/js/jquery.core.js"></script>
    <script src="assets/js/jquery.app.js"></script>
    <!--<script src="lib/datepicker-he.js"></script>-->
    <script src="lib/includeHTML.js"></script>
    <script>
        //1.בהסעה חדשה רק שדה שם חולה הוא write, אחרי שמזינים אותו הכל נפתח.
        checkCookie();
        arr_addressRows = [];
        $.jgrid.defaults.responsive = true;
        $.jgrid.defaults.styleUI = 'Bootstrap';
        var currentOrigin = '';
        var currentDestination = '';
        var spaceInCar;
        var isWaiting = "";
        var checkEscorts = [];
        var checkEquipment = [];
        var checkEquipmentAnonymous = [];
        var anonymousName = "";
        var isAnonymous = false;
        var isAssistant = false;
        var driverId;
        var dateForPush = "";
        var hourForPush = "";
        var pushMsg = "";
        var arr_for_assistant = [];
        var patientsAssistent=[];
        var arr_arabNamesAssistent=[];
        var arr_englishNamesAssistent = [];
        var patientsAssistentDisplay = [];
        var patientsIdentityAssistent = [];
        var isCenterPoint = false;
        var isCenterPatient = false;
        var isRegularPatientNoCenter = false;
        //0 means no driver is asigned to the ride
        var rideStatusForFields = 0;
        $(document).ready(function () {
            $('#wait').hide();
            var pat = $("#pat").val();
            if (pat === "") {
                $("#patientInfo").hide();
            }
            isAssistant = JSON.parse(GENERAL.USER.getIsAssistant());
            console.log(isAssistant);
            var assistantName = "";
            if (isAssistant) {
                $("#menuType").attr("w3-include-html", "HelperMenu.html");
                $("#duplicate").hide();
                $("#selectstatusRidePat").hide();
                $("#statuslabelRidePat").hide();
                var coorAssistant = GENERAL.USER.getCoorAssistant();
                assistantName = GENERAL.USER.getAsistantDisplayName();
            }
            else $("#menuType").attr("w3-include-html", "menu.html");
            includeHTML();
            $('[data-toggle="tooltip"]').tooltip();
            if (window.location.hostname.toString() == 'localhost' || window.location.pathname.indexOf('test') != -1) {
                $("#na").css("background-color", "#ffde89");
            }
            if (window.location.href.indexOf('http://40.117.122.242/Road%20to%20Recovery/') != -1) {
                window.location.href = "notAvailable.html";
            }
            if(isAssistant){
                var userName = GENERAL.USER.getAsistantAndCoorDisplayName();
                $("#userName").html(userName);
            }
            else{
                var userName = GENERAL.USER.getUserDisplayName();
                $("#userName").html(userName);
            }
            //datePicker();
            loadPage();
            $("#pat").blur(function () {
                fillData();
            });

            $("#pat").keyup(function () {
                $("#patEnglishName").val("");
                $("#patArabic").val("");
                $("#PatientIdentity").val("");
            });

            $("#patArabic").blur(function () {
                fillData();
            });

            $("#patArabic").keyup(function () {
                $("#pat").val("");
                $("#patEnglishName").val("");
                $("#PatientIdentity").val("");
            });

            $("#patEnglishName").blur(function () {
                fillData();
            });

            $("#patEnglishName").keyup(function () {
                $("#pat").val("");
                $("#patArabic").val("");
                $("#PatientIdentity").val("");
            });
            $("#PatientIdentity").blur(function () {
                fillData();
            });

            $("#PatientIdentity").keyup(function () {
                $("#pat").val("");
                $("#patEnglishName").val("");
                $("#patArabic").val("");
            });
          
            if (JSON.parse(localStorage.getItem("PatientNameForRide")) !== null) {
                $("#pat").val(JSON.parse(localStorage.getItem("PatientNameForRide")));
                fillData();
                localStorage.setItem("PatientNameForRide", null);
            }

            // DO NOT REMOVE : GLOBAL FUNCTIONS!
            var errorClass = 'invalid';
            var errorElement = 'em';
            var $serviceForm = $('#customerForm').validate({

                highlight: function (element) {
                    jQuery(element).closest('.form-group').addClass('has-error');
                },
                unhighlight: function (element) {
                    jQuery(element).closest('.form-group').removeClass('has-error');
                },

                // Rules for form validation
                rules: {
                    dateRide: {
                        required: true
                    },
                    pat: {
                        required: true
                    },
                    //patArabic: {
                    //    required: true
                    //},
                    Origin: {
                        required: true
                    },
                    Destination: {
                        required: true
                    },
                    coordinator: {
                        required: true
                    },
                },
                submitHandler: function (form, event) {
                    event.preventDefault();
                    var valid = validateInputs();
                    if (!valid) return false;
                    var numberOfRides = 1;
                    var repeatRide = "";
                    if (anonymousName == "True") {
                        isAnonymous = true;
                    }
                    if ($("#duplicateRidePat").is(':checked')) {
                        numberOfRides = parseInt($("#numberOfRides").val());
                        repeatRide = $("#repeatRide").val();
                    }
                    if (numberOfRides > 1) {
                        var validRides = PrintRides(repeatRide,numberOfRides);
                        if (!validRides) return false;
                    }


                    var RidePatNum = $("#ridePatNum").val();
                    var Pat = new Object();
                    Pat.DisplayName = $("#pat").val();
                    Pat.DisplayName = Pat.DisplayName.replace(/\s\s+/g, ' ');
                    Pat.Id = localStorage.PatID;
                    var Origin = new Object();
                    Origin.Name = $("#Origin").val();
                    var Destination = new Object();
                    Destination.Name = $("#Destination").val();
                    var Remark = $("#remark").val();
                    var dateRide = $("#dateRide").val();
                    var hours = $("#hour").val();
                    var minutes = $("#minute").val();
                    //dateRide + " " + hours + ":" + minutes;
                    var Day = parseInt(dateRide.substring(8));
                    var Month = parseInt(dateRide.substring(5, 7)) - 1;
                    var Year = parseInt(dateRide.substring(0, 4));
                    dateForPush = Day+"/"+Month+"/"+Year;
                    var Hour = parseInt(hours);
                    var Minute = parseInt(minutes);
                    hourForPush = hours + ":" + minutes;
                    if ($("#afterNoon").is(':checked')) { //22:14 is the default time that means afternoon אחה''צ
                        Hour = 22;
                        Minute = 14;
                        hourForPush="אחה\"צ"
                    }
                    var date = new Date(Year, Month, Day, Hour, Minute);
                    var func = arr_customer.func;
                    var Coordinator = new Object();
                    Coordinator.DisplayName = $("#coordinator").val();
                    var OnlyEscort = false;
                    if ($("#onlyEscort").is(':checked')) {
                        OnlyEscort = true;
                    }


                    //set Escorts
                    var selected = [];
                    $('#selectEscort input:checked').each(function () {
                        selected.push($(this).attr('name'));
                    });


                    var Escorts = [];
                    for (i in arr_escort) {
                        for (j in selected) {
                            if (arr_escort[i].DisplayName.replace("'", "") == selected[j]) {
                                var Escorted = new Object();
                                Escorted = arr_escort[i];
                                Escorts.push(Escorted);
                            }
                        }
                    }



                    //in case of different equipment than declared for anonymous ridepat.
                    var str = "";
                    if (func == "edit" && anonymousName == "True" && isWaiting != "ממתינה לשיבוץ") {
                        if (checkEquipment.length < checkEquipmentAnonymous.length) {
                            alert("ירד ציוד מההסעה");
                        }
                        if (checkEquipment.length >= checkEquipmentAnonymous.length) {
                            for (var j = 0; j < checkEquipmentAnonymous.length; j++) {
                                for (var i = 0; i < checkEquipment.length; i++) {
                                    if (checkEquipment[i] == checkEquipmentAnonymous[j]) {
                                        continue;
                                    }
                                    str += checkEquipment[i] + ", ";
                                }
                            }
                            var answer = confirm("ציוד " + str + " נוסף לנסיעה\n האם להמשיך בעריכה? ");
                            if (!answer) {
                                location.href = "manageRidePats.html";
                                return false;
                            }
                        }
                    }

                    //in case of more escorts than declared for anonymous ridepat.
                    if (func == "edit" && (anonymousName == "True" || isAssistant) && isWaiting != "ממתינה לשיבוץ") {
                        if (checkEscorts.length < Escorts.length) {
                            genarteAvailbaleSeats();
                            checkSpaceInCar = spaceInCar + checkEscorts.length - Escorts.length;
                            if (checkSpaceInCar > Escorts.length) {
                                var numberOfAddedEscorts = Escorts.length - checkEscorts.length;

                                var answer = confirm("נוספו מלווים להסעה, מספר המלווים שנוספו הוא: " + numberOfAddedEscorts + ", למרות זאת, יש עדיין מקום ברכב המתנדב. האם תרצה להמשיך בעריכה? ");
                                if (!answer) {
                                    location.href = "manageRidePats.html";
                                    return false;
                                }
                            }
                            else {
                                var numberOfAddedEscorts = Escorts.length - checkEscorts.length;
                                var numberOfSeatsAv = spaceInCar + checkEscorts.length;
                                if (isAssistant) {
                                    swal({
                                        title: "Can't add escorts to the ride, not enough space in the driver car.",
                                        type: "warning",
                                        showConfirmButton: true
                                    });
                                    return false;
                                }
                                else {
                                    var answer = confirm(" נוספו " + numberOfAddedEscorts + " מלווים. מספר המקומות הפנויים ברכב הוא: " + numberOfSeatsAv + " האם תרצה להמשיך בעריכה?");
                                    if (!answer) {
                                        location.href = "manageRidePats.html";
                                        return false;
                                    }
                                }
                            }
                        }
                    }

                    if (func == "new") {
                        RidePat = {
                            Pat: Pat, Origin: Origin, Destination: Destination, Coordinator: Coordinator, Remark: Remark, Escorts: Escorts, Date: date, OnlyEscort: OnlyEscort
                        }
                        var userName = GENERAL.USER.getAsistantDisplayName();
                        pushMsg = "העוזר " + userName + " הקים נסיעה חדשה עם החולה " + $("#pat").val() + " בתאריך " + dateForPush + " בשעה " + hourForPush+" מ"+$("#Origin").val()+" ל"+$("#Destination").val();

                    }
                    else {
                        RidePat = {
                            RidePatNum: RidePatNum, Pat: Pat, Origin: Origin, Destination: Destination, Coordinator: Coordinator, Date: date, Remark: Remark,
                            Escorts: Escorts, OnlyEscort: OnlyEscort
                        }
                    }
                    var request = { RidePat: RidePat, func: func, isAnonymous: isAnonymous, numberOfRides: numberOfRides, repeatRideEvery: repeatRide }
                    var dataString = JSON.stringify(request);
                    localStorage.setItem("PatientNameForRide", null);
                    $.ajax({
                        dataType: "json",
                        url: "WebService.asmx/setRidePat",
                        contentType: "application/json; charset=utf-8",
                        type: "POST",
                        async: false,
                        data: dataString,
                        success: function (data) {
                            //SaveAddresses(0, numberOfRecords, customerID);
                            console.log(data.d);
                            if (data.d !== 1) {
                                swal({
                                    title: "נשמר\nلقت تمت عملية الحفظ",
                                    type: "success",
                                    timer: 1000,
                                    showConfirmButton: false
                                });
                                setTimeout(function () { returnRidePat() }, 1001);
                                if (isAssistant && pushMsg!=="") {
                                    //send messege to coordinator from assistant on new ridepat creation.
                                    sendMessegeFromAssistant(data.d, pushMsg);
                                }
                            }
                            else {
                                data.d = data.d.toString();
                                var temp = data.d.replace(/(?!^)(\d{2})(?=(?:\d{2})*$)/g, '/$1');
                                //var dateToShow = data.d.replace(;
                                
                                swal(
                                    "خطأ\nשגיאה",
                                    "קיימת כבר הסעה בתאריך " +date + " עם אותו החולה ואותן נקודות האיסוף\nيوجد سفرية بالتاريخ (التاريخ) مع نفس المريض ونفس نقطة الالتقاء",
                                    "warning"
                                );
                            }

                        },
                        error: function (err) {
                            swal(
                                "خطأ\nשגיאה",
                                "משהו השתבש, צא ונסה שנית\nحدث خطأ ما، الرجاء الخروج والدخول مرة اخرى",
                                "warning"
                            );
                            //alert("Error in setRidePat: " + err.responseText);
                        }
                    });

                    return false;
                },

                // Messages for form validation
                messages: {
                    dateRide: {
                        required: "יש להכניס תאריך"
                    },
                    pat: {
                        required: "יש לבחור חולה\nيجب اختيار مريض من القائمة"
                    },
                    //patArabic: {
                    //    required: "يجب عليك اختيار مريض"
                    //},
                    Origin: {
                        required: "יש לבחור מוצא"
                    },
                    Destination: {
                        required: "יש לבחור יעד"
                    },
                    coordinator: {
                        required: "יש לבחור רכז אחראי"
                    },
                },


            });
        });
        function sendMessegeFromAssistant(ridepat,msg) {
            var user = GENERAL.USER.getUserName();
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/pushAssistant",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                async: false,
                data: JSON.stringify({ridepat:ridepat,cellphone:user,msg:msg}),
                error: pushAssistantErrorCB
            });
        }
        function pushAssistantErrorCB(error) {
            console.log(error);
        }
        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [day, month, year].join('/');
        }
        function PrintRides(repeatRide,num) {
            var datesToPrint = num + " הסעות חדשות יווצרו בתאריכים:\n";
            var dateRide = $("#dateRide").val();
            var hours = $("#hour").val();
            var minutes = $("#minute").val();

            var Day = parseInt(dateRide.substring(8));
            var Month = parseInt(dateRide.substring(5, 7)) - 1;
            var Year = parseInt(dateRide.substring(0, 4));
            var Hour = parseInt(hours);
            var Minute = parseInt(minutes);
            if ($("#afterNoon").is(':checked')) { //22:14 is the default time that means afternoon אחה''צ
                Hour = 22;
                Minute = 14;
            }
            var date = new Date(Year, Month, Day, Hour, Minute);

            if (repeatRide === "כל שבוע") {
                for (let i = 0; i < num; i++) {
                    datesToPrint += formatDate(date) + "\n";
                    date = new Date(date.setDate(date.getDate() + 7));
                }
            }
            else {
                for (let i = 0; i < num; i++) {
                    datesToPrint += formatDate(date) + "\n";
                    date = new Date(date.setDate(date.getDate() + 1));
                }
            }



            if (confirm(datesToPrint)) {
                return true;
            }
            return false;
        }
        function generatePat() {
            var $select = $("#pat");
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getPatients",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                async: false,
                data: JSON.stringify({ active: true }),
                success: function (data) {
                    arr_pat = JSON.parse(data.d);

                    patients = [];
                    patientsIdentity = [];
                    arr_arabNames = [];
                    arr_englishNames = [];
                    patientsAssistent = [];
                    patientsAssistentDisplay = [];
                    arr_arabNamesAssistent = [];
                    arr_englishNamesAssistent = [];
                    patientsIdentityAssistent = [];
                    for (i in arr_pat) {
                        //assistant cannot create anonymouse ride.
                        if (isAssistant && arr_pat[i].IsAnonymous !== "") {
                            patientsIdentityAssistent.push(arr_pat[i].PatientIdentity)
                            patientsAssistent.push(arr_pat[i]);
                            patientsAssistentDisplay.push(arr_pat[i].DisplayName.trim())
                            arr_arabNamesAssistent.push(arr_pat[i].DisplayNameA);
                            arr_englishNamesAssistent.push(arr_pat[i].EnglishName);
                            continue;
                        }
                        patients.push(arr_pat[i].DisplayName.trim());
                        patientsIdentity.push(arr_pat[i].PatientIdentity)
                        arr_arabNames.push(arr_pat[i].DisplayNameA);
                        arr_englishNames.push(arr_pat[i].EnglishName);
                        arr_for_assistant.push(arr_pat[i]);
                    }
                    if (isAssistant) {
                        arr_pat = arr_for_assistant;
                    }

                    $("#pat").autocomplete({
                        source: patients
                    });
                    $("#patEnglishName").autocomplete({
                        source: arr_englishNames
                    });

                    $("#patArabic").autocomplete({
                        source: arr_arabNames
                    });
                    $("#PatientIdentity").autocomplete({
                        source: patientsIdentity
                    });
                    
                },
                error: function (err) { alert("Error in generatePat"); }
            });
        }

        function generatePatAnonymous(origin, destination) {
            var $select = $("#pat");
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getPatientsForAnonymous",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                async: false,
                data: JSON.stringify({ active: true, origin: origin, dest: destination }),
                success: function (data) {
                    arr_pat = JSON.parse(data.d);

                    patients = [];
                    arr_arabNames = [];
                    arr_englishNames = [];
                    patientsIdentity = [];
                    for (i in arr_pat) {
                        patients.push(arr_pat[i].DisplayName.trim());
                        arr_arabNames.push(arr_pat[i].DisplayNameA);
                        arr_englishNames.push(arr_pat[i].EnglishName);
                        patientsIdentity.push(arr_pat[i].PatientIdentity);
                    }

                    $("#pat").autocomplete({
                        source: patients
                    });

                    $("#patArabic").autocomplete({
                        source: arr_arabNames
                    });
                    $("#patEnglishName").autocomplete({
                        source: arr_englishNames
                    });
                    $("#PatientIdentity").autocomplete({
                        source: patientsIdentity
                    });
                },
                error: function (err) { alert("Error in getPatientsForAnonymous"); }
            });
        }
        function getAnonymousPatientsListForArea(origin, destination,area) {
            var $select = $("#pat");
            $('#wait').show();
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getAnonymousPatientsListForArea",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                async: false,
                data: JSON.stringify({ active: true, origin: origin, dest: destination,area:area }),
                success: function (data) {
                    arr_pat = JSON.parse(data.d);

                    patients = [];
                    arr_arabNames = [];
                    arr_englishNames = [];
                    patientsIdentity = [];
                    for (i in arr_pat) {
                        patients.push(arr_pat[i].DisplayName.trim());
                        arr_arabNames.push(arr_pat[i].DisplayNameA);
                        arr_englishNames.push(arr_pat[i].EnglishName);
                        patientsIdentity.push(arr_pat[i].PatientIdentity);
                    }
                    $('#wait').hide();
                    $("#pat").autocomplete({
                        source: patients
                    });

                    $("#patArabic").autocomplete({
                        source: arr_arabNames
                    });
                    $("#patEnglishName").autocomplete({
                        source: arr_englishNames
                    });
                    $("#PatientIdentity").autocomplete({
                        source: patientsIdentity
                    });
                },
                error: function (err) { alert("Error in getPatientsForAnonymous"); }
            });
        }

        function genarteAvailbaleSeats() {
            var ridePatNumber = parseInt($("#ridePatNum").val());
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getSpaceInCar",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                async: false,
                data: JSON.stringify({ ridePatNum: ridePatNumber, driverId: driverId }),
                success: function (data) {
                    spaceInCar = JSON.parse(data.d);
                },
                error: function (err) { alert("Error in getSpaceInCar"); }
            });
        }

        function getCoor() {
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getCoor",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                //async: false,
                data: JSON.stringify({ userName: GENERAL.USER.getUserName() }),
                success: getCoorSuccessCB,
                error: getCoorErrorCB
            });
        }

        function getCoorSuccessCB(data) {

            var $select = $("#coordinator");
            var coor = JSON.parse(data.d);


            $select.val(coor.DisplayName);
            if (isAnonymous === true) {
                $select.is("checked:", "checked");
            }
        }

        function getCoorErrorCB(e) {
            alert("Error in getCoor: " + e.responseText);
        }

        function generateEsc() {

            //first checking if the patient is anonymous.
            var displayName = $("#pat").val();
            displayName = displayName.replace(/\s\s+/g, ' ');
            var i = patients.indexOf($("#pat").val().trim().replace(/\s\s+/g, ' '));
            localStorage.PatID = arr_pat[i].Id;

            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getPatientEscorted",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                async: false,
                data: JSON.stringify({ displayName: displayName, caller: "ridePatForm" }),
                success: generateEscSuccessCB,
                error: generateEscErrorCB
            });
        }
        //}

        function generateEscSuccessCB(data) {
            arr_escort = JSON.parse(data.d);

            var str = "";

            var displayName = $("#pat").val().trim().replace(/\s\s+/g, ' ');

            var j = patients.indexOf($("#pat").val().trim().replace(/\s\s+/g, ' '));
            localStorage.PatID = arr_pat[j].Id;

            for (i in arr_escort) {
                var escort1 = arr_escort[i].DisplayName;
                var escort = arr_escort[i].DisplayName.replace("'", "");
                var id = arr_escort[i].Id;
                if (arr_pat[j].IsAnonymous == "True" && arr_customer.func == "new") {
                    str += "<input checked id='escortCB" + id + "' type=checkbox name='" + escort + "'>&nbsp";
                    str += "<label data-toggle='tooltip' title='"+arr_escort[i].EnglishName+"' for='escortCB" + id + "'>" + escort1 + "</label>&nbsp&nbsp</br>";
                }
                else {
                    str += "<input id='escortCB" + id + "' type=checkbox name='" + escort + "'>&nbsp";
                    str += "<label data-toggle='tooltip' title='" + arr_escort[i].EnglishName+"' for='escortCB" + id + "'>" + escort1 + "</label>&nbsp&nbsp</br>";
                }
            }
            if (arr_escort.length == 0) str = "<label data-toggle='tooltip' title='no escorts'>אין מלווים</label>";
            $("#selectEscort").html(str);

            if (arr_customer.func == "show") {
                var select = $("#selectEscort input");
                for (var i = 0; i < select.length; i++) {
                    $("#selectEscort input").eq(i).prop('disabled', true);
                }
            }

        }

        function generateEscErrorCB() {
            alert("Error in generateEsc");
        }

        function generateStatus() {

            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getAllStatus",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                //async: false,
                //data: JSON.stringify({ patient: dataString }),
                success: generateStatusSuccessCB,
                error: generateStatusErrorCB
            });

            function generateStatusSuccessCB(data) {
                var $select = $("#statusRidePat");
                var arr_status = JSON.parse(data.d);
                for (i in arr_status) {
                    var status = arr_status[i].Name;
                    $('<option>', { value: status, text: status }).appendTo($select);
                }
                if (arr_customer.func == "new") {
                    $("#statusRidePat option[value='ממתינה לשיבוץ']").prop('selected', true);
                }

            }

            function generateStatusErrorCB() {
                alert("Error in generateStatus");
            }
        }

        function generateLocation() {
            var $select = $("#Origin");
            var $select1 = $("#Destination");
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getDestinationView",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                async: false,
                data: JSON.stringify({ active: true }),
                success: function (data) {
                    var arr_locations = JSON.parse(data.d);
                    arr_locations.sort();
                    for (i in arr_locations) {

                        $('<option>', { value: arr_locations[i].Name, text: arr_locations[i].EnglishName }).appendTo($select);
                        $('<option>', { value: arr_locations[i].Name, text: arr_locations[i].EnglishName }).appendTo($select1);

                    }
                },
                error: function (err) { alert("Error in generateLocation"); }
            });
        }

        function generateHour() {
            var $select = $("#hour");
            for (var i = 0; i < 24; i++) {
                if (i < 10) i = "0" + i;
                $('<option>', { value: i, text: i }).appendTo($select);
            }
            $select.val("06");
        }

        function generateMinute() {
            var $select = $("#minute");
            for (var i = 0; i < 60; i += 15) {
                if (i < 10) var j = "0" + i; else j = i;
                $('<option>', { value: j, text: j }).appendTo($select);
            }
            $select.val("00");
        }

        function validateInputs() {

            var patientExists = false;
            var patientAExists = false;
            var Origin = true;
            var Dest = true;
            var pat = document.forms["customerForm"]["pat"].value;
            var pat2 = $("#pat").val().trim().replace(/\s\s+/g, ' ');
            
            for (i in patients) {
                if (pat2 == patients[i] || pat == patients[i]) {
                    patientExists = true;
                    break;
                }
            }

            var patA = $("#patArabic").val().trim().replace(/\s\s+/g, ' ');
            for (i in arr_arabNames) {
                if (patA == arr_arabNames[i]) {
                    patientAExists = true;
                    break;
                }
            }

            if (!patientExists) {
                swal(
                    "خطأ\nשגיאה",
                    "يجب اختيار مريض من القائمة\nיש לבחור חולה מתוך הרשימה",
                    "warning"
                );
            }

            if (!patientAExists) {
                swal(
                    "خطأ\nשגיאה",
                    "يجب عليك اختيار مريض من القائمة",
                    "warning"
                );
            }

            var Origin = $("#Origin").val();
            if (Origin == "בחר מוצא") {
                Origin = false
                swal(
                    "خطأ\nשגיאה",
                    "يجب اختيار نقطة انطلاق من القائمة\nיש לבחור מוצא מתוך הרשימה",
                    "warning"
                );
            }

            var Destination = $("#Destination").val();
            if (Destination == "בחר יעד") {
                Dest = false;
                swal(
                    "خطأ\nשגיאה",
                    "يجب اختيار نقطة انطلاق من القائمة\nיש לבחור מוצא מתוך הרשימה",
                    "warning"
                );
            }

            //var date = $("#dateRide").val();
            var date = document.getElementById("dateRide").value;
            //var reg = new RegExp("[0-9]{2}\/[0-9]{2}\/[0-9]{4}");
            //var dateMatch = reg.test(date);
            //if (!dateMatch) alert("התאריך שהוזן אינו חוקי");
            var Day = parseInt(date.substring(8));
            var Month = parseInt(date.substring(5, 7)) - 1;
            var Year = parseInt(date.substring(0, 4));
            date = new Date(Year, Month, Day, $("#hour").val(), $("#minute").val());
            futureDate = checkFutureDate(date);
            if (!futureDate) {
                var r = confirm(" זמן ההסעה עבר, האם להמשיך?");
                if (r == true) {
                    futureDate = true;
                } 

                //swal({
                //    title: "זמן ההסעה עבר",
                //    text: "האם תרצה להמשיך?",
                //    type: "warning",
                //    showCancelButton: true,
                //    confirmButtonClass: "btn-warning",
                //    confirmButtonText: "המשך",
                //    cancelButtonText: "ביטול",
                //    closeOnConfirm: true,
                //    closeOnCancel: true,
                    
                //},
                //function (isConfirm) {
                //    if (isConfirm) {
                //        futureDate = true;
                //    }
                //});

                //swal("خطأ\nשגיאה",
                //    "زمن السفرية قد مضى، الرجاء التصحيح\nזמן ההסעה עבר, נא לתקן",
                //    "warning"
                //);
            }

            var timeMatch = true;
            var aN = $("#afterNoon").is(':checked');
            if (!aN) {
                if ($("#hour").val() == "שעות" || $("#minute").val() == "דקות") {
                    swal(
                        "خطأ\nשגיאה",
                        "השעה שנבחרה אינה חוקית\nالساعة التي تم اختيارها غير ملائمة",
                        "warning"
                    );
                    timeMatch = false;
                }
            }



            if ($("#onlyEscort").is(':checked')) {
                var atLeastOneIsChecked = 0;
                $('#selectEscort input:checked').each(function () {
                    atLeastOneIsChecked++;
                });
                if (atLeastOneIsChecked == 0) {
                    swal(
                        "خطأ\nשגיאה",
                        "يجب اختيار مرافق واحد على الاقل\nיש לבחור לפחות מלווה אחד",
                        "warning"
                    );
                }
            }

            if (!patientExists || !Origin || !Dest || !timeMatch || atLeastOneIsChecked == 0 || !futureDate) { //|| !dateMatch
                return false;
            } else return true;
        }

        function fillData() {
            //.trim().replace(/\s\s+/g, ' ')
            if (isCenterPoint) {
                isCenterPatient = true;
            }
            else isCenterPatient = false;
            if ($("#pat").val() != "") {
                var i = patients.indexOf($("#pat").val().trim().replace(/\s\s+/g, ' '));
                if (i === -1) {
                    var i = patientsAssistentDisplay.indexOf($("#pat").val().trim().replace(/\s\s+/g, ' '));
                    localStorage.PatID = patientsAssistent[i].Id;
                    $("#patArabic").val(arr_arabNamesAssistent[i]);
                    if (patientsIdentityAssistent[i] != '0') {
                        $("#PatientIdentity").val(patientsIdentityAssistent[i]);
                    }
                    else $("#PatientIdentity").val("");
                    $("#patEnglishName").val(arr_englishNamesAssistent[i]);
                    $("#patientInfo").show();
                }
                else {
                    localStorage.PatID = arr_pat[i].Id;
                    $("#patArabic").val(arr_arabNames[i]);
                    $("#patEnglishName").val(arr_englishNames[i]);
                    $("#PatientIdentity").val(patientsIdentity[i]);
                    $("#patientInfo").show();
                }

                if (rideStatusForFields == 0) {
                    $("#afterNoon").removeAttr('disabled');
                    $("#Origin").removeAttr('disabled');
                    $("#remark").removeAttr('disabled');
                    $("#Destination").removeAttr('disabled');
                    $("#dateRide").removeAttr('disabled');
                    $("#hour").removeAttr('disabled');
                    $("#minute").removeAttr('disabled');
                    $("#dirBTN").removeAttr('disabled');
                    $("#patArabic").removeAttr('disabled');
                }
            }
            else if ($("#patEnglishName").val() != "") {
                var i = arr_englishNames.indexOf($("#patEnglishName").val().trim().replace(/\s\s+/g, ' '));
                if (i === -1) {
                    var i = arr_englishNamesAssistent.indexOf($("#patEnglishName").val().trim().replace(/\s\s+/g, ' '));
                    localStorage.PatID = patientsAssistent[i].Id;
                    $("#patArabic").val(arr_arabNamesAssistent[i]);
                    $("#PatientIdentity").val(patientsIdentityAssistent[i]);
                    $("#pat").val(patientsAssistent[i].DisplayName);
                    $("#patientInfo").show();
                }
                else {
                    $("#pat").val(patients[i]);
                    $("#patArabic").val(arr_arabNames[i]);
                    localStorage.PatID = arr_pat[i].Id;
                    $("#PatientIdentity").val(patientsIdentity[i]);
                    $("#patientInfo").show();
                }
                if (rideStatusForFields == 0) {
                    $("#afterNoon").removeAttr('disabled');
                    $("#Origin").removeAttr('disabled');
                    $("#remark").removeAttr('disabled');
                    $("#Destination").removeAttr('disabled');
                    $("#dateRide").removeAttr('disabled');
                    $("#hour").removeAttr('disabled');
                    $("#minute").removeAttr('disabled');
                    $("#dirBTN").removeAttr('disabled');
                    $("#patArabic").removeAttr('disabled');
                }
            }
            else if ($("#patArabic").val() != "") {
                var i = arr_arabNames.indexOf($("#patArabic").val().trim().replace(/\s\s+/g, ' '));
                if (i === -1) {
                    var i = arr_arabNamesAssistent.indexOf($("#patEnglishName").val().trim().replace(/\s\s+/g, ' '));
                    localStorage.PatID = patientsAssistent[i].Id;
                    $("#patEnglishName").val(arr_englishNamesAssistent[i]);
                    $("#PatientIdentity").val(patientsIdentityAssistent[i]);
                    $("#pat").val(patientsAssistent[i].DisplayName);
                    $("#patientInfo").show();
                }
                else {
                    $("#pat").val(patients[i]);
                    $("#patEnglishName").val(arr_englishNames[i]);
                    localStorage.PatID = arr_pat[i].Id;
                    $("#PatientIdentity").val(patientsIdentity[i]);
                    $("#patientInfo").show();

                }
                if (rideStatusForFields == 0) {
                    $("#afterNoon").removeAttr('disabled');
                    $("#Origin").removeAttr('disabled');
                    $("#remark").removeAttr('disabled');
                    $("#Destination").removeAttr('disabled');
                    $("#dateRide").removeAttr('disabled');
                    $("#hour").removeAttr('disabled');
                    $("#minute").removeAttr('disabled');
                    $("#dirBTN").removeAttr('disabled');
                    $("#patArabic").removeAttr('disabled');
                }
            }
            else if ($("#PatientIdentity").val() != '' && $("#PatientIdentity").val() != '0'){
                var i = patientsIdentity.indexOf(parseInt($("#PatientIdentity").val().trim().replace(/\s\s+/g, ' ')));
                if (i === -1) {
                    var i = patientsIdentityAssistent.indexOf($("#PatientIdentity").val().trim().replace(/\s\s+/g, ' '));
                    localStorage.PatID = patientsAssistent[i].Id;
                    $("#patEnglishName").val(arr_englishNamesAssistent[i]);
                    $("#patArabic").val(arr_arabNamesAssistent[i]);
                    $("#pat").val(patientsAssistent[i].DisplayName);
                    $("#patientInfo").show();
                }
                else {
                    $("#pat").val(patients[i]);
                    $("#patEnglishName").val(arr_englishNames[i]);
                    localStorage.PatID = arr_pat[i].Id;
                    $("#patArabic").val(arr_arabNamesAssistent[i]);
                    //$("#PatientIdentity").val(patientsIdentity[i]);
                    $("#patientInfo").show();
                }
                if (rideStatusForFields == 0) {
                    $("#afterNoon").removeAttr('disabled');
                    $("#Origin").removeAttr('disabled');
                    $("#remark").removeAttr('disabled');
                    $("#Destination").removeAttr('disabled');
                    $("#dateRide").removeAttr('disabled');
                    $("#hour").removeAttr('disabled');
                    $("#minute").removeAttr('disabled');
                    $("#dirBTN").removeAttr('disabled');
                    $("#patArabic").removeAttr('disabled');
                }
            }
            

            try {
                if (currentOrigin === arr_pat[i].Barrier.Name && isCenterPatient) {
                    $("#Origin option[value ='" + currentOrigin + "']").prop('selected', true);
                    $("#Destination option[value ='" + arr_pat[i].Hospital.Name + "']").prop('selected', true);
                }
                else if (currentDestination === arr_pat[i].Barrier.Name && isCenterPatient) {
                    $("#Origin option[value ='" + arr_pat[i].Hospital.Name + "']").prop('selected', true);
                    $("#Destination option[value ='" + currentDestination + "']").prop('selected', true);
                }
                else if (currentOrigin === arr_pat[i].Hospital.Name && isCenterPatient) {
                    $("#Origin option[value ='" + currentOrigin + "']").prop('selected', true);
                    $("#Destination option[value ='" + arr_pat[i].Barrier.Name + "']").prop('selected', true);
                }
                else if (currentDestination === arr_pat[i].Hospital.Name && isCenterPatient) {
                    $("#Origin option[value ='" + arr_pat[i].Barrier.Name + "']").prop('selected', true);
                    $("#Destination option[value ='" + currentDestination + "']").prop('selected', true);
                }
                else if (currentOrigin != '' && currentDestination != '' && !isCenterPatient) {
                    $("#Origin option[value ='" + currentOrigin + "']").prop('selected', true);
                    $("#Destination option[value ='" + currentDestination + "']").prop('selected', true);
                }
                else {
                    $("#Origin option[value ='" + arr_pat[i].Barrier.Name.replace("'", "\\'") + "']").prop('selected', true);
                    $("#Destination option[value ='" + arr_pat[i].Hospital.Name.replace("'", "\\'") + "']").prop('selected', true);
                    //$("#Origin option[value ='" + arr_pat[i].Barrier.EnglishName.replace("'", "\\'") + "']").prop('selected', true);
                    //$("#Destination option[value ='" + arr_pat[i].Hospital.EnglishName.replace("'", "\\'") + "']").prop('selected', true);
                }
                if (arr_pat[i].IsAnonymous == "True") {
                    getEquipmentForAnonymousPatient();
                    anonymousName = "True";
                    $("#Origin").attr('disabled', 'disabled');
                    $("#Destination").attr('disabled', 'disabled');
                    //$("#dirBTN").attr('disabled', 'disabled');
                }
                else getEquipmentForPatient();
                generateEsc();

            } catch (e) {
                if (e.responseText == undefined) {
                    swal("אנא בחר חולה\nالرجاء اختيار مريض");
                }
                else alert(e.responseText);
            }

        }

        function checkFutureDate(date) {
            //if ($("#afterNoon").is(':checked')) { //22:14 is the default time that means afternoon אחה''צ
            //    Hour = 22;
            //    Minute = 14;
            //}

            checkDate = Date.parse(date); //parameter datetime to compare with today
            if ($("#afterNoon").is(':checked')) { //22:14 is the default time that means afternoon אחה''צ
                checkDate = Date.parse(new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59));
            }
            var d2 = new Date(); //now
            currentDate = Date.parse(d2);

            if (checkDate < currentDate) return false //past datetime
            else return true; //future datetime
        }

        function getEquipmentForPatient() {
            //.trim().replace(/\s\s+/g, ' ')
            var dataString = $("#pat").val().trim().replace(/\s\s+/g, ' ');

            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getEquipmentForPatient",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                //async: false,
                data: JSON.stringify({ patient: dataString }),
                success: getEquipmentForPatientSuccessCB,
                error: getEquipmentForPatientErrorCB
            });
        }

        function getEquipmentForPatientSuccessCB(data) {
            var arr_equipment = JSON.parse(data.d)
            var str = "";
            for (i in arr_equipment) {
                var english = '';
                if (arr_equipment[i] == 'כסא גלגלים') {
                    english = 'Wheelchair';
                }
                else if (arr_equipment[i] == 'כסא תינוק') {
                    english = 'Baby seat';
                }
                else if (arr_equipment[i] == 'קביים') {
                    english = 'Crutches';
                }
                else {
                    english = 'Buster';
                }
                str += arr_equipment[i] + "(" + english + "), ";
                //for check in case of changing anonymous patient
                checkEquipment.push(arr_equipment[i]);
            }
            str = str.substring(0, str.lastIndexOf(", "));
            if (str == "") str = "(None) אין";
            $("#Equipment").text(str);
        }

        function getEquipmentForPatientErrorCB(err) {
            alert("Error in getEquipmentForPatient: " + err.responseText);
        }


        //getEquipment for anonymous patient
        function getEquipmentForAnonymousPatient() {
            //var dataString = document.forms["customerForm"]["pat"].value;
            var dataString = $("#pat").val().trim().replace(/\s\s+/g, ' ');

            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getEquipmentForPatient",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                //async: false,
                data: JSON.stringify({ patient: dataString }),
                success: getEquipmentForAnonymousPatientSuccessCB,
                error: getEquipmentForAnonymousPatientErrorCB
            });
        }

        function getEquipmentForAnonymousPatientSuccessCB(data) {
            var arr_equipment = JSON.parse(data.d)
            var str = "";
            for (i in arr_equipment) {
                var english = '';
                if (arr_equipment[i] == 'כסא גלגלים') {
                    english = 'Wheelchair';
                }
                else if (arr_equipment[i] == 'כסא תינוק') {
                    english = 'Baby seat';
                }
                else if (arr_equipment[i] == 'קביים') {
                    english = 'Crutches';
                }
                else {
                    english = 'Buster';
                }
                str += arr_equipment[i] + "(" + english+"), ";
                //for anonymous patient
                checkEquipmentAnonymous.push(arr_equipment[i]);
            }
            str = str.substring(0, str.lastIndexOf(", "));
            if (str == "") str = "(None) אין";
            $("#Equipment").text(str);
        }

        function getEquipmentForAnonymousPatientErrorCB(err) {
            alert("Error in getEquipmentForAnonymousPatient: " + err.responseText);
        }





        function switchDir() {
            var a = $("#Origin").val();
            var b = $("#Destination").val()
            a = a.replace("'", "\\'");
            b = b.replace("'", "\\'");

            $("#Origin option[value ='" + b + "']").prop('selected', true);
            $("#Destination option[value ='" + a + "']").prop('selected', true);
        }


        function loadPage() {
            var userType = GENERAL.USER.getUserType();
            if (userType != "מנהל") {
                $("#coorDiv").hide();
                $("#ph").show();
            } else {
                $("#coorDiv").show();
                $("#ph").hide();
            }
            if (JSON.parse(GENERAL.RIDEPAT.getRidePatList()).length != 0) {
                arr_customer = JSON.parse(GENERAL.RIDEPAT.getRidePatList());
                $("#ridePatNum").attr('disabled', 'disabled');
                $("#coordinator").attr('disabled', 'disabled');
                $("#statusRidePat").attr('disabled', 'disabled');
                $("#Equipment").attr('disabled', 'disabled');
                if (arr_customer.func == "edit" || arr_customer.func == "show") {
                    uploadData(arr_customer.RidePatNum);
                    $("#hideOnEdit").addClass('duplicateDisplay');

                    if (arr_customer.func == "show") {

                        $("#afterNoon").attr('disabled', 'disabled');
                        $("#pat").attr('disabled', 'disabled');
                        $("#Origin").attr('disabled', 'disabled');
                        $("#remark").attr('disabled', 'disabled');
                        $("#Destination").attr('disabled', 'disabled');
                        $("#dateRide").attr('disabled', 'disabled');
                        $("#hour").attr('disabled', 'disabled');
                        $("#minute").attr('disabled', 'disabled');
                        $("#dirBTN").attr('disabled', 'disabled');
                        $("#patArabic").attr('disabled', 'disabled');
                        $("#saveCustomer").attr('disabled', 'disabled');
                        $("#onlyEscort").prop('disabled', true);

                    }
                }
                else {
                    //check on בדיקה.
                    $("#afterNoon").attr('disabled', 'disabled');
                    $("#Origin").attr('disabled', 'disabled');
                    $("#remark").attr('disabled', 'disabled');
                    $("#Destination").attr('disabled', 'disabled');
                    $("#dateRide").attr('disabled', 'disabled');
                    $("#hour").attr('disabled', 'disabled');
                    $("#minute").attr('disabled', 'disabled');
                    $("#dirBTN").attr('disabled', 'disabled');
                    $("#patArabic").attr('disabled', 'disabled');
                    //$("#saveCustomer").attr('disabled', 'disabled');
                    generateStatus();
                    generatePat();
                    getCoor();
                    generateLocation();
                    generateHour();
                    generateMinute();
                }
            }
        }


        function showDuplicate() {
            if ($("#duplicateRidePat").is(':checked')) {
                $("#hideDuplicate").removeClass('duplicateDisplay');
            }
            else {
                $("#hideDuplicate").addClass('duplicateDisplay');
            }
        }


        //function to fill form for edit
        function uploadData(ridePatNum) {
            generatePat();
            generateLocation();
            generateHour();
            generateMinute();
            generateStatus();


            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getRidePat",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                data: JSON.stringify({ ridePatNum: ridePatNum }),
                success: function (data) {
                    var ridePat = JSON.parse(data.d);
                    GENERAL.RIDEPAT.setRidePatList(JSON.stringify(ridePat));

                    var temp = ridePat.Date.substring(ridePat.Date.indexOf("(") + 1, ridePat.Date.indexOf(")"))
                    var date = new Date(parseInt(temp));
                    day = date.getDay();
                    var dayArr = ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "שבת"];
                    var dayName = dayArr[day];
                    var day = date.getDate();
                    var month = date.getMonth() + 1;
                    var year = date.getFullYear();
                    var hours = date.getHours();
                    var minutes = date.getMinutes();
                    if (hours < 10) hours = "0" + hours;
                    if (minutes < 10) minutes = minutes + "0";
                    if (day < 10) day = "0" + day;
                    if (month < 10) month = "0" + month;
                    date = year + "-" + month + "-" + day;

                    //rdate = ryear + "-" + rmonth + "-" + rday;
                    document.getElementById("dateRide").value = date;

                    if (hours + ":" + minutes == "22:14") {
                        $("#afterNoon").attr('checked', 'checked');
                        checkAfternoon();

                    } else {
                        $("#hour option[value='" + hours + "']").prop('selected', true);
                        $("#minute option[value='" + minutes + "']").prop('selected', true);
                    }
                    if (ridePat.Status != 'ממתינה לשיבוץ') {
                        rideStatusForFields = 1;
                    }

                    //editing anonymous ridepat only if a driver assigned to the ride.
                    if ((ridePat.Pat.IsAnonymous == "True") && (ridePat.Status != 'ממתינה לשיבוץ')) {

                        $("#afterNoon").attr('disabled', 'disabled');
                        $("#Origin").attr('disabled', 'disabled');
                        $("#Destination").attr('disabled', 'disabled');
                        $("#hour").attr('disabled', 'disabled');
                        $("#minute").attr('disabled', 'disabled');
                        $("#dateRide").attr('disabled', 'disabled');
                        $("#dirBTN").attr('disabled', 'disabled');
                    }
                    if (ridePat.Pat.IsAnonymous == "True" && (ridePat.Pat.DisplayName.indexOf('מרכז') !== -1 || ridePat.Pat.DisplayName.indexOf('ארז') !== -1 ||ridePat.Pat.DisplayName.indexOf('ירושלים') !== -1 || ridePat.Pat.DisplayName.indexOf('דרום') !== -1 ||  ridePat.Pat.DisplayName.indexOf('צפון') !== -1)) {
                        var area = "";
                        if(ridePat.Pat.DisplayName.indexOf('מרכז') !== -1){
                            area="מרכז";
                        }
                        if(ridePat.Pat.DisplayName.indexOf('דרום') !== -1){
                            area="דרום";
                        }
                        if(ridePat.Pat.DisplayName.indexOf('ירושלים') !== -1){
                            area="ירושלים";
                        }
                        if(ridePat.Pat.DisplayName.indexOf('צפון') !== -1){
                            area="צפון";
                        }
                        var origin = ridePat.Origin.Name;
                        var destination = ridePat.Destination.Name;
                        isCenterPoint = true;
                        getAnonymousPatientsListForArea(origin, destination,area);
                    }
                    else if (ridePat.Pat.IsAnonymous == "True") {

                        var origin = ridePat.Origin.Name;
                        var destination = ridePat.Destination.Name;
                        generatePatAnonymous(origin, destination);
                    }
                    
                    if (ridePat.OnlyEscort) $("#onlyEscort").prop('checked', true);
                    $("#ridePatNum").val(ridePat.RidePatNum);
                    $("#pat").val(ridePat.Pat.DisplayName);
                    $("#pat").blur();
                    if (typeof arr_escort !== "undefined") {

                        for (i in arr_escort) {
                            if (ridePat.Pat.IsAnonymous == "True" && (ridePat.Status != 'ממתינה לשיבוץ')) {
                                var Escorted = new Object();
                                Escorted = arr_escort[i];
                                checkEscorts.push(Escorted);
                            }
                            for (j in ridePat.Escorts) {
                                if (arr_escort[i].DisplayName == ridePat.Escorts[j].DisplayName) {
                                    $("#escortCB" + arr_escort[i].Id).prop('checked', true);
                                }
                            }
                        }
                    } else ($("#selectEscort").html("<label data-toggle='tooltip' title='No escorts'>אין מלווים</label>"));

                    //ridePat.Origin.EnglishName = ridePat.Origin.EnglishName.replace("'", "\\'");
                    //$("#selectOrigin option[value='" + ridePat.Origin.EnglishName + "']").prop('selected', true);
                    //ridePat.Destination.EnglishName = ridePat.Destination.EnglishName.replace("'", "\\'");
                    //$("#selectDestination option[value='" + ridePat.Destination.EnglishName + "']").prop('selected', true);
                    ridePat.Origin.Name = ridePat.Origin.Name.replace("'", "\\'");
                    $("#selectOrigin option[value='" + ridePat.Origin.Name + "']").prop('selected', true);
                    ridePat.Destination.Name = ridePat.Destination.Name.replace("'", "\\'");
                    $("#selectDestination option[value='" + ridePat.Destination.Name + "']").prop('selected', true);

                    if (ridePat.Pat.IsAnonymous == "True") {
                        currentOrigin = ridePat.Origin.Name;
                        currentDestination = ridePat.Destination.Name;
                    }


                    //$("#dateRide").val(date);


                    $("#coordinator").val(ridePat.Coordinator.DisplayName);

                    $("#remark").val(ridePat.Remark);

                    $("#statusRidePat option[value='" + ridePat.Status + "']").prop('selected', true);
                    //anonymousName = ridePat.Pat.DisplayName;
                    isWaiting = ridePat.Status;
                    if (ridePat.Drivers.length > 0) {
                        driverId = ridePat.Drivers[0].Id;
                    }
                },
                error: function (err) { alert("Error in uploadData: " + err.responseText); }
            });
        }

        function returnRidePat() {
            //window.history.back();
            localStorage.setItem("PatientNameForRide",null);
            location.href = "manageRidePats.html"
        }

        function checkAfternoon() {
            if ($("#afterNoon").is(':checked')) {
                $("#hour").val("");
                $("#minute").val("");
                $("#hour").attr('disabled', 'disabled');
                $("#minute").attr('disabled', 'disabled');
            } else {
                $("#hour").val("06");
                $("#minute").val("00");
                $("#hour").attr('disabled', false);
                $("#minute").attr('disabled', false);
            }
        }
        function getPatientInformation() {
            var pat = $("#pat").val();
            arr_details = { displayName: pat, func: "edit" };
            GENERAL.PATIENTS.setPatientsList(JSON.stringify(arr_details));
            if (pat.indexOf("אנונימי") != -1) {
                location.href = "anonymousPatientForm.html";
            }
            else location.href = "patientForm.html";
        }
    </script>
</head>
<body class="fixed-left">

    <!-- Begin page -->
    <div id="wrapper">

        <!-- Top Bar Start -->
        <div class="topbar">



            <!-- Navbar -->
            <div id="na" class="navbar navbar-default" role="navigation">
                <div class="container">
                    <div class="">
                        <!--Expend/Collaps Side Menue-->
                        <div class="pull-left">
                            <button class="button-menu-mobile open-left waves-effect">
                                <i class="md md-menu"></i>
                            </button>
                            <span class="clearfix"></span>
                        </div>

                        <!-- LOGO -->
                        <div class="pull-left">
                            <div class="text-center">
                                <a href="manageRidePats.html" class="logo"><span>בדרך להחלמה</span>&nbsp&nbsp&nbsp</a>
                            </div>
                        </div>
                        <div class="pull-right">
                            <span class="logo" id="userName"></span>
                        </div>
                    </div>
                    <!--/.nav-collapse -->
                </div>
            </div>
        </div>
        <!-- Top Bar End -->
        <!-- ========== Right Sidebar Start ========== -->
        <div id="menuType"></div>
        <!-- Right Sidebar End -->
        <!-- ============================================================== -->
        <!-- Start page Content here -->
        <!-- ============================================================== -->
        <div class="content-page">
            <!-- Start content -->
            <div class="content">
                <div class="container">
                    <!-- Page-Title -->
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="page-title-box">
                                <ol class="breadcrumb pull-right">
                                    <li><a href="viewRidePats.html">כל ההסעות</a></li>
                                    <li data-toggle="tooltip" title="Ride   توصيل المريض" class="active">הסעת חולה</li>
                                </ol>
                                <h4  class="page-title">הסעת חולה&nbsp&nbsp<i data-toggle="tooltip" title="Ride   توصيل المريض" class="md md-recent-actors"></i></h4>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <form class="form-horizontal" role="form" id="customerForm">
                            <div class="col-sm-12">
                                <div class="card-box">
                                    <div class="row">
                                        <h4 class="m-t-0 header-title"><b data-toggle="tooltip" title="Ride   توصيل المريض">הסעת חולה</b></h4>

                                        <div class="text-right m-b-30 m-r-15">
                                            <button type="button" onclick="returnRidePat()" class="btn btn-default waves-effect w-md m-b-5"><i data-toggle="tooltip" data-placement="bottom" title="عودة  Back" class="ti-back-right m-r-5"></i>&nbsp Back</button>
                                            <div id="patientInfo"> <button type="button" onclick="getPatientInformation()" dir="ltr" class="btn btn-info waves-effect w-md m-b-5"><i data-toggle="tooltip" data-placement="bottom" title="Patient info" class="ti-info m-r-5"></i>&nbsp Patient information</button></div>
                                        </div>
                                        <p class="required"><span data-toggle="tooltip" title="Must field   حقل اجباري">* שדה חובה</span></p>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Patient's Name   اسم المريض" class="col-sm-2 control-label">שם החולה&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6 ui-widget" id="selectPat">
                                                        <input type="text" id="pat" name="pat" class="form-control">
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <input type="checkbox" id="onlyEscort" />
                                                        <label data-toggle="tooltip" title="Company only   سفر للمرافقين فقط" for="onlyEscort">נסיעה למלווים בלבד</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label id="statuslabelRidePat" data-toggle="tooltip" title="Status   حالة السفرية" class="col-sm-2 control-label">סטטוס</label>
                                                    <div class="col-sm-6" id="selectstatusRidePat">
                                                        <select id="statusRidePat" name="statusRidePat" class="form-control"><option>בחר סטטוס נסיעה</option></select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Patient's English Name   اسم المريض" class="col-sm-2 control-label">שם החולה באנגלית&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6 ui-widget" id="selectEnglishPat">
                                                        <input type="text" id="patEnglishName" name="pat" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Patient ID" class="col-sm-2 control-label">תעודת זהות&nbsp;</label>
                                                    <div class="col-sm-6 ui-widget" id="selectPatId">
                                                        <input type="text" id="PatientIdentity" name="PatientIdentity" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">اسم المريض</label>
                                                    <div class="col-sm-6 ui-widget" id="selectPat">
                                                        <input type="text" id="patArabic" name="patArabic" class="form-control"></input>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Select Origin   اختر نقطة الانطلاق" class="col-sm-2 control-label">מוצא&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6" id="selectOrigin">
                                                        <select id="Origin" name="Origin" class="form-control"><option>בחר מוצא</option></select>
                                                        <input data-toggle="tooltip" title="Change Direction   تغيير اتجاه/ وجهة" id="dirBTN" type="button" value="שינוי כיוון" onclick="switchDir()" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <div class="form-group" id="escortDiv">
                                                    <label data-toggle="tooltip" title="Patient escorts" class="col-sm-2 control-label">מלווים</label>
                                                    <div class="col-sm-6" id="selectEscort">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Destination   نقطة الوصول" class="col-sm-2 control-label">יעד&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6" id="selectDestination">
                                                        <select id="Destination" name="Destination" class="form-control"><option>בחר יעד</option></select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Equipment   غرض مرافق" class="col-sm-2 control-label">ציוד נלווה</label>
                                                    <div class="col-sm-6" id="selectaddition">
                                                        <label id="Equipment" name="Equipment" class="control-label" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="ملاحظات   Notes" class="col-sm-2 control-label">הערות</label>
                                                    <div class="col-sm-6">
                                                        <input id="remark" name="remark" type="text" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Time  ساعة السفر" class="col-sm-2 control-label">שעת הסעה&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6" id="selecthour">
                                                        <select id="minute" name="minute" class="form-control" style="width:33%;display:inline"><option>דקות</option></select>
                                                        <p style="display:inline;">:</p>
                                                        <select id="hour" name="hour" class="form-control" style="width:33%; display:inline;"><option>שעות</option></select>
                                                        <br />
                                                        <br />
                                                        <input type="checkbox" id="afterNoon" onchange="checkAfternoon()" />
                                                        <label data-toggle="tooltip" title="or afternoon  او بالمساء" for="afterNoon">או אחה"צ</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">

                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Ride #number  رقم السفرية" class="col-sm-2 control-label">מספר הסעה</label>
                                                    <div class="col-sm-6">
                                                        <input id="ridePatNum" name="ridePatNum" type="text" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                            </div>
                                        </div>
                                        <div class="row m-l-10 m-r-10">
                                            <div class="col-sm-6" id="ph">
                                            </div>
                                            <div class="col-sm-6" id="coorDiv">
                                                <div class="form-group">
                                                    <label class="col-sm-2 control-label">רכז</label>
                                                    <div class="col-sm-6" id="selectCoordinator">
                                                        <input type="text" id="coordinator" name="coordinator" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Date  تاريخ السفر" class="col-sm-2 control-label">תאריך הסעה&nbsp;<span class="required">*</span></label>
                                                    <div class="col-sm-6">
                                                        <!--<input type="text" class="form-control" placeholder="dd/mm/yyyy" id="dateRide" name="dateRide">-->
                                                        <input type="date" class="form-control" placeholder="dd/mm/yyyy" id="dateRide" name="dateRide" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--<div class="row m-l-10 m-r-10">

                    <div class="col-sm-6">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">מספר הסעה</label>
                            <div class="col-sm-6">
                                <input id="ridePatNum" name="ridePatNum" type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                    </div>
                </div>-->
                                        <!--duplicate ride section-->
                                        <div class="row m-l-10 m-r-10" id="hideOnEdit">
                                            <div class="col-sm-6">
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <div id="duplicate" class="col-sm-6">
                                                        <input type="checkbox" id="duplicateRidePat" onchange="showDuplicate()" />
                                                        <label data-toggle="tooltip" title="Recurring ride?  سفريات عائدة" for="duplicateRidePat"> הסעה חוזרת?</label>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>

                                        <div class="row m-l-10 m-r-10 duplicateDisplay" id="hideDuplicate">
                                            <div class="col-md-6"></div>
                                            <div class="col-sm-3">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Scheduling جدولة" class="col-sm-2 control-label">תזמון</label>
                                                    <select id="repeatRide" name="repeatRide" class="form-control" style="width:80%;display:inline">
                                                        <option data-toggle="tooltip" title="Every week on this day كل اسبوع">כל שבוע</option>
                                                        <option data-toggle="tooltip" title="Successive days عدة ايام متتالية">מספר ימים ברצף</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-sm-2" id="coorDiv">
                                                <div class="form-group">
                                                    <label data-toggle="tooltip" title="Number of times عدة مرات" class="col-sm-4 control-label">מספר פעמים</label>
                                                    <div class="col-sm-6" id="selectCoordinator">
                                                        <input type="number" max="30" min="0" id="numberOfRides" name="numberOfRides" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="wait" style="display:none;width:69px;height:89px;position:absolute;top:50%;left:50%;padding:2px;">
                                <img src="../../Media/Wedges-3s-200px.gif" width="64" height="64" />
                            </div>
                            <div>
                                <hr />
                                <div class="text-right m-t-30 row">
                                    <button data-toggle="tooltip" title="Save  حفظ" type="submit" id="saveCustomer" class="btn btn-success waves-effect w-md waves-light m-b-5  m-r-15"><i class="ti-save m-r-5"></i>&nbsp Save</button>
                                </div>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
            <!-- end container -->
        </div>
        <!-- end content -->
        <!-- FOOTER -->
        <footer class="footer text-right">
            2020 - 2018 © כל הזכויות שמורות לעמותת בדרך להחלמה
        </footer>
        <!-- End FOOTER -->
    </div>
    <!-- ============================================================== -->
    <!-- End page content here -->
    <!-- ============================================================== -->
    </div>
    <!-- END wrapper -->
    <!--<script type="text/javascript">
        //DatePicker



        $(document).ready(function () {


            //if (JSON.parse(GENERAL.RIDEPAT.getRidePatList()).length != 0) {
            //    arr_customer = JSON.parse(GENERAL.RIDEPAT.getRidePatList());
            //    if (arr_customer.func != "show") {
            //    }
            //}


        });
    </script>-->
</body>
</html>
