CREATE PROCEDURE [dbo].[spVolunteerTypeView_GetVolunteersList_All_FAST]
AS
BEGIN
    SET NOCOUNT ON;

    /* ===============================
       Absence – computed, no UPDATE
    =============================== */
    SELECT
        VolunteerId,
        CAST(1 AS BIT) AS AbsenceStatus
    INTO #tempAbsence
    FROM Absence
    WHERE GETDATE() BETWEEN FromDate AND DATEADD(DAY, 1, UntilDate)
      AND IsDeleted = 0
    GROUP BY VolunteerId;

    /* ===============================
       Latest drive per volunteer
    =============================== */
    SELECT
        MainDriver AS Id,
        MAX(PickupTime) AS LatestDrive
    INTO #tempLatestDrives
    FROM UnityRide
    WHERE Status != N'נמחקה'
    GROUP BY MainDriver;

    /* ===============================
       Rides count last 2 months
    =============================== */
    SELECT
        MainDriver AS Id,
        COUNT(DISTINCT PickupTime) AS NumOfRides_last2Months
    INTO #tempRidesLast2Months
    FROM UnityRide
    WHERE Status != N'נמחקה'
      AND PickupTime BETWEEN DATEADD(MONTH, -2, GETDATE()) AND GETDATE()
    GROUP BY MainDriver;

    /* ===============================
       Most common path (last 50 rides)
    =============================== */
    WITH Last50 AS (
        SELECT
            MainDriver,
            Origin,
            Destination,
            ROW_NUMBER() OVER (
                PARTITION BY MainDriver
                ORDER BY PickupTime DESC
            ) AS rn
        FROM UnityRide
        WHERE Status != N'נמחקה'
    ),
    PathStats AS (
        SELECT
            MainDriver,
            Origin + '-' + Destination AS MostCommonPath,
            COUNT(*) AS Cnt,
            ROW_NUMBER() OVER (
                PARTITION BY MainDriver
                ORDER BY COUNT(*) DESC
            ) AS rn
        FROM Last50
        WHERE rn <= 50
        GROUP BY MainDriver, Origin, Destination
    )
    SELECT *
    INTO #tempMostCommonPath
    FROM PathStats
    WHERE rn = 1;

    /* ===============================
       Final SELECT – NULL SAFE
    =============================== */
    SELECT
        vtv.Id,
        vtv.DisplayName,
        vtv.FirstNameA,
        vtv.FirstNameH,
        vtv.LastNameH,
        vtv.LastNameA,
        vtv.CellPhone,
        vtv.CellPhone2,
        vtv.HomePhone,
        vtv.Remarks,
        vtv.CityCityName,
        vtv.Address,
        vtv.VolunTypeType,
        vtv.Email,
        vtv.Device,
        vtv.NoOfDocumentedCalls,
        vtv.NoOfDocumentedRides,
        ISNULL(vtv.No_of_Rides, 0) AS No_of_Rides,
        vtv.JoinDate,

        -- 🔒 BIT fields – NULL SAFE
        ISNULL(vtv.IsAssistant, 0)   AS IsAssistant,
        ISNULL(vtv.IsActive, 0)      AS IsActive,
        ISNULL(vtv.KnowsArabic, 0)   AS KnowsArabic,
        ISNULL(vtv.IsDriving, 0)     AS IsDriving,
        ISNULL(vtv.IsBooster, 0)     AS IsBooster,
        ISNULL(vtv.IsBabyChair, 0)   AS IsBabyChair,

        vtv.Gender,
        vtv.PnRegId,
        vtv.EnglishName,
        DATEADD(HOUR, -2, vtv.LastModified) AS LastModified,
        ISNULL(vtv.AvailableSeats, 0) AS AvailableSeats,

        ISNULL(r2m.NumOfRides_last2Months, 0) AS NumOfRides_last2Months,
        ISNULL(a.AbsenceStatus, 0)            AS AbsenceStatus,
        mcp.MostCommonPath,
        ld.LatestDrive

    FROM VolunteerTypeView vtv
    LEFT JOIN #tempLatestDrives      ld  ON ld.Id = vtv.Id
    LEFT JOIN #tempRidesLast2Months r2m ON r2m.Id = vtv.Id
    LEFT JOIN #tempAbsence          a   ON a.VolunteerId = vtv.Id
    LEFT JOIN #tempMostCommonPath   mcp ON mcp.MainDriver = vtv.Id
    ORDER BY vtv.FirstNameH;

    DROP TABLE #tempAbsence;
    DROP TABLE #tempLatestDrives;
    DROP TABLE #tempRidesLast2Months;
    DROP TABLE #tempMostCommonPath;
END
GO



------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------





------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------





------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------







------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------











------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------













------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------