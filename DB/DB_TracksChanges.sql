
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE TYPE TableNameList AS TABLE
(
    TableName NVARCHAR(128)
);
GO

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- =======================================================
-- Create Stored Procedure Template for Azure SQL Database
-- =======================================================
/****** Object:  StoredProcedure [dbo].[sp_getTablesStracture]    Script Date: 2/5/2026 8:59:02 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:      <Gilad Meirson>
-- Create Date: <11/30/25>
-- Description: <get the stracture of spesific tables>
-- =============================================
CREATE PROCEDURE [dbo].[sp_getTablesStracture]
(
    -- Add the parameters for the stored procedure here
        @Tables TableNameList READONLY

)
AS
BEGIN

    -- Insert statements for procedure here
    SELECT 
        TABLE_NAME,
        COLUMN_NAME,
        DATA_TYPE,
        IS_NULLABLE,
        CHARACTER_MAXIMUM_LENGTH
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_NAME IN (SELECT TableName FROM @Tables) AND
	COLUMN_NAME IN (
	'RidePatNum',
	'PatientName',
	'PatientCellPhone',
	'PatientId',
	'PatientGender',
	'PatientStatus',
	'PatientBirthDate',
	'AmountOfEscorts',
	'AmountOfEquipments',
	'Destination',
	'Origin',
	'pickupTime',
	'Coordinator',
	'Remark',
	'Status',
	'Area',
	'OnlyEscort',
	'lastModified',
	'CoordinatorID',
	'MainDriver',
	'DriverName',
	'DriverCellPhone',
	'NoOfDocumentedRides',
	'IsAnonymous',
	'IsNewDriver',
	'Id',
	'DisplayName',
	'CellPhone',
	'CellPhone2',
	'Address',
	'JoinDate',
	'IsActive',
	'Gender',
	'Remarks',
	'CityCityName',
	'AvailableSeats',
	'VolunteerIdentity',
	'isDriving',
	'joinYear',
	'NoOfDocumentedCalls',
	'NoOfDocumentedRides',
	'LastUpdateBy',
	'No_of_Rides',
	'IsBooster',
	'IsBabyChair'
	)
    ORDER BY TABLE_NAME, ORDINAL_POSITION;
END



------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE TABLE Executions(
	ExecId INT IDENTITY(1,1) PRIMARY KEY,
    UserPhone NVARCHAR(20)      NULL,
    UserName NVARCHAR(55)      NULL,
    ExecutionTime DATETIME2     NOT NULL,
    SqlQuery NVARCHAR(MAX)      NULL,
    AiDescription NVARCHAR(MAX) NULL,
    UserPrompt NVARCHAR(MAX)    NULL,
    RelatedTables NVARCHAR(100) NULL
)


------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


-- =======================================================
-- Create Stored Procedure Template for Azure SQL Database
-- =======================================================
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:      <Gilad Meirson>
-- Create Date: <10/02/2026>
-- Description: <insert values to execution table>
-- =============================================
CREATE PROCEDURE SP_insertValuesToExecutions
(
    -- Add the parameters for the stored procedure here
	@UserPhone NVARCHAR(20) = NULL,
    @UserName NVARCHAR(55) = NULL,
    @ExecutionTime DATETIME2,
    @SqlQuery NVARCHAR(MAX) = NULL,
    @AiDescription NVARCHAR(MAX) = NULL,
    @UserPrompt NVARCHAR(MAX) = NULL,
    @RelatedTables NVARCHAR(100) = NULL
)
AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON

    INSERT INTO Executions
    (
        UserPhone,
        UserName,
        ExecutionTime,
        SqlQuery,
        AiDescription,
        UserPrompt,
        RelatedTables
    )
    VALUES
    (
        @UserPhone,
        @UserName,
        @ExecutionTime,
        @SqlQuery,
        @AiDescription,
        @UserPrompt,
        @RelatedTables
    );

    -- מחזיר את ה-ID שנוצר
    SELECT SCOPE_IDENTITY() AS NewExecId;
END
GO




------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
/****** Object:  StoredProcedure [dbo].[sp_getUnityRidesSplit]    Script Date: 2/11/2026 5:01:21 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:      <Gilad Meirson>
-- Create Date: <21/10/2025>
-- Modified:    <10/12/2025> - Added EquipmentList to avoid N+1 problem
-- Modified:    <31/01/2026> - Added afternoon detection for rides >= 12:00
-- Description: <try to split the unityRide packs to improve load times>
-- =============================================
ALTER PROCEDURE [dbo].[sp_getUnityRidesSplit]
(
    @ride_date datetime,
    @isAfternoon bit,
    @isFutureTable bit,
    @days smallint
)
AS
BEGIN
    SET NOCOUNT ON;
    
    IF(@isFutureTable = 0)
    BEGIN
        SELECT 
            u.*,
            NULLIF(p.CellPhone, '') AS CellPhone,
            NULLIF(p.CellPhone2, '') AS PatientCellPhone2,
            NULLIF(p.HomePhone, '') AS PatientCellPhone3,
            (
                SELECT STRING_AGG(EquipmentName, ',') WITHIN GROUP (ORDER BY EquipmentName)
                FROM EquipmentForPatientView E
                WHERE E.id = u.PatientId
            ) AS EquipmentList
        FROM UnityRide AS u
        LEFT JOIN Patient AS p ON p.Id = u.PatientId
        WHERE u.Status <> N'נמחקה'
            AND CONVERT(DATE, @ride_date) = CONVERT(DATE, u.PickupTime)
            AND (
                (
                    @isAfternoon = 1 
                    AND (DATEPART(MINUTE, u.PickupTime) = 14 OR DATEPART(HOUR, u.PickupTime) >= 10)
                )
                OR
                (
                    ISNULL(@isAfternoon, 0) = 0 
                    AND DATEPART(MINUTE, u.PickupTime) <> 14 
                    AND DATEPART(HOUR, u.PickupTime) < 10
                )
            )
    END
    ELSE IF(@isFutureTable = 1)
    BEGIN
        SELECT 
            u.*,
            NULLIF(p.CellPhone, '') AS CellPhone,
            NULLIF(p.CellPhone2, '') AS PatientCellPhone2,
            NULLIF(p.HomePhone, '') AS PatientCellPhone3,
            (
                SELECT STRING_AGG(EquipmentName, ',') WITHIN GROUP (ORDER BY EquipmentName)
                FROM EquipmentForPatientView E
                WHERE E.id = u.PatientId
            ) AS EquipmentList
        FROM UnityRide AS u
        LEFT JOIN Patient AS p ON p.Id = u.PatientId
        WHERE 
            CONVERT(DATE, u.PickupTime) BETWEEN
                CONVERT(DATE, DATEADD(DAY, 3, GETDATE())) AND
                CONVERT(DATE, DATEADD(DAY, @days, GETDATE()))
            AND u.Status <> N'נמחקה'
    END
    ELSE
    BEGIN
        SELECT -1 AS RidePatNum, 'Error @isFutureTable is not defined' AS error
    END
END





------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------