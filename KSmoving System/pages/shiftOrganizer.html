<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="description" content="KSMoving">
    <meta name="author" content="Coderthemes">

    <link rel="shortcut icon" href="assets/images/favicon_1.ico">

    <title>סידור עבודה</title>

    <!-- DataTables -->
    <link href="../plugins/datatables/jquery.dataTables.min.css" rel="stylesheet" type="text/css" />
    <link href="../plugins/datatables/buttons.bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../plugins/datatables/fixedHeader.bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../plugins/datatables/responsive.bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../plugins/datatables/scroller.bootstrap.min.css" rel="stylesheet" type="text/css" />

    <link href="../plugins/nestable/jquery.nestable.css" rel="stylesheet" />

    <link href="../plugins/switchery/switchery.min.css" rel="stylesheet" />
    <link href="assets/css/bootstrap-rtl.min.css" rel="stylesheet" type="text/css">
    <link href="assets/css/core.css" rel="stylesheet" type="text/css">
    <link href="assets/css/icons.css" rel="stylesheet" type="text/css">
    <link href="assets/css/components.css" rel="stylesheet" type="text/css">
    <link href="assets/css/pages.css" rel="stylesheet" type="text/css">
    <link href="assets/css/menu.css" rel="stylesheet" type="text/css">
    <link href="assets/css/responsive.css" rel="stylesheet" type="text/css">

    <script src="assets/js/CookiesFunctions.js"></script>

    <script src="assets/js/modernizr.min.js"></script>

    <!-- Sweet Alert css -->
    <link href="../plugins/bootstrap-sweetalert/sweet-alert.css" rel="stylesheet" type="text/css" />

    <!--GENERAL object and additional functions-->
    <script src="lib/master.js"></script>

    <script src="assets/js/jquery.min.js"></script>

    <!-- Select2 css+js -->
    <link href="assets/css/select2.css" rel="stylesheet" />
    <script src="assets/js/select2.min.js"></script>

    <style>
        .rightColDivider {
            border-right: 3px solid #88a9b9;
        }
    </style>

    <script>
       // checkCookie();
        distanceArr =
            [
                [0, 1.4, 2.3, 2.5, 3.5, 4.5, 5, 7.5],
                [1.4, 0, 1.7, 1.2, 2.8, 4, 3.8, 6.7],
                [2.3, 1.7, 0, 1, 2, 2.5, 3, 5.3],
                [2.5, 1.2, 1, 0, 1.5, 2.7, 2.8, 5.5],
                [3.5, 2.8, 2, 1.5, 0, 1.5, 1.2, 4],
                [4.5, 4, 2.5, 2.7, 1.5, 0, 1.3, 3.2],
                [5, 3.8, 3, 2.8, 1.2, 1.3, 0, 3],
                [7.5, 6.7, 5.3, 5.5, 4, 3.2, 3, 0]
            ]

        function generateDays() {

        }

        function generateDays() {
            debugger;
            arr = ["ראשון","שני","שלישי","רביעי","חמישי","שישי"];
            var $selectDay = $("#dayChoice");
            $('<option>', { value: -1, text: 'בחר' }).attr({ 'selected': '', 'disabled': '' }).appendTo($selectDay);
            var today = new Date();
            var dayToday = today.getDay();
            var i = dayToday;
            var count = 0;
            while (count < 6) {
                if (i != 6) {
                if (count == 0) {
                    $('<option>', { value: i, text: "היום" }).appendTo($selectDay);
                }
                else if (count == 1) {
                    $('<option>', { value: i, text: "מחר" }).appendTo($selectDay);
                }
                else {
                    $('<option>', { value: i, text: arr[i] }).appendTo($selectDay);
                }
                }

                i++;
                count++;
                if (i==6 || i==7) {
                    i = 0;
                }
            }
        }


        function generateShiftOrganizer() {
            //checkCookie();
            var arr_generateShifts = JSON.parse(localStorage.shiftsList);
            var arr_setShifts = [];
            var arr_setShiftsNum = [];
            var $bank = $("#nestable_list_shiftBank");
            $bank.empty();

            var allAssigned = true;
            var numOfShiftsToSet = arr_generateShifts.length;
            var shiftsPrefered = 0;
            var arr_shiftsPrefered = [];

            for (i in arr_generateShifts) {

                if (arr_generateShifts[i].Customer.PreferedDrivers.DriverID != 5) {
                    arr_setShifts.push(arr_generateShifts[i]);
                    //arr_generateShifts[i] = null; //remove the set shift from shifts list
                    arr_shiftsPrefered[i] = true;
                    arr_setShiftsNum.push(i);
                    shiftsPrefered++;
                }
                else {
                    arr_shiftsPrefered[i] = false;
                }

            }

            //set shifts for prefered drivers
            var arr_driverListShifts = [];

            for (i in arr_drivers) {

                //var driverHasShifts = false;
                var arr_driverShifts = [];
                var arr_driverShiftsNum = [];
                var shiftsCount = 0;
                var arr_driverPossibleShifts = [];
                var arr_driverPossibleShiftsNum = [];
                var possibleShiftsCount = 0;
                var totalPreferedShiftTime = 0;

                //checks if there are set shifts for the driver and saves them in arr_driverShifts
                for (d in arr_setShifts) {
                    if (arr_setShifts[d].Customer.PreferedDrivers.DriverID == arr_drivers[i].DriverID) {
                        driverHasShifts = true;
                        arr_driverShifts.push(arr_setShifts[d]);
                        arr_driverShiftsNum.push(arr_setShiftsNum[d]);
                        shiftsCount++;
                        totalPreferedShiftTime += arr_setShifts[d].AddTime + arr_setShifts[d].DeliveryDuration;
                    }
                }
                for (a in arr_generateShifts) {
                    if (arr_generateShifts[a] != null && !arr_shiftsPrefered[a]) {
                        //checks if the shift's license and certifications match the driver's
                        if (arr_drivers[i].LicenseType.DriverLicenseTypeName == arr_generateShifts[a].OrderLicenseType.DriverLicenseTypeName || arr_drivers[i].LicenseType.DriverLicenseTypeName == 'E') {
                            if (arr_generateShifts[a].OrderCertificationType.DriverLicenseTypeName == 0) {
                                arr_driverPossibleShifts.push(arr_generateShifts[a]);
                                arr_driverPossibleShiftsNum.push(a);
                                possibleShiftsCount++;
                            }
                            else if (arr_drivers[i].CertificationType.DriverLicenseTypeName != 0 && arr_drivers[i].CertificationType.DriverLicenseTypeName <= arr_generateShifts[a].OrderCertificationType.DriverLicenseTypeName) {
                                arr_driverPossibleShifts.push(arr_generateShifts[a]);
                                arr_driverPossibleShiftsNum.push(a);
                                possibleShiftsCount++;
                            }
                        }
                    }
                }

                arr_driverListShifts.push({
                    "driverID": arr_drivers[i].DriverID,
                    "driverArrNum": i,
                    "driverShifts": arr_driverShifts,
                    "driverShiftsNum": arr_driverShiftsNum,
                    "shiftsCount": shiftsCount,
                    "leftShiftCount": shiftsCount,
                    "driverPossibleShifts": arr_driverPossibleShifts,
                    "driverPossibleShiftsNum": arr_driverPossibleShiftsNum,
                    "possibleShiftsCount": possibleShiftsCount,
                    "leftPosibilities": possibleShiftsCount,
                    "driverFinalShifts": [],
                    "driverFinalShiftsCount": 0,
                    "totalPreferedShiftTime": totalPreferedShiftTime,
                    "totalTime": 0
                });

            }

            var numDrivers = arr_drivers.length;
            var i = 0;
            var roundCount = 1;
            var shiftsSetInRound = true;
            var shiftsSet = 0;

            while (shiftsPrefered > 0 || shiftsSetInRound) {
                var driver = arr_drivers[arr_driverListShifts[i].driverArrNum];
                var Arr_driverShifts = arr_driverListShifts[i].driverShifts;
                var Arr_driverShiftsNum = arr_driverListShifts[i].driverShiftsNum;
                var shiftCount = arr_driverListShifts[i].shiftsCount;
                var leftShiftCount = arr_driverListShifts[i].leftShiftCount;
                var posibilities = arr_driverListShifts[i].possibleShiftsCount;
                var leftPosibilities = arr_driverListShifts[i].leftPosibilities;
                var Arr_posibilities = arr_driverListShifts[i].driverPossibleShifts;
                var Arr_posibilitiesNum = arr_driverListShifts[i].driverPossibleShiftsNum;
                var finalShiftsCount = arr_driverListShifts[i].driverFinalShiftsCount;
                var FinalShifts = arr_driverListShifts[i].driverFinalShifts;
                var totalTime = arr_driverListShifts[i].totalTime;
                var totalPreferedShiftTime = arr_driverListShifts[i].totalPreferedShiftTime;
                var enoughTime = false; //FLAG to indicate if there enough time to set possible shifts for driver

                //distance settings
                var minDistance = 100;
                var minShift;
                if (finalShiftsCount > 0) {
                    var from = FinalShifts[finalShiftsCount - 1].ShipTo.CustomerCity.Zone;
                }
                else if (finalShiftsCount == 0) {
                    var from = driver.CityLiving.Zone;
                }


                if (roundCount > shiftCount && totalTime <= 11) {

                    //algorithm with prefered driver
                    if (leftShiftCount > 0) {
                        //only prefered driver orders
                        if (leftPosibilities == 0) {

                            for (var j = 0; j < shiftCount; j++) {
                                if (Arr_driverShifts[j] != null) {
                                    var to = Arr_driverShifts[j].ShipFrom.CustomerCity.Zone;
                                    if (Arr_driverShifts[j].AddTime + Arr_driverShifts[j].DeliveryDuration + totalTime <= 11) {
                                        enoughTime = true;
                                        if (minDistance > distanceArr[from - 1][to - 1]) {
                                            minDistance = distanceArr[from - 1][to - 1];
                                            minShift = j;
                                        }
                                    }
                                }
                            }

                            if (leftPosibilities + leftShiftCount > 0 && enoughTime) {
                                arr_driverListShifts[i].driverFinalShifts.push(Arr_driverShifts[minShift]);
                                arr_driverListShifts[i].totalTime += Arr_driverShifts[minShift].AddTime + Arr_driverShifts[minShift].DeliveryDuration;
                                arr_driverListShifts[i].totalPreferedShiftTime -= Arr_driverShifts[minShift].AddTime + Arr_driverShifts[minShift].DeliveryDuration;
                                arr_generateShifts[Arr_driverShiftsNum[minShift]] = null;
                                arr_driverListShifts[i].driverShifts[minShift] = null;
                                arr_driverListShifts[i].driverShiftsNum[minShift] = null;
                                arr_driverListShifts[i].driverFinalShiftsCount++;
                                arr_driverListShifts[i].leftShiftCount--;
                                numOfShiftsToSet--;
                                shiftsPrefered--;
                                shiftsSet++;
                                
                            }
                        }
                            //prefered driver orders + possible orders
                        else {
                            var minDistancePrefered = 100;
                            var minShiftPrefered;
                            var minDistancePos = 100;
                            var minShiftPos;

                            for (var j = 0; j < shiftCount; j++) {
                                if (Arr_driverShifts[j] != null) {
                                    var to = Arr_driverShifts[j].ShipFrom.CustomerCity.Zone;
                                    if (Arr_driverShifts[j].AddTime + Arr_driverShifts[j].DeliveryDuration + totalTime <= 11) {
                                        enoughTime = true;
                                        if (minDistancePrefered > distanceArr[from - 1][to - 1]) {
                                            minDistancePrefered = distanceArr[from - 1][to - 1];
                                            minShiftPrefered = j;
                                        }
                                    }
                                }
                            }

                            for (var j = 0; j < posibilities ; j++) {
                                if (Arr_posibilitiesNum[j] != null) {
                                    if (arr_generateShifts[Arr_posibilitiesNum[j]] != null) {
                                        var to = Arr_posibilities[j].ShipFrom.CustomerCity.Zone;
                                        if (totalPreferedShiftTime + Arr_posibilities[j].AddTime + Arr_posibilities[j].DeliveryDuration + totalTime <= 11) {
                                            enoughTime = true;

                                            if (minDistancePos > distanceArr[from - 1][to - 1]) {
                                                minDistancePos = distanceArr[from - 1][to - 1];
                                                minShiftPos = j;
                                            }
                                        }
                                    }
                                    else {
                                        arr_driverListShifts[i].driverPossibleShifts[j] = null;
                                        arr_driverListShifts[i].leftPosibilities--;
                                        leftPosibilities--;
                                        arr_driverListShifts[i].driverPossibleShiftsNum[j] = null;
                                    }
                                }
                            }

                            if (leftPosibilities + leftShiftCount > 0 && enoughTime) {

                                //need to set from Possible ARR
                                if (minDistancePos < minDistancePrefered) {
                                    minDistance = minDistancePos;
                                    minShift = minShiftPos;

                                    arr_driverListShifts[i].driverFinalShifts.push(Arr_posibilities[minShift]);
                                    arr_driverListShifts[i].totalTime += Arr_posibilities[minShift].AddTime + Arr_posibilities[minShift].DeliveryDuration;
                                    arr_generateShifts[Arr_posibilitiesNum[minShift]] = null;
                                    arr_driverListShifts[i].driverPossibleShiftsNum[minShift] = null;
                                    arr_driverListShifts[i].driverPossibleShifts[minShift] = null;
                                    arr_driverListShifts[i].driverFinalShiftsCount++;
                                    arr_driverListShifts[i].leftPosibilities--;
                                    numOfShiftsToSet--;
                                    shiftsSet++;
                                }
                                    //need to set from Prefered Shifts ARR
                                else {
                                    minDistance = minDistancePrefered;
                                    minShift = minShiftPrefered;

                                    arr_generateShifts[Arr_driverShiftsNum[minShift]] = null;
                                    arr_driverListShifts[i].driverFinalShifts.push(Arr_driverShifts[minShift]);
                                    arr_driverListShifts[i].totalTime += Arr_driverShifts[minShift].AddTime + Arr_driverShifts[minShift].DeliveryDuration;
                                    arr_driverListShifts[i].totalPreferedShiftTime -= Arr_driverShifts[minShift].AddTime + Arr_driverShifts[minShift].DeliveryDuration;
                                    arr_driverListShifts[i].driverShifts[minShift] = null;
                                    arr_driverListShifts[i].driverShiftsNum[minShift] = null;
                                    arr_driverListShifts[i].driverFinalShiftsCount++;
                                    arr_driverListShifts[i].leftShiftCount--;
                                    numOfShiftsToSet--;
                                    shiftsPrefered--;
                                    shiftsSet++;
                                }
                            }
                        }
                    }

                        //algorithm without prefered driver
                    else if (leftPosibilities > 0) {

                        for (var j = 0; j < posibilities ; j++) {
                            if (Arr_posibilitiesNum[j] != null) {
                                if (arr_generateShifts[Arr_posibilitiesNum[j]] != null) {
                                    var to = Arr_posibilities[j].ShipFrom.CustomerCity.Zone;
                                    if (Arr_posibilities[j].AddTime + Arr_posibilities[j].DeliveryDuration + totalTime <= 11) {
                                        enoughTime = true;
                                        if (minDistance > distanceArr[from - 1][to - 1]) {
                                            minDistance = distanceArr[from - 1][to - 1];
                                            minShift = j;
                                        }
                                    }
                                }
                                else {
                                    arr_driverListShifts[i].driverPossibleShifts[j] = null;
                                    arr_driverListShifts[i].leftPosibilities--;
                                    leftPosibilities--;
                                    arr_driverListShifts[i].driverPossibleShiftsNum[j] = null;
                                }
                            }
                        }
                        if (leftPosibilities + leftShiftCount > 0 && enoughTime) {
                            arr_driverListShifts[i].driverFinalShifts.push(Arr_posibilities[minShift]);
                            arr_driverListShifts[i].totalTime += Arr_posibilities[minShift].AddTime + Arr_posibilities[minShift].DeliveryDuration;
                            arr_generateShifts[Arr_posibilitiesNum[minShift]] = null;
                            arr_driverListShifts[i].driverPossibleShiftsNum[minShift] = null;
                            arr_driverListShifts[i].driverPossibleShifts[minShift] = null;
                            arr_driverListShifts[i].driverFinalShiftsCount++;
                            arr_driverListShifts[i].leftPosibilities--;
                            numOfShiftsToSet--;
                            shiftsSet++;
                        }
                    }
                    if (!enoughTime && arr_driverListShifts[i].leftShiftCount) {
                        shiftsPrefered -= arr_driverListShifts[i].leftShiftCount
                        arr_driverListShifts[i].leftShiftCount = 0;
                    }
                }



                i++;
                if (i == numDrivers) {
                    i = 0;
                    roundCount++;
                    if (shiftsSet == 0) {
                        shiftsSetInRound = false;
                    }
                    shiftsSet = 0;
                }
            }

            if (numOfShiftsToSet > 0) {
                for (var i = 0; i < arr_generateShifts.length; i++) {
                    if (arr_generateShifts[i] != null) {
                        if (allAssigned) {
                            var $ol = $("<ol>").attr({ 'class': 'dd-list' });
                            $bank.append($ol);
                            allAssigned = false;
                        }
                        var $li = $("<li>").attr({ 'class': 'dd-item', 'data-id': arr_generateShifts[i].OrderID });
                        var $div = $("<div>").attr({ 'class': 'dd-handle' }).text(arr_generateShifts[i].OrderID + "-" + arr_generateShifts[i].Customer.CustomerName + "-" + arr_generateShifts[i].OrderService.Service + ", " + arr_generateShifts[i].ShipFrom.AddressName + "->" + arr_generateShifts[i].ShipTo.AddressName);
                        $li.append($div);
                        $ol.append($li);
                    }
                }
            }

            if (allAssigned) {
                var $divEmpty = $("<div>").attr({ 'class': 'dd-empty' });
                $bank.append($divEmpty);
            }

            for (var i = 0; i < arr_driverListShifts.length; i++) {

                var $divList = $("#nestable_list_" + arr_driverListShifts[i].driverID);
                $divList.empty();

                var $divEmpty = $("<div>").attr({ 'class': 'dd-empty' });
                var $ol = $("<ol>").attr({ 'class': 'dd-list', 'id': 'driverList' + arr_driverListShifts[i].driverID });

                for (s in arr_driverListShifts[i].driverFinalShifts) {
                    var $li = $("<li>").attr({ 'class': 'dd-item', 'data-id': arr_driverListShifts[i].driverFinalShifts[s].OrderID});
                    var $div = $("<div>").attr({ 'class': 'dd-handle' }).text(arr_driverListShifts[i].driverFinalShifts[s].OrderID + "-" + arr_driverListShifts[i].driverFinalShifts[s].Customer.CustomerName + "-" + arr_driverListShifts[i].driverFinalShifts[s].OrderService.Service + ", " + arr_driverListShifts[i].driverFinalShifts[s].ShipFrom.AddressName + "->" + arr_driverListShifts[i].driverFinalShifts[s].ShipTo.AddressName);
                    $li.append($div);
                    $ol.append($li);
                }


                if (arr_driverListShifts[i].driverFinalShiftsCount > 0) {
                    $divList.append($ol);
                }
                else {
                    $divList.append($divEmpty);
                }
            }

            initDriversNestable();

            initBankNestable();
        }

        Date.prototype.addDays = function (days) {
            var dat = new Date(this.valueOf());
            dat.setDate(dat.getDate() + days);
            return dat;
        }

        function selectShiftDate() {
            var today = new Date();
            var dayToday = today.getDay();

            var selectedDay = $("#dayChoice").val();
            var addedDays = 0;

            if (selectedDay == null) {
                swal({
                    title: "אנא בחר יום ליצירת סידור",
                    type: "warning",
                    timer: 1000,
                    showConfirmButton: false
                });
            }

            else {
                if (selectedDay >= dayToday) {
                    addedDays = selectedDay - dayToday;
                }
                else {
                    addedDays = selectedDay - dayToday + 7;
                }
            
            var selectedDate = today.addDays(addedDays);
            refreshTable(selectedDate);
            }
        }


        function cleanShiftOrganizer() {
            //checkCookie();
            location.reload();
        }


        function viewCurrentShiftTable() {
            //checkCookie();
            var allDriversShifts = [];
            var arr_generateShifts = JSON.parse(localStorage.shiftsList);
            
            for (var i = 0; i < arr_drivers.length; i++) {
                $('#nestable_list_' + arr_drivers[i].DriverID).children().each(function () {
                    var driverShift = [];
                    $(this).find('li').each(function () {
                        var thisShiftID = $(this).attr('data-id')
                        for (k in arr_generateShifts)
                        {
                            if (arr_generateShifts[k].OrderID == thisShiftID) {
                                driverShift.push(arr_generateShifts[k])
                            }
                        }
                    });

                    

                    var TruckNum = $("#driver" + arr_drivers[i].DriverID + " option:selected").text();

                    allDriversShifts.push({
                        "Driver": arr_drivers[i],
                        "TruckNum": TruckNum,
                        "driverShifts": driverShift
                    });
                });
            }


            var $tbody = $("#currentShiftsBody");
            $tbody.empty();

            for (var j = 0; j < allDriversShifts.length; j++) {
            for (var k = 0; k < allDriversShifts[j].driverShifts.length; k++) {
                var $tr = $("<tr>");

                var $tdDriver = $("<td>").text(allDriversShifts[j].Driver.FirstName + " " + allDriversShifts[j].Driver.LastName);
                var $tdTruck = $("<td>").text(allDriversShifts[j].TruckNum);

                var $tdOrderID = $("<td>").text(allDriversShifts[j].driverShifts[k].OrderID);
                var $tdCustomer = $("<td>").text(allDriversShifts[j].driverShifts[k].Customer.CustomerName);
                var $tdService = $("<td>").text(allDriversShifts[j].driverShifts[k].OrderService.Service);
                var $tdFrom = $("<td>").text(allDriversShifts[j].driverShifts[k].ShipFrom.AddressName);
                var $tdTo = $("<td>").text(allDriversShifts[j].driverShifts[k].ShipTo.AddressName);
                var $tdTime = $("<td>").text(allDriversShifts[j].driverShifts[k].AddTime + allDriversShifts[j].driverShifts[k].DeliveryDuration);
                var $tdLicense = $("<td>").text(allDriversShifts[j].driverShifts[k].OrderLicenseType.DriverLicenseTypeName);
                var $tdCertification = $("<td>").text(allDriversShifts[j].driverShifts[k].OrderCertificationType.DriverLicenseTypeName + " " + allDriversShifts[j].driverShifts[k].OrderCertificationType.DriverLicenseTypeDescription);
                var $tdComments = $("<td>").text(allDriversShifts[j].driverShifts[k].Comments);
                
                if (k + 1 == allDriversShifts[j].driverShifts.length) {
                    $tr.css({ "border-bottom": "solid 3px grey" });
                }

                $tr.append($tdDriver).append($tdTruck).append($tdOrderID).append($tdCustomer).append($tdService).append($tdFrom).append($tdTo).append($tdTime).append($tdLicense).append($tdCertification).append($tdComments);
                $tbody.append($tr);
            }

            }

        }

        function saveShiftOrganizer() {
            var allDriversShifts = [];
            for (var i = 0; i < arr_drivers.length; i++) {
                $('#nestable_list_' + arr_drivers[i].DriverID).children().each(function () {
                    var driverShift = [];
                    $(this).find('li').each(function () {
                        driverShift.push($(this).attr('data-id'));
                    });

                    var truckID = $("#driver" + arr_drivers[i].DriverID + " option:selected").val();

                    allDriversShifts.push({
                        "DriverID": arr_drivers[i].DriverID,
                        "TruckID": truckID,
                        "driverShiftIDs": driverShift
                    });
                });
            }

            var bankShift = [];
            $('#nestable_list_shiftBank').children().each(function () {
                $(this).find('li').each(function () {
                    bankShift.push($(this).attr('data-id'));
                });
            });

            $.ajax({
                dataType: "json",
                url: "WebService.asmx/saveShifts",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                async: false,
                data: JSON.stringify({ allDriversShifts: allDriversShifts, bankShift: bankShift }),
                success: function (data) {
                    swal({
                        title: "סידור העבודה נשמר",
                        type: "success",
                        timer: 1000,
                        showConfirmButton: false
                    });
                    setTimeout(function () {
                        location.reload();
                    }, 1001);
                },
                error: function (err) { alert("Error"); }
            });

        }

        function generateTruckLicense(chosenDate) {
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getAvailableTrucks",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                async: false,
                data: JSON.stringify({ chosenDate: chosenDate }),
                success: function (data) {
                    arr_trucks = JSON.parse(data.d);

                    generateDriversLists(chosenDate);
                },
                error: function (err) { alert("Error"); }
            });
        }


        //wait until the dom is loaded
        $(document).ready(function () {
            //adds menu.html content into any "#menu" element
            //$('#menu').load('menu.html');

            //Create a DataTable from the Table
          
            generateDays();

            t = $('#datatable-fixed-header').DataTable({ fixedHeader: true, 'pageLength': 100 });
            var day = new Date()
            refreshTable(day.addDays(1));
        });

        function initBankNestable() {
            !function ($) {
                "use strict";

                var Nestable = function () { };

                Nestable.prototype.updateOutput = function (e) {
                    var list = e.length ? e : $(e.target),
                        output = list.data('output');
                    if (window.JSON) {
                        output.val(window.JSON.stringify(list.nestable('serialize'))); //, null, 2));
                        if (list.nestable('serialize').length != 0) {
                            var arr_bank = list.nestable('serialize');
                            for (i in arr_bank) {
                                var orderID = arr_bank[i].id;
                                $("#row" + orderID).parent().parent().removeClass();

                            }
                        }
                    } else {
                        output.val('JSON browser support required for this demo.');
                    }
                },


                //init
                Nestable.prototype.init = function () {
                    $('#nestable_list_shiftBank').nestable({
                        group: 1,
                        maxDepth: 1
                    }).on('change', this.updateOutput);


                    //// output initial serialised data

                    this.updateOutput($('#nestable_list_shiftBank').data('output', $('#nestable_list_shiftBank_output')));

                },
                //init
                $.Nestable = new Nestable, $.Nestable.Constructor = Nestable
            }(window.jQuery),

            //initializing
function ($) {
    "use strict";
    $.Nestable.init()
}(window.jQuery);

        }

        function initDriversNestable() {
            !function ($) {
                //"use strict";

                var Nestable = function () { };

                Nestable.prototype.updateOutput = function (e) {
                    var list = e.length ? e : $(e.target),
                        output = list.data('output');
                    if (window.JSON) {
                        output.val(window.JSON.stringify(list.nestable('serialize'))); //, null, 2));
                        //if (list.nestable('serialize').length != 0) {
                        if (window.JSON.stringify(list.nestable('serialize')).length != 0) {


                            var arr_driver = list.nestable('serialize');
                            for (i in arr_driver) {
                                var orderID = arr_driver[i].id;
                                $("#row" + orderID).parent().parent().attr({ 'class': 'bg-success text-white' });
                            }
                        }
                    } else {
                        output.val('JSON browser support required for this demo.');
                    }
                },


                //init
                Nestable.prototype.init = function () {


                    for (i in arr_drivers) {
                        $('#nestable_list_' + arr_drivers[i].DriverID).nestable({
                            group: 1,
                            maxDepth: 1
                        }).on('change', this.updateOutput);

                        // output initial serialised data
                        this.updateOutput($('#nestable_list_' + arr_drivers[i].DriverID).data('output', $('#nestable_list_' + arr_drivers[i].DriverID + '_output')));
                    }

                },
                //init
                $.Nestable = new Nestable, $.Nestable.Constructor = Nestable
            }(window.jQuery),

            //initializing
function ($) {
    "use strict";
    $.Nestable.init()
}(window.jQuery);

        }


        function generateDriversLists(chosenDate) {
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getAvailableDrivers",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                async: false,
                data: JSON.stringify({ chosenDate: chosenDate }),
                success: function (data) {
                    arr_drivers = JSON.parse(data.d);
                    localStorage.driversList = arr_drivers;
                    var numOfRows = 0;
                    var $divDrivers = $("#driversPlace");
                    $divDrivers.empty();

                    if (arr_drivers.length % 3 == 0) {
                        numOfRows = (arr_drivers.length / 3);
                    }
                    else {
                        numOfRows = (arr_drivers.length / 3) + 1;
                    }

                    var i = 0
                    for (var k = 0; k < numOfRows; k++) {

                        var $divRow = $("<div>").attr({ 'class': 'row' });

                        for (var j = 0; j < 3 && i < arr_drivers.length; j++) {
                            //shifts that were already set to the specific driver
                            arr_driverShifts = [];

                            var $divCol = $("<div>").attr({ 'class': 'col-sm-4' });
                            var $DriverTitle = $("<h4>").attr({ 'class': 'm-t-0 header-title' });
                            var $b = $("<b>").text(arr_drivers[i].FirstName + " " + arr_drivers[i].LastName);
                            $DriverTitle.append($b);
                            $divCol.append($DriverTitle);

                            var driverHasShifts = false;

                            //checks if there are set shifts for the driver and saves them in arr_driverShifts
                            for (d in arr_setShifts) {
                                if (arr_setShifts[d].Driver.DriverID == arr_drivers[i].DriverID) {
                                    driverHasShifts = true;
                                    arr_driverShifts.push(arr_setShifts[d]);
                                    //arr_driverShiftsNum.push(d);
                                }
                            }

                            var $select = $("<select>").attr({ 'id': 'driver' + arr_drivers[i].DriverID, 'class': 'form-control' });

                            $('<option>', { value: -1, text: "בחר" }).attr({ 'selected': '', 'disabled': '' }).appendTo($select);

                            for (w in arr_trucks) {
                                //if driver HAS shifts -- sets selected truck from OrderLine
                                if (driverHasShifts && arr_driverShifts[0].Truck.TruckID == arr_trucks[w].TruckID) {
                                    $('<option>', { value: arr_trucks[w].TruckID, text: arr_trucks[w].TruckLicense }).prop('selected', true).appendTo($select);
                                }
                                    //if driver DOESN'T have shifts - sets selected truck from Driver's default
                                else if (!driverHasShifts && arr_drivers[i].DriverTruck.TruckID == arr_trucks[w].TruckID) {
                                    $('<option>', { value: arr_trucks[w].TruckID, text: arr_trucks[w].TruckLicense }).prop('selected', true).appendTo($select);
                                }
                                else {
                                    $('<option>', { value: arr_trucks[w].TruckID, text: arr_trucks[w].TruckLicense }).appendTo($select);
                                }
                            }

                            $divCol.append($select);

                            $select.select2();

                            var $divList = $("<div>").attr({ 'class': 'custom-dd dd', 'id': 'nestable_list_' + arr_drivers[i].DriverID });

                            var $divEmpty = $("<div>").attr({ 'class': 'dd-empty' });
                            var $ol = $("<ol>").attr({ 'class': 'dd-list', 'id': 'driverList' + arr_drivers[i].DriverID });

                            for (var x = 1; x <= arr_driverShifts.length; x++) {
                                for (s in arr_driverShifts) {
                                    if (arr_driverShifts[s].ShiftSort == x) {
                                        var $li = $("<li>").attr({ 'class': 'dd-item', 'data-id': arr_driverShifts[s].OrderID });
                                        var $div = $("<div>").attr({ 'class': 'dd-handle' }).text(arr_driverShifts[s].OrderID + "-" + arr_driverShifts[s].Customer.CustomerName + "-" + arr_driverShifts[s].OrderService.Service + ", " + arr_driverShifts[s].ShipFrom.AddressName + "->" + arr_driverShifts[s].ShipTo.AddressName);
                                        $li.append($div);
                                        $ol.append($li);
                                    }
                                }
                            }

                            if (driverHasShifts) {
                                $divList.append($ol);
                            }
                            else {
                                $divList.append($divEmpty);
                            }

                            $divCol.append($divList);
                            $divRow.append($divCol);

                            i++;
                        }

                        $divDrivers.append($divRow);
                    }

                    $(".select2-container").css({ 'width': '100%' }).attr({ 'dir': 'rtl' });

                    initDriversNestable();

                },
                error: function (err) { alert("Error"); }
            });
        }

        function refreshTable(date) {
            //checkCookie();
            var d = date;
            //d = d.addDays(1);
            var month = d.getMonth() + 1;
            var day = d.getDate();
            chosenDate = (day < 10 ? '0' : '') + day + '/' + (month < 10 ? '0' : '') + month + '/' + d.getFullYear();

            t.clear().draw();
            $.ajax({
                dataType: "json",
                url: "WebService.asmx/getOrdersForShifts",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                data: JSON.stringify({ active: true, selectedOrdersStatus: -1, startDate: chosenDate, endDate: chosenDate, selectedCustomer: -1, selectedService: -1 }),
                success: function (data) {
                    arr_shifts = JSON.parse(data.d);
                    localStorage.shiftsList = JSON.stringify(arr_shifts);

                    //shifts that were already assigned
                    arr_setShifts = [];

                    var $bank = $("#nestable_list_shiftBank");
                    $bank.empty();
                    var allAssigned = true;

                    for (i in arr_shifts) {

                        var strOrderLine = "<div id='row" + arr_shifts[i].OrderID + "'>" + arr_shifts[i].OrderID + "</div>";
                        t.row.add([strOrderLine, arr_shifts[i].Customer.CustomerName, arr_shifts[i].OrderService.Service, arr_shifts[i].ShipFrom.AddressName, arr_shifts[i].ShipTo.AddressName, arr_shifts[i].AddTime + arr_shifts[i].DeliveryDuration, arr_shifts[i].OrderLicenseType.DriverLicenseTypeName, arr_shifts[i].OrderCertificationType.DriverLicenseTypeName + " - " + arr_shifts[i].OrderCertificationType.DriverLicenseTypeDescription, arr_shifts[i].TotalPrice, arr_shifts[i].Comments]).draw(false);
                        t.columns([2]).order('desc').draw();

                        
                        if (arr_shifts[i].InShift == 'N') {
                            if (allAssigned) {
                                var $ol = $("<ol>").attr({ 'class': 'dd-list' });
                                $bank.append($ol);
                                allAssigned = false;
                            }

                            var $li = $("<li>").attr({ 'class': 'dd-item', 'data-id': arr_shifts[i].OrderID });
                            var $div = $("<div>").attr({ 'class': 'dd-handle' }).text(arr_shifts[i].OrderID + "-" + arr_shifts[i].Customer.CustomerName + "-" + arr_shifts[i].OrderService.Service + ", " + arr_shifts[i].ShipFrom.AddressName + "->" + arr_shifts[i].ShipTo.AddressName);
                            $li.append($div);
                            $ol.append($li);
                        }

                        else if (arr_shifts[i].InShift == 'Y') {
                            arr_setShifts.push(arr_shifts[i]);
                        }

                    }

                    if (allAssigned) {
                        var $divEmpty = $("<div>").attr({ 'class': 'dd-empty' });
                        $bank.append($divEmpty);
                    }

                    generateTruckLicense(chosenDate);
                    initBankNestable();

                },
                error: function (err) { alert("Error"); }
            });
        }


    </script>


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->


</head>


<body class="fixed-left">

    <!-- Begin page -->
    <div id="wrapper">

        <!-- Top Bar Start -->
        <div class="topbar">



            <!-- Navbar -->
            <div class="navbar navbar-default" role="navigation">
                <div class="container">
                    <div class="">
                        <!--Expend/Collaps Side Menue-->
                        <div class="pull-left">
                            <button class="button-menu-mobile open-left waves-effect">
                                <i class="md md-menu"></i>
                            </button>
                            <span class="clearfix"></span>
                        </div>

                        <!-- LOGO -->
                        <div class="pull-left">
                            <div class="text-center">
                                <a href="index.html" class="logo"><span>קסלסי סעדיה שירותי הובלה בע"מ</span>&nbsp&nbsp&nbsp<i class="ti-truck"></i>  </a>
                            </div>
                        </div>



                        <!--Search-->
                        <!--<form role="search" class="navbar-right app-search pull-right hidden-xs">
                            <input type="text" placeholder="חיפוש..." class="form-control app-search-input">
                            <a href=""><i class="fa fa-search"></i></a>
                        </form>-->
                    </div>
                    <!--/.nav-collapse -->
                </div>
            </div>
        </div>
        <!-- Top Bar End -->
        <!-- ========== Right Sidebar Start ========== -->
        <div class="left side-menu">

            <div class="sidebar-inner slimscrollleft">

                <div id="sidebar-menu">

                    <ul>

                        <li>
                            <a href="index.html" class="waves-effect waves-primary">
                                <i class="md md-dashboard"></i><span> דף הבית </span>
                            </a>
                        </li>

                        <li class="has_sub">
                            <a href="javascript:void(0);" class="waves-effect waves-primary">
                                <i class="md md-wallet-travel"></i> <span> ניהול הזמנות </span>
                                <span class="menu-arrow"></span>
                            </a>
                            <ul class="list-unstyled">
                                <li><a href="viewOrders.html">הזמנות</a></li>
                                <li><a href="viewDocuments.html">מסמכים</a></li>
                                <li><a href="viewInvoices.html">חשבוניות</a></li>
                                <li><a href="viewServices.html">מחירונים</a></li>
                            </ul>
                        </li>

                        <li>
                            <a href="shiftOrganizer.html" class="waves-effect waves-primary">
                                <i class="md md-today"></i><span> סידור עבודה</span>
                            </a>
                        </li>

                        <li>
                            <a href="viewCustomers.html" class="waves-effect waves-primary">
                                <i class="md md-recent-actors"></i><span> ניהול לקוחות</span>
                            </a>
                        </li>

                        <li class="has_sub">
                            <a href="javascript:void(0);" class="waves-effect waves-primary">
                                <i class="md md-local-shipping"></i> <span> ניהול משאיות </span>
                                <span class="menu-arrow"></span>
                            </a>
                            <ul class="list-unstyled">
                                <li><a href="viewTrucks.html">משאיות</a></li>
                                <li><a href="viewHandlings.html">טיפולים</a></li>
                            </ul>
                        </li>

                        <li class="has_sub">
                            <a href="javascript:void(0);" class="waves-effect waves-primary">
                                <i class="md md-person"></i> <span> ניהול הנהגים </span>
                                <span class="menu-arrow"></span>
                            </a>
                            <ul class="list-unstyled">
                                <li><a href="viewDrivers.html">נהגים</a></li>
                                <li><a href="viewDriverConstrains.html">זמינות הנהגים</a></li>
                            </ul>
                        </li>


                        <li>
                            <a href="viewReports.html" class="waves-effect waves-primary">
                                <i class="md md-poll"></i><span> דוחות</span>
                            </a>
                        </li>


                    </ul>
                    <div class="clearfix"></div>
                </div>

                <div class="clearfix"></div>
            </div>

        </div>
        <!-- Right Sidebar End -->
        <!-- ============================================================== -->
        <!-- Start page Content here -->
        <!-- ============================================================== -->
        <div class="content-page">
            <!-- Start content -->
            <div class="content">
                <div class="container">

                    <!-- Page-Title -->
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="page-title-box">
                                <ol class="breadcrumb pull-right">
                                    <li class="active">סידור עבודה</li>
                                </ol>
                                <h4 class="page-title">סידור עבודה</h4>
                            </div>
                        </div>
                    </div>

                    <!-- End row -->


                    <div class="row">
                        <div class="col-sm-12">

                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="card-box row">
                                        <div class="col-sm-2">
                                            <button type="button" id="generateShiftOrganizer" onclick="generateShiftOrganizer()" class="btn btn-inverse waves-effect w-md waves-light m-b-5"><i class="md md-open-with m-r-5"></i>צור</button>
                                        </div>
                                        <div class="col-sm-10 text-right">
                                            <button type="button" id="viewCurrentShiftTable" data-toggle='modal' data-target='#myModal' onclick="viewCurrentShiftTable()" class="btn btn-primary waves-effect w-md waves-light m-b-5"><i class="fa fa-table m-r-5"></i>הצג סידור נוכחי</button>
                                            <button type="button" id="saveShiftOrganizer" onclick="saveShiftOrganizer()" class="btn btn-success waves-effect w-md waves-light m-b-5"><i class="ti-save m-r-5"></i>שמור</button>
                                            <button type="button" id="cleanShiftOrganizer" onclick="cleanShiftOrganizer()" class="btn btn-danger waves-effect w-md waves-light m-b-5"><span class="glyphicon glyphicon-erase m-r-5"></span>נקה</button>
                                        </div>
                                    </div>
                                    <div class="card-box row">
                                        <div class="col-sm-2">
                                            <h4>סידור עבודה ליום:</h4>
                                        </div>
                                        <div class="col-sm-3">
                                            <form class="form-horizontal" role="form">
                                                <div class="form-group">
                                                    <div id="selectDocumentTypes">
                                                        <select id="dayChoice" class="form-control">
                                                            

                                                        </select>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-sm-4">
                                        </div>
                                        <div class="col-sm-3 text-right">
                                            <button type="button" id="filterDocuments" onclick="selectShiftDate()" class="btn btn-inverse waves-effect w-xs waves-light m-b-5"><span class="glyphicon glyphicon-filter m-r-5"></span>הצג</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row card-box">
                                <div class="col-sm-9">
                                    <div id="driversPlace">

                                    </div>

                                </div>

                                <!--Orders Bank-->
                                <div class="col-sm-3 rightColDivider">
                                    <h4 class="m-t-0 header-title"><b>בנק הזמנות</b></h4>
                                    <div class="custom-dd dd" id="nestable_list_shiftBank">

                                    </div>

                                </div> <!-- end col -->

                            </div> <!-- end row -->

                            <div class="card-box">
                                <div class="row table-responsive">
                                    <table id="datatable-fixed-header" class="table table-striped table-bordered">
                                        <!--<table id="datatable-buttons" class="table table-striped table-bordered">-->
                                        <thead>
                                            <tr>
                                                <th>מספר</th>
                                                <th>לקוח</th>
                                                <th>שירות</th>
                                                <th>מקור</th>
                                                <th>יעד</th>
                                                <th>זמן</th>
                                                <th>רישיון</th>
                                                <th>היתר</th>
                                                <th>מחיר</th>
                                                <th>הערות הזמנה</th>


                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>

</div>
                            </div>
                        </div>

                    </div>
                    <!-- end Row -->

                </div>
                <!-- end container -->

            </div>
            <!-- end content -->

        </div>
        <!-- ============================================================== -->
        <!-- End Page content here -->
        <!-- ============================================================== -->


    </div>
    <!-- END wrapper -->


    <!-- Modal -->
    <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog  modal-lg">

            <!-- Modal content-->
            <div id="sourceDocPopUp" class="modal-content text-center" style="margin: auto">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title text-center">סידור עבודה נוכחי</h4>
                </div>
                <div class="modal-body">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr style="border-bottom:solid 3px grey">
                                <th>נהג</th>
                                <th>משאית</th>
                                <th>מספר</th>
                                <th>לקוח</th>
                                <th>שירות</th>
                                <th>מקור</th>
                                <th>יעד</th>
                                <th>זמן</th>
                                <th>רישיון</th>
                                <th>היתר</th>
                                <th>הערות הזמנה</th>
                            </tr>
                        </thead>
                        <tbody id="currentShiftsBody">

                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-inverse" data-dismiss="modal">חזור</button>
                </div>
            </div>

        </div>
    </div>



    <script>
        var resizefunc = [];
    </script>

    <!-- jQuery  -->
    <script src="assets/js/bootstrap-rtl.min.js"></script>
    <script src="assets/js/detect.js"></script>
    <script src="assets/js/fastclick.js"></script>
    <script src="assets/js/jquery.slimscroll.js"></script>
    <script src="assets/js/jquery.blockUI.js"></script>
    <script src="assets/js/waves.js"></script>
    <script src="assets/js/wow.min.js"></script>
    <script src="assets/js/jquery.nicescroll.js"></script>
    <script src="assets/js/jquery.scrollTo.min.js"></script>
    <script src="../plugins/switchery/switchery.min.js"></script>

    <!-- Datatables-->
    <script src="../plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="../plugins/datatables/dataTables.bootstrap.js"></script>
    <script src="../plugins/datatables/dataTables.buttons.min.js"></script>
    <script src="../plugins/datatables/buttons.bootstrap.min.js"></script>
    <script src="../plugins/datatables/jszip.min.js"></script>
    <script src="../plugins/datatables/pdfmake.min.js"></script>
    <script src="../plugins/datatables/vfs_fonts.js"></script>
    <script src="../plugins/datatables/buttons.html5.min.js"></script>
    <script src="../plugins/datatables/buttons.print.min.js"></script>
    <script src="../plugins/datatables/dataTables.fixedHeader.min.js"></script>
    <script src="../plugins/datatables/dataTables.keyTable.min.js"></script>
    <script src="../plugins/datatables/dataTables.responsive.min.js"></script>
    <script src="../plugins/datatables/responsive.bootstrap.min.js"></script>
    <script src="../plugins/datatables/dataTables.scroller.min.js"></script>

    <!-- Datatable init js -->
    <script src="assets/pages/datatables.init.js"></script>

    <!-- Sweet Alert js -->
    <script src="../plugins/bootstrap-sweetalert/sweet-alert.min.js"></script>
    <script src="assets/pages/jquery.sweet-alert.init.js"></script>

    <!--Nestable list-->
    <script src="../plugins/nestable/jquery.nestable.js"></script>
    <!--  <script src="assets/pages/nestable.js"></script>-->


    <script src="assets/js/jquery.core.js"></script>
    <script src="assets/js/jquery.app.js"></script>

    <script type="text/javascript">

        TableManageButtons.init();

    </script>

</body>
</html>